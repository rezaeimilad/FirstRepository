"use strict";function setText(e,t){var a;for(a=0;a<document.querySelectorAll("[data-text='"+e+"']").length;a++)document.querySelectorAll("[data-text='"+e+"']")[a].textContent=t}function getText(e){var t;for(t in _texts)if(e==t)return _texts[t];return null}function jsonToString(e){return JSON.stringify(e)}function validateEmail(e){var t=e.indexOf("@"),a=e.lastIndexOf(".");return!(t<1||a<t+2||a+2>=e.length)}function excerpt(e,t){return e.length>t&&(e=e.substr(0,e.lastIndexOf(" ",t))+"..."),e}function isUndefined(e){return void 0===e}function getAndroidVersion(e){var t=(e=(e||navigator.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/);return!!t&&t[1]}function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)}function validateURL(e){if(!/^(f|ht)tps?:\/\//i.test(e))return!1;if(-1==e.indexOf("."))return!1;return!(e.split(".").pop().length<2)}function cleanString(e){var t=document.createElement("div");return t.innerHTML=e,t.innerText}function addToLog(e){if(_isDebug){console.log(e);var t=document.getElementById("mainLog");t.innerHTML=e+"<br/>"+t.innerHTML}}function openModal(e,t,a,i,o){e=(e=e.replace(/script/gi,"")).replace(/fromCharCode/gi,"");var s=document.createElement("div");s.id="bgModal",s.innerHTML='<div id="alertModal"><p></p><div class="buttons"></div></div></div>',s.querySelector("p").innerHTML=e;var n="";void 0!=i&&null!=o?(n+='<span class="button yes">'+i+"</span>",n+='<span class="button no">'+o+"</span>"):n+=i?'<span class="button ok">'+i+"</span>":'<span class="button ok">ok</span>',s.querySelector(".buttons").innerHTML=n,document.body.appendChild(s),$("#alertModal .button.ok").on("click",function(){var e=document.getElementById("bgModal");e&&e.parentElement.removeChild(e)}),$("#alertModal .button.yes").on("click",function(){var e=document.getElementById("bgModal");e&&e.parentElement.removeChild(e),void 0!=t&&null!=t&&t.call(this)}),$("#alertModal .button.no").on("click",function(){var e=document.getElementById("bgModal");e&&e.parentElement.removeChild(e),void 0!=a&&null!=a&&a.call(this)})}function getVideoStream(e,t){console.log("get video stream");(_video=document.getElementById("bgVideo")).autoplay=!0,_video.playsinline=!0,_video.muted=!0;var a={audio:!1,video:{facingMode:{exact:"environment"},width:{min:640,ideal:1280,max:1280},height:{min:480,ideal:720,max:720}}};_isDesktop&&(a={audio:!1,video:{width:{min:640,ideal:1280,max:1280},height:{min:480,ideal:720,max:720}}}),function(e,t,a){navigator.mediaDevices?navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(e).then(t).catch(a):(addToLog("missing navigator.mediaDevices.getUserMedia"),alert("missing API"),a()):(addToLog("missing navigator.mediaDevices"),alert("missing API"),a())}(a,function(a){var i=_video;i.style.zIndex=-1,i.srcObject=a,i.play().then(function(){_streamSize={w:i.videoWidth,h:i.videoHeight},e.call(this)}).catch(function(e){console.log("videostream: fail a"),console.log(e),t.call(this)})},function(e){console.log("videostream: fail b"),console.log(e),is.ios(_arguments)?alert("Cannot access your camera, \nmake sure camera access is enabled in Safari settings"):alert("camera access is required for augmented reality")})}function nft(){this.camera=null,this.scene=null,this.renderer=null,this.markerRoot=null,this.rootSmoothing=null,this.object=null,this.previousTransform=[],this.frameCorners=[],this.ismarkerLongLost=!0,this.nbFramesLost=0,this.orientation="landscape",this.streamW=0,this.streamH=0,this.canvas=document.getElementById("threejs"),this.canvasFeat=document.getElementById("feat"),this.ctx3=null,this.canvasSearch=null,this.ctxSearch=null,this.cornersCenter=null,this.corners=[],this.mm_kernel=null,this.ransac_param=null,this.homo3x3=null,this.match_mask=null,this.baseSize={x:0,y:0},this.isAreaZoomed=!1,this.cornersHistory=[],this.searchArea=null,this.isVisibleRightNow=!1,this.isMarkerVisible=!1,this.num_corners=0,this.useLoopFlow=!1,this.videoTex=null,this.isDesktop=!1,this.patternType="fast",this.nbPointsDetected=0,this.nbZoomedPointsDetected=0,this.blurSize=1,this.zoomedBlurSize=1,this.num_matches=0,this.good_matches=0,this.isDetectLoop=!0,this.maxFramesLost=8,this.maxDetectedPoints=1200,this.maxPointsAllowed=300,this.minGoodMatches=10,this.maxCornersHistory=3,this.maxTransformHistory=3,this.maxCornersPerTrainingLevel=150,this.lastTime=performance.now(),this.newFps=1,this.lastFps=1,this.fps=1,this.PERF_HIGH=2,this.PERF_MED=1,this.PERF_LOW=0,this.perf=this.PERF_MED,this.init=function(e){console.log("-> nft init");if(e&&(e.maxFramesLost&&(this.maxFramesLost=e.maxFramesLost),e.maxPointsAllowed&&(this.maxPointsAllowed=e.maxPointsAllowed),e.maxDetectedPoints&&(this.maxDetectedPoints=e.maxDetectedPoints),e.minGoodMatches&&(this.minGoodMatches=e.minGoodMatches),e.maxCornersHistory&&(this.maxCornersHistory=e.maxCornersHistory),e.maxTransformHistory&&(this.maxTransformHistory=e.maxTransformHistory),e.maxCornersPerTrainingLevel&&(this.maxCornersPerTrainingLevel=e.maxCornersPerTrainingLevel)),_isDebug&&(console.log("options"),console.log(e)),this.isDesktop=_isDesktop,this.homo3x3=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),this.match_mask=new jsfeat.matrix_t(this.maxPointsAllowed,1,jsfeat.U8C1_t),this.scene=new THREE.Scene,this.rootSmoothing=new THREE.Group,this.rootSmoothing.name="rootSmoothing",this.rootSmoothing.visible=!1,this.canvasFeat&&(this.ctx3=this.canvasFeat.getContext("2d")),this.canvasSearch=document.createElement("canvas"),this.canvasSearch.width=AREA_SIZE_X,this.canvasSearch.height=AREA_SIZE_Y,this.ctxSearch=this.canvasSearch.getContext("2d"),this.isDesktop&&_isDebug){document.getElementsByTagName("body")[0].appendChild(this.canvasSearch),this.canvasSearch.id="canvasSearch"}"fast"==this.patternType&&(_setFastThreshold(20),_set_maxDetectedPoints(this.maxDetectedPoints)),this.mm_kernel=new jsfeat.motion_model.homography2d;var t=this.minGoodMatches;this.ransac_param=new jsfeat.ransac_params_t(t,5,.5,.99)},this.init3=function(e){console.log("-> nft init3 "+_streamSize.w);var t=this,a=_streamSize.w,i=_streamSize.h;a<i&&(a=_streamSize.h,i=_streamSize.w),t.setSearchArea(null);t.camera=new THREE.PerspectiveCamera(35,a/i,1,200),t.camera.name="nft camera",t.scene.add(t.camera);setInterval(function(){t.streamResized(t,!1)},1e3);t.streamResized(t,!0);t.renderer=new THREE.WebGLRenderer({antialias:!0,canvas:t.canvas,preserveDrawingBuffer:!0}),t.isDesktop||t.renderer.setPixelRatio(2),t.isDesktop||addToLog("pixel ratio 2"),t.renderer.setSize(a,i);var o=new THREE.MeshBasicMaterial({color:"#ffff00",transparent:!0,opacity:.6}),s=new THREE.PlaneGeometry(10,10,1,1);t.markerRoot=new THREE.Mesh(s,o),t.scene.add(t.markerRoot),t.markerRoot.visible=!1,_useImage?t.videoTex=_imageIsVideo?new THREE.VideoTexture(_video):(new THREE.TextureLoader).load(_imageTest):(console.log("set background video"),t.videoTex=new THREE.VideoTexture(_video)),t.videoTex.offset.set(0,0),t.videoTex.center.set(.5,.5),t.scene.background=t.videoTex,t.scene.add(t.rootSmoothing),e?t.rootSmoothing.add(t.object):_xr.init3Done()},this.loadTraining=function(e,t){_training={},addToLog("NFT load pattern");var a=_training,i=new XMLHttpRequest;i.open("GET",e,!0),i.onload=function(){if(i.status>=200&&i.status<400){var e=JSON.parse(i.responseText);if(e.error)return void alert("error : "+e.error);a.max_per_level=e.maxPerLevel,a.num_train_levels=e.levels,addToLog("max per level "+a.max_per_level+" ("+a.maxCornersPerTrainingLevel+")"),addToLog("cornersType "+e.cornersType);var o=a.maxCornersPerTrainingLevel;a.max_per_level>o&&(a.max_per_level=o),a.patternType=e.cornersType,a.pattern_descriptors=[];var s,n;for(s=0;s<e.d.length;s++)for(a.pattern_descriptors[s]={buffer:{}},a.pattern_descriptors[s].rows=a.max_per_level,a.pattern_descriptors[s].buffer.i32=new Int32Array(8*a.max_per_level),n=0;n<8*a.max_per_level;n++)a.pattern_descriptors[s].buffer.i32[n]=e.d[s][n];for(a.pattern_corners=e.c,s=0;s<e.c.length;s++)e.c[s]=e.c[s].slice(0,a.max_per_level);_isDebug&&(console.log(a.pattern_descriptors),console.log(e.c)),a.pattern_preview=e.preview,t.call(this)}else console.log("error a")},i.onerror=function(){console.log("error b")},i.send()},this.allModelsReady=function(){console.log("--> allModelsReady");this.object=_models.creature[0].object;this.object.position.set(0,-5,0),this.object.scale.set(6,6,6),this.init(),this.init3(!0);var e=_flow;e&&(e.useNFTSearchArea(this),e.startLoop(),this.nbFramesLost=100),startLoop()},this.getImageData=function(){var e=this.ctxSearch,t=AREA_SIZE_X,a=AREA_SIZE_Y,i=this.searchArea.x,o=this.searchArea.y;if(_streamSize.w<_streamSize.h&&(t=AREA_SIZE_Y,a=AREA_SIZE_X),this.isAreaZoomed){var s=(720-AREA_SIZE_Y)/2;"portrait"!=this.orientation?(i-=s,o=0):(o-=s,i=0);var n=AREA_SIZE_X,r=AREA_SIZE_Y;e.drawImage(_video,i,o,720,720,0,0,n,r)}else e.drawImage(_video,i,o,t,a,0,0,t,a);_dataColorHeap.set(new Uint8Array(e.getImageData(0,0,t,a).data.buffer)),this.ctx3&&this.ctx3.clearRect(0,0,this.canvasFeat.width,this.canvasFeat.height)},this.checkZoom=function(){if(!_flow||!_flow.isFlowValid){var e=this.corners,t=this.getDistance(e[0],e[2]),a=this.getDistance(e[1],e[3]);a>t&&(t=a),this.isAreaZoomed=t>800}},this.updateSearchCenter=function(){var e,t;if(this.isAreaZoomed)e=_streamSize.w/2,t=_streamSize.h/2;else{e=2*parseInt(this.cornersCenter.x/2),t=2*parseInt(this.cornersCenter.y/2)}this.setSearchArea({x:e,y:t})},this.setSmoothPosition=function(){if(_flow)return this.rootSmoothing.parent,this.markerRoot,this.markerRoot.attach(this.rootSmoothing),this.rootSmoothing.position.set(0,0,0),this.rootSmoothing.rotation.set(0,0,0),this.rootSmoothing.scale.set(1,1,1),void(this.maxCornersHistory=3);var e=this.markerRoot,t=this.rootSmoothing,a=new THREE.Vector3,i=new THREE.Quaternion,o=new THREE.Vector3;e.getWorldPosition(a),e.getWorldScale(o),e.getWorldQuaternion(i);var s=(new THREE.Euler).setFromQuaternion(i);for(this.previousTransform.unshift({translation:a,rotation:s,scale:o});this.previousTransform.length>this.maxTransformHistory;)this.previousTransform.pop();var n,r;if(this.previousTransform.length==this.maxTransformHistory){n={x:0,y:0,z:0},r={x:0,y:0,z:0};var l,c,d=this.previousTransform.length;for(l=0;l<d;l++)c=this.previousTransform[l],n.x+=c.translation.x,n.y+=c.translation.y,n.z+=c.translation.z,r.x+=c.scale.x,r.y+=c.scale.y,r.z+=c.scale.z;if(n.x/=d,n.y/=d,n.z/=d,r.x/=d,r.y/=d,r.z/=d,d>1){var h,u;if(d>=4){l=0,h=new THREE.Vector3(this.previousTransform[l].rotation.x,this.previousTransform[l].rotation.y,this.previousTransform[l].rotation.z),l=1,u=new THREE.Vector3(this.previousTransform[l].rotation.x,this.previousTransform[l].rotation.y,this.previousTransform[l].rotation.z);var f=h.lerp(u,.5);l=2,h=new THREE.Vector3(this.previousTransform[l].rotation.x,this.previousTransform[l].rotation.y,this.previousTransform[l].rotation.z),l=3,u=new THREE.Vector3(this.previousTransform[l].rotation.x,this.previousTransform[l].rotation.y,this.previousTransform[l].rotation.z);var m=h.lerp(u,.5);s=f.lerp(m,.5)}d<4&&(l=0,h=new THREE.Vector3(this.previousTransform[l].rotation.x,this.previousTransform[l].rotation.y,this.previousTransform[l].rotation.z),l=1,u=new THREE.Vector3(this.previousTransform[l].rotation.x,this.previousTransform[l].rotation.y,this.previousTransform[l].rotation.z),s=h.lerp(u,.5))}else s=new THREE.Vector3(this.previousTransform[0].rotation.x,this.previousTransform[0].rotation.y,this.previousTransform[0].rotation.z)}else n=a,r=o;t.position.set(n.x,n.y,n.z),t.rotation.set(s.x,s.y,s.z);var p=r.x;t.scale.set(p,p,p)},this.streamResized=function(e,t){if(_useImage&&(void 0==_video.videoWidth&&(_video.videoWidth=_video.width),void 0==_video.videoHeight&&(_video.videoHeight=_video.height)),t||e.streamW!=_video.videoWidth){var a=_video.videoWidth,i=_video.videoHeight;if(e.streamW=a,e.streamH=i,_video.width=a,_video.height=i,_streamSize={w:a,h:i},e.baseSize.x=a,e.baseSize.y=i,addToLog(">> str Resized "+a+" x "+i),e.canvasFeat&&(e.canvasFeat.width=a,e.canvasFeat.height=i),e.canvasSearch){var o=AREA_SIZE_X,s=AREA_SIZE_Y;a<i&&(o=AREA_SIZE_Y,s=AREA_SIZE_X),e.canvasSearch.width=o,e.canvasSearch.height=s}e.resizeCanvas()}},this.setPerf=function(e){if(e!=this.perf){this.perf=e;var t=this.maxDetectedPoints;this.perf==this.PERF_HIGH&&(t=1500),this.perf==this.PERF_MED&&(t=1200),this.perf==this.PERF_LOW&&(t=1e3),this.maxDetectedPoints=t;var a=this.maxPointsAllowed;this.perf==this.PERF_HIGH&&(a=350),this.perf==this.PERF_MED&&(a=300),this.perf==this.PERF_LOW&&(a=200),this.maxPointsAllowed=a,addToLog("set perf "+e+" "+t+" "+a),this.match_mask=new jsfeat.matrix_t(this.maxPointsAllowed,1,jsfeat.U8C1_t),_set_maxDetectedPoints(this.maxDetectedPoints)}},this.resizeCanvas=function(){_video&&(_useImage||_video.play(),_useImage&&_imageIsVideo&&_video.play());var e=window.innerWidth,t=window.innerHeight,a=_streamSize.w,i=_streamSize.h;this.orientation="landscape",this.streamW<this.streamH&&(this.orientation="portrait");var o=this.orientation;"portrait"===o?_body.classList.add("p"):_body.classList.remove("p"),"portrait"===o?this.scene.background&&(this.scene.background.rotation=-1*Math.PI/2):this.scene.background&&(this.scene.background.rotation=0);var s,n=document.getElementById("overThreejs"),r=this.canvas,l=this.canvasFeat;if(this.isDesktop){if("landscape"==o){c=t/i,d=parseInt(a*c),h=parseInt(i*c);s="scale("+c+")"}else s="rotate(-90deg) translate(-100%, 0)";n.style.width=d+"px",n.style.height=h+"px",r.style.transform=s,l&&(l.style.transform=s),r.style.left=0}else{var c=e/a,d=parseInt(a*c),h=parseInt(i*c);s="scale("+c+")",l&&(l.style.transform=s),n.style.width=d+"px",n.style.height=h+"px","portrait"==o&&(s="scale("+c+") rotate(-90deg) translate(-100%, 0)"),"landscape"==o&&(s="scale("+c+")"),r.style.transform=s}},this.loopFull=function(e){this.loopDetect(e),this.loopMatch(e),_isDebug&&(this.good_matches>this.minGoodMatches&&this.drawFrame(this.ctx3),this.loopFlow()),this.loopRender(e)},this.loopFlow=function(){var e=_flow;e&&(this.nbFramesLost<1||(e.loop(),e.draw(),e.isFlowValid&&(this.markerRoot.visible=!0,this.rootSmoothing.visible=!0)))},this.loop=function(e){_stats&&_stats.begin();var t=performance.now();this.isDetectLoop?this.loopDetect(e):this.loopMatch(e),_isDebug&&this.good_matches>this.minGoodMatches&&this.drawFrame(this.ctx3),this.loopRender(e),this.isDetectLoop=!this.isDetectLoop,this.newFps=parseInt(1e3/(t-this.lastTime)),this.fps=parseInt((this.lastFps+this.newFps)/2),this.lastFps=this.newFps,this.lastTime=t;var a=this.perf;this.perf==this.PERF_HIGH&&this.fps<20&&(a=this.PERF_MED),this.perf==this.PERF_MED&&this.fps>30&&(a=this.PERF_HIGH),this.perf==this.PERF_MED&&this.fps<20&&(a=this.PERF_LOW),this.perf==this.PERF_LOW&&this.fps>30&&(a=this.PERF_MED),this.setPerf(a),_stats&&_stats.end()},this.loopSceneToggle=function(e){var t=performance.now();this.isDetectLoop?this.loopDetect(e):this.loopMatch(e),this.isDetectLoop=!this.isDetectLoop,_isDebug&&this.loopFlow(),this.newFps=parseInt(1e3/(t-this.lastTime)),this.fps=parseInt((this.lastFps+this.newFps)/2),this.lastFps=this.newFps,this.lastTime=t;var a=this.perf;this.perf==this.PERF_HIGH&&this.fps<20&&(a=this.PERF_MED),this.perf==this.PERF_MED&&this.fps>30&&(a=this.PERF_HIGH),this.perf==this.PERF_MED&&this.fps<20&&(a=this.PERF_LOW),this.perf==this.PERF_LOW&&this.fps>30&&(a=this.PERF_MED),this.setPerf(a)},this.loopSceneFull=function(e){this.loopDetect(e),this.loopMatch(e)},this.loopDetect=function(e){this.getImageData(),e&&e.start("grayscale");var t=1;if(this.isAreaZoomed?(this.zoomedBlurSize=1,this.nbZoomedPointsDetected>=2e3&&(this.zoomedBlurSize=2),this.nbZoomedPointsDetected<=150&&(this.zoomedBlurSize=0),t=this.zoomedBlurSize):(this.blurSize=1,this.nbPointsDetected>=2e3&&(this.blurSize=2),this.nbPointsDetected<=150&&(this.blurSize=0),t=this.blurSize),_grayscale32AndBlur(_dataColorHeap.byteOffset,t,_blurType),e&&e.stop("grayscale"),this.isDesktop){blitOnCanvas(getImgU8(),AREA_SIZE_X,AREA_SIZE_Y,!1)}e&&e.start("detect"),"fast"!=this.patternType?this.num_corners=_detectYape06(this.maxPointsAllowed):this.num_corners=_detectFast(this.maxPointsAllowed),this.isAreaZoomed?this.nbZoomedPointsDetected=_get_corners_cnt():this.nbPointsDetected=_get_corners_cnt(),e&&e.stop("detect"),e&&e.start("describe"),_describe(),e&&e.stop("describe"),this.isDesktop&&_showPoints&&this.ctx3&&this.drawPoints(this.num_corners),!this.isDesktop&&this.ctx3&&(is.ipad(_arguments)&&_showPoints&&this.drawPoints(this.num_corners),is.mobile(_arguments)&&_showPoints&&this.drawPoints(this.num_corners))},this.loopMatch=function(e){var t=_flow;if(e&&e.start("matching"),this.num_matches=_match_patternWasm(_training.num_train_levels),e&&e.stop("matching"),e&&e.start("transform"),this.good_matches=0,this.num_matches>this.minGoodMatches&&(this.good_matches=this.find_transform(this.num_matches)),e&&e.stop("transform"),this.good_matches>this.minGoodMatches?(this.nbFramesLost>4&&(this.cornersHistory=[],this.previousTransform=[]),this.isVisibleRightNow=!0,this.isMarkerVisible=!0,this.nbFramesLost=0,this.setCorners(),this.ismarkerLongLost=!1,this.rootSmoothing.visible=!0,t&&this.rootSmoothing.parent==t.flowRoot&&(console.log("move back to scene root"),this.scene.attach(this.rootSmoothing))):(this.isVisibleRightNow=!1,this.nbFramesLost<100&&this.nbFramesLost++,this.nbFramesLost>this.maxFramesLost&&(this.rootSmoothing.visible=!1,this.ismarkerLongLost=!0,this.isMarkerVisible=!1)),this.isDesktop&&_isDebug&&(this.markerRoot.visible=this.isVisibleRightNow),this.isVisibleRightNow&&t&&t.clearAllPoints(),2==this.nbFramesLost&&t&&0==t.point_count){var a=this.frameCorners[1].x-this.frameCorners[0].x+(this.frameCorners[2].x-this.frameCorners[3].x)/2,i=this.frameCorners[2].y-this.frameCorners[0].y+(this.frameCorners[3].y-this.frameCorners[1].y)/2,o={x:this.cornersCenter.x,y:this.cornersCenter.y};t.setPoints(o,a,i),t.setPointsAreaSize(a,i),console.log(parseInt(this.markerRoot.position.z)+" "+parseInt(t.flowRoot.position.z)),console.log(a+"  x "+i),console.log("attach tp flow root"),t.flowRoot.attach(this.rootSmoothing)}if(this.ismarkerLongLost){var s=!1;if(t&&t.isFlowValid&&(s=!0),s||(this.isAreaZoomed=!this.isAreaZoomed),this.previousTransform.length&&(this.previousTransform=[]),!s){var n={x:_streamSize.w/2,y:_streamSize.h/2};this.setSearchArea(n)}}this.isMarkerVisible&&this.updateSearchCenter()},this.loopRender=function(e){e&&e.start("render"),this.renderer.render(this.scene,this.camera),e&&e.stop("render"),_showSearchArea&&this.ctx3&&drawSearchArea()},this.find_transform=function(e){for(var t=[],a=[],i=this.homo3x3,o=0;o<e;++o){var s=_training.pattern_corners[_getMatch_pattern_lev(o)][_getMatch_pattern_idx(o)];s?(t.push({x:s.x,y:s.y}),a.push({x:_get_s_kp(o,0),y:_get_s_kp(o,1)})):console.log("undef "+o+" "+e)}e=t.length;var n=0;if(jsfeat.motion_estimator.ransac(this.ransac_param,this.mm_kernel,t,a,e,i,this.match_mask,1e3)){for(o=0;o<e;++o)this.match_mask.data[o]&&(t[n].x=t[o].x,t[n].y=t[o].y,a[n].x=a[o].x,a[n].y=a[o].y,n++);this.mm_kernel.run(t,a,i,n)}else jsfeat.matmath.identity_3x3(i,1);return n},this.tCorners=function(e,t,a){for(var i=[{x:0,y:0},{x:t,y:0},{x:t,y:a},{x:0,y:a}],o=0,s=0,n=0,r=0;s<4;++s)n=e[0]*i[s].x+e[1]*i[s].y+e[2],r=e[3]*i[s].x+e[4]*i[s].y+e[5],o=e[6]*i[s].x+e[7]*i[s].y+e[8],i[s].x=n/o,i[s].y=r/o;return i},this.calculateCornersFromMarker=function(){var e,t=2*_training.pattern_preview.cols,a=2*_training.pattern_preview.rows,i=this.tCorners(this.homo3x3.data,t,a);if(this.isAreaZoomed)for(e=0;e<i.length;e++)i[e].x=(i[e].x-AREA_SIZE/2)*(720/AREA_SIZE)+AREA_SIZE/2,i[e].y=(i[e].y-AREA_SIZE/2)*(720/AREA_SIZE)+AREA_SIZE/2;for(e=0;e<i.length;e++)i[e].x+=this.searchArea.x,i[e].y+=this.searchArea.y;return i},this.setSearchArea=function(e){var t,a,i=AREA_SIZE;if(e){(t=e.x-i/2)<50&&(t=50),t+i>_streamSize.w-50&&(t=_streamSize.w-50-i),(a=e.y-i/2)<50&&(a=50),a+i>_streamSize.h-50&&(a=_streamSize.h-50-i)}else t=(_streamSize.w-i)/2,a=(_streamSize.h-i)/2;this.searchArea={x:t,y:a,w:i,h:i,xc:t+i/2,yc:a+i/2},_setSearchArea(this.searchArea.x,this.searchArea.y,this.searchArea.w,this.searchArea.h)},this.setCorners=function(){var e=this.calculateCornersFromMarker();for(this.cornersHistory.unshift(e);this.cornersHistory.length>this.maxCornersHistory;)this.cornersHistory.pop();var t,a,i=e.length,o=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],s=this.cornersHistory.length;for(t=0;t<s;t++)for(a=this.cornersHistory[t],r=0;r<i;r++)o[r].x+=a[r].x,o[r].y+=a[r].y;for(r=0;r<i;r++)o[r].x/=s,o[r].y/=s;var n=o;if(_isDebug)for(this.frameCorners=[],r=0;r<4;r++)this.frameCorners.push({x:n[r].x,y:n[r].y});var r,l=0,c=0,d=!1;if(_streamSize.w<_streamSize.h&&(d=!0),d)for(r=0;r<n.length;r++){var h=n[r].x,u=n[r].y;n[r].x=1280-u,n[r].y=h}this.corners=[];var f=[];for(r=0;r<4;r++)l+=n[r].x,c+=n[r].y,this.corners.push({x:n[r].x,y:n[r].y}),f.push({x:n[r].x-640,y:360-n[r].y});if(l=parseInt(l/4),c=parseInt(c/4),d){h=l;l=u=c,c=1280-h}this.cornersCenter={x:l,y:c};var m=10,p=new POS.Posit(m,1200).pose(f);if(null===p&&console.log("pose NULL"),null!==p){var v=p.bestRotation,g=p.bestTranslation,b=this.markerRoot;m=1,b.scale.set(m,m,m),b.rotation.set(-Math.asin(-v[1][2]),-Math.atan2(v[0][2],v[2][2]),Math.atan2(v[1][0],v[1][1])),b.position.set(g[0],g[1],-g[2]),this.setSmoothPosition(),this.checkZoom()}},this.getDistance=function(e,t){var a=e.x-t.x,i=e.y-t.y;return Math.sqrt(a*a+i*i)},this.drawFrame=function(e){if(e){var t=this.frameCorners;t[0]&&(e.strokeStyle="rgb(0,255,0)",e.beginPath(),e.moveTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y),e.lineTo(t[2].x,t[2].y),e.lineTo(t[3].x,t[3].y),e.lineTo(t[0].x,t[0].y),e.lineWidth=4,e.stroke())}},this.drawPoints=function(e){var t=document.getElementById("feat");if(t){var a=t.getContext("2d");a.save(),a.translate(this.searchArea.x,this.searchArea.y),a.fillStyle="rgb(0,255,0)";var i,o;for(o=0;o<e;++o)(i={x:_get_pointXY(o,0),y:_get_pointXY(o,1)}).x-=AREA_SIZE/2,i.y-=AREA_SIZE/2,this.isAreaZoomed&&(i.x*=720/this.searchArea.w,i.y*=720/this.searchArea.w),i.x+=AREA_SIZE/2,i.y+=AREA_SIZE/2,a.fillRect(i.x-2,i.y-2,4,4);a.restore()}},this.drawCenter=function(e){var t=_ctxFeat;t.strokeStyle="rgb(500,0,0)",t.lineWidth=4,t.beginPath();t.moveTo(e.x-50,e.y-50),t.lineTo(e.x+50,e.y+50),t.stroke(),t.moveTo(e.x-50,e.y+50),t.lineTo(e.x+50,e.y-50),t.stroke()}}function blitOnCanvas(e,t,a,i){void 0==i&&(i=!0);var o=document.getElementById("markerCanvas").getContext("2d");t||(t=AREA_SIZE_X),a||(a=AREA_SIZE_Y);var s,n=o.createImageData(t,a),r=0,l=0;if(i)for(s=0;s<t*a;s++)n.data[r]=e[l],n.data[r+1]=e[l+1],n.data[r+2]=e[l+2],n.data[r+3]=255,l+=4,r+=4;if(!i)for(s=0;s<t*a;s++)n.data[r]=e[l],n.data[r+1]=e[l],n.data[r+2]=e[l],n.data[r+3]=255,l+=1,r+=4;o.putImageData(n,0,0)}function xr_createImageDataBuffer(){var e=1*AREA_SIZE_LENGHT,t=Module._malloc(e);_dataGrayHeap=new Uint8Array(Module.HEAPU8.buffer,t,e);_setDataGrayHeap(_dataGrayHeap.byteOffset);var a=4*AREA_SIZE_LENGHT,i=Module._malloc(a);_dataColorHeap=new Uint8Array(Module.HEAPU8.buffer,i,a)}function do_grayscale(e,t){_xr_grayscale(_dataColorHeap.byteOffset,t)}function do_blur(e,t){_xr_blur(e,t)}function getImgU8(){var e=1*AREA_SIZE_LENGHT;return new Uint8Array(_dataGrayHeap.buffer,_dataGrayHeap.byteOffset,e)}function save_pattern_descriptors(){var e,t=_training.num_train_levels,a=_training.pattern_descriptors;for(e=0;e<t;e++){var i=a[e].buffer.i32,o=i.length*i.BYTES_PER_ELEMENT,s=Module._malloc(o),n=new Uint32Array(Module.HEAP32.buffer,s,o);n.set(new Uint32Array(i.buffer)),_save_pattern_descriptors(n.byteOffset,e,i.length),Module._free(n.byteOffset)}var r=0,l=0,c=0,d=0;a[0]&&(r=a[0].rows),a[1]&&(l=a[1].rows),a[2]&&(c=a[2].rows),a[3]&&(d=a[3].rows),_setLd_cnt(r,l,c,d)}function ar(e){this.scenesJson=e.scenesData,this.nbScenes=this.scenesJson.length,this.currentMode="ar",this.isDebug=!1,this.renderer=null,this.clock=null,this.arController=null,this.p_markerRoot=null,this.timerHelp=null,this.firstTimeFound=!0,this.soundVolume=1,this.indexSceneActive=0,this.indexSceneLoading=0,this.needPlayButton=!1,this.prevCurrentMarkerVisible=!1,this.scenes=[],this.nbScenes=e.scenesData.length,this.indexSceneActive=0,this.indexSceneLoading=0,this.loadingScene=null,this.activeScene=null,this.scene3=null,this.useSmoothing=!0,this.previousTransform=[],this.maxTransformHistory=5,this.isBundle=!1,this.tracking=null,this.bundle=null,this.usingSceneSelector=!1,this.multipleTracking=!1,e.settings&&(e.settings.multiScene&&(this.isBundle=1,this.tracking={type:"single"},e.settings.multiScene.multiMarkers&&1==e.settings.multiScene.multiMarkers&&(this.multipleTracking=!0,this.tracking.type="multiple")),e.settings.bundle&&(this.isBundle=e.settings.isBundle,this.bundle=e.settings.bundle,this.tracking=e.settings.tracking,"multiple"==this.tracking.type&&(this.multipleTracking=!0))),this.setNewData=function(e){addToLog("setNewdata NFT "+e);!this.multipleTracking&&this.nbScenes>1&&(addToLog("-> using scene selector"),this.usingSceneSelector=!0),this.multipleTracking&&addToLog("-> using multiple tracking"),this.indexSceneLoading=e;var t=this.scenesJson[e];this.scenes[e]=new scene(t,e,this.currentMode),0==e&&(this.activeScene=this.scenes[0]),this.loadingScene=this.scenes[e]},this.allSceneDataLoaded=function(){var e=this.loadingScene;addToLog(">> sceneDataLoaded "+this.indexSceneLoading+" / "+this.nbScenes+" "+e.needPlayButton),e.needPlayButton&&(this.needPlayButton=!0),0==this.indexSceneLoading&&this.needPlayButton&&(this.needPlayButton=!1,this.openPlayPanel()),this.indexSceneLoading!=this.indexSceneActive&&1!=this.multipleTracking||this.selectScene(this.indexSceneLoading),0==this.indexSceneLoading&&($("#sceneLoader").css("display:none;"),this.onARReady()),this.loadNextScene()},this.loadNextScene=function(){this.indexSceneLoading+1<this.nbScenes&&(this.indexSceneLoading++,this.setNewData(this.indexSceneLoading),this.loadingScene.load())},this.openPlayPanel=function(){var e=this;$("#playPanel").css("display:block;"),$("body").addClass("playPanel"),$("#playPanel").on("click",function(){e.closePlayPanel()})},this.closePlayPanel=function(){$("#playPanel").css("display:none;"),$("body").removeClass("playPanel");this.activeScene.closePlayPanel(),is.ios(_arguments)&&_video&&(addToLog("ios _video play"),_video.play()),this.startLoop()},this.selectScene=function(e){var t;if(addToLog("- - - selectScene "+e),this.moveToMarker(),this.indexSceneActive=e,this.activeScene=this.scenes[this.indexSceneActive],this.activeScene.resumeAudioContext(),this.pauseAllVideoTextures(!0),this.usingSceneSelector)for(t=0;t<this.scenes.length;t++)this.scenes[t].rootOrientation.visible=!1;var a=!1;if(this.multipleTracking){for(t=0;t<this.scenes.length;t++)if(this.scenes[t].markerRoot&&this.scenes[t].markerRoot.visible){a=!0;break}}else this.p_markerRoot&&this.p_markerRoot.visible&&(a=!0);var i,o=this.activeScene,s=this.activeScene.data,n=this.activeScene.data.settings;if(this.multipleTracking){var r,l=document.querySelector(".pattern ul.patternPreviews");h=document.querySelector("#help ul.patternPreviews");for(l.classList.add("x"+this.scenes.length),l.innerHTML="",h.innerHTML="",t=0;t<this.scenes.length;t++)r=document.createElement("li"),i=this.scenes[t].hint,r.innerHTML='<img src="'+i+'" alt=""/>',l.appendChild(r),(d=document.createElement("li")).setAttribute("data-img",i),d.innerHTML='<img src="'+i+'" alt=""/>',h.appendChild(d),d.addEventListener(_clickOrTouch,function(){var e=this.getAttribute("data-img");document.querySelector("#patternLarge .patternPreview").src=e,$("#patternLarge").css("display:block")})}else{s.pattern;i=o.hint;var c;for(c=0;c<document.querySelectorAll(".patternPreview").length;c++)document.querySelectorAll(".patternPreview")[c].src=i;var d;(d=document.createElement("li")).setAttribute("data-img",i),d.setAttribute("data-index",this.indexSceneActive),d.innerHTML='<img src="'+i+'" alt=""/>';var h;(h=document.querySelector("#help ul.patternPreviews")).innerHTML="",h&&(h.appendChild(d),d.addEventListener(_clickOrTouch,function(){$("#patternLarge").css("display:block")}))}if(this.p_markerRoot=o.markerRoot,null==this.p_markerRoot)for(t=0;t<this.scenes.length;t++)if(this.scenes[t].data.pattern.id==s.pattern.id){this.p_markerRoot=this.scenes[t].markerRoot;break}for(null==this.p_markerRoot&&addToLog("--> marker root is NULL <--");this.p_markerRoot.children.length>0;)this.p_markerRoot.remove(this.p_markerRoot.children[0]);this.scene3.add(this.p_markerRoot),this.maxTransformHistory=n.smoothing,this.useSmoothing&&addToLog("useSmoothing "+this.useSmoothing+" "+this.maxTransformHistory),_nft.camera.add(o.rootNoMarker),o.rootNoMarker.position.set(0,0,-4),o.rootSmoothing.add(o.rootOrientation),_nft.rootSmoothing.add(this.activeScene.rootSmoothing),o.rootOrientation.position.set(0,0,-4);var u=$("#orientation ul");0==n.orientationSelector?u.css("display:none"):u.css("display:block"),o.setupMainScreen(),o.setActive(a),this.setOrientation(n.vertical)},this.onARReady=function(){addToLog("-> onARReady");this.startLoop()},this.initScene3=function(){addToLog("-> initScene3");var e=this.loadingScene,t=document.getElementById("preloader");t&&t.parentElement.removeChild(t),e.load()},this.updateLoader=function(e){$("#fill").css("width:"+e+"%")},this.setHelpVisibility=function(e){this.timerHelp&&(clearTimeout(this.timerHelp),this.timerHelp=null),e?_body.classList.contains("m")&&(_body.classList.remove("m"),this.pauseAllVideoTextures()):_body.classList.contains("m")||(this.firstTimeFound=!1,_body.classList.add("m"))},this.startLoop=function(){var e=this;if(addToLog("-> start loop -<"),null==e.clock){addToLog("-> resize -<"),_nft.streamResized(_nft,!0),e.clock=new THREE.Clock,"undefined"!=typeof customTools&&customTools(e);var t=function(){stats&&stats.begin();var a=e.clock.getDelta(),i=!1;_nft.loopSceneToggle(null),e.multipleTracking||(i=_nft.isMarkerVisible),!i&&e.prevCurrentMarkerVisible&&e.activeScene.settings.keepVisible&&e.moveToCenter(),i&&!e.prevCurrentMarkerVisible&&(e.activeScene.settings.keepVisible&&e.moveToMarker(),e.activeScene.foundMarker()),i?e.setHelpVisibility(!1):null==e.timerHelp&&(e.timerHelp=setTimeout(function(){e.firstTimeFound=!0,e.setHelpVisibility(!0)},1e3)),e.prevCurrentMarkerVisible=i,e.activeScene.loop(a),_nft.loopRender(null),TWEEN.update(),stats&&stats.end(),requestAnimationFrame(t)};t()}else addToLog("skipped start loop")},this.moveToCenter=function(){$("body").addClass("keep");var e=this.activeScene,t=this.scene3,a=e.rootOrientation,i=e.rootNoMarker,o=e.settings;e.markerNeverFound?$("body").removeClass("found"):$("body").addClass("found"),e.playSceneVideos(),a.parent.updateMatrixWorld(),THREE.SceneUtils.detach(a,a.parent,t),i.updateMatrixWorld(),THREE.SceneUtils.attach(a,t,i);var s=o.keepVisibleScale,n={x:0,y:0,z:0},r=new THREE.Group,l=_body.classList.contains("p");if(l&&r.rotateZ(THREE.Math.degToRad(-90)),void 0!=o.keepVisibleAngle&&(r.rotateX(THREE.Math.degToRad(-1*o.keepVisibleAngle)),l?(90==o.keepVisibleAngle&&(n.x=-.5*s),270==o.keepVisibleAngle&&(n.x=.5*s)):(90==o.keepVisibleAngle&&(n.y=-.5*s),270==o.keepVisibleAngle&&(n.y=.5*s))),e.isMediaScene){var c=e.data.transform[this.currentMode];l?(n.x+=c.position.y/10,n.y+=c.position.x/10,n.z-=c.position.z/10):(n.x-=c.position.x/10,n.y-=c.position.y/10,n.z-=c.position.z/10)}var d=new THREE.Vector3(n.x,n.y,n.z),h=new THREE.Vector3(r.rotation.x,r.rotation.y,r.rotation.z),u=new THREE.Vector3(s,s,s);new TWEEN.Tween(a.position).to(d,200).start(),new TWEEN.Tween(a.rotation).to(h,200).start(),new TWEEN.Tween(a.scale).to(u,200).start();r=null},this.moveToMarker=function(){$("body").removeClass("keep"),$("body").removeClass("found");var e=this.scene3,t=this.activeScene.rootOrientation,a=t.parent,i=this.activeScene.rootSmoothing;a&&a!=i&&(a.updateMatrixWorld(),THREE.SceneUtils.detach(t,a,e),i.updateMatrixWorld(),THREE.SceneUtils.attach(t,e,i),this.setOrientation(_isVertical))},this.setOrientation=function(e){_isVertical=e,_isVertical?($("#h").removeClass("active"),$("#v").addClass("active")):($("#h").addClass("active"),$("#v").removeClass("active"));var t=this.scenes[this.indexSceneActive];if(void 0!=t){var a=t.data,i=new THREE.Vector3(0,0,0),o=new THREE.Vector3(0,0,0),s=new THREE.Vector3(10,10,10),n=a.settings.verticalOffset;if(void 0==n&&(n=0),n*=10,_isVertical&&(i=new THREE.Vector3(0,n/10-5,5),o=new THREE.Vector3(THREE.Math.degToRad(-90),0,0),1==a.settings.invertVertical&&(o=new THREE.Vector3(THREE.Math.degToRad(90),0,0)),t.isMediaScene)){i.y+=.5,i.z=.5}var r,l;for(r=0;r<this.scenes.length;r++)if(this.scenes[r].rootOrientation){l=this.scenes[r].rootOrientation;new TWEEN.Tween(l.position).to(i,200).start(),new TWEEN.Tween(l.rotation).to(o,200).start(),new TWEEN.Tween(l.scale).to(s,200).start()}}},this.pauseAllVideoTextures=function(e){var t=document.querySelectorAll(".videoTexture");if(t&&t.length){var a,i=document.querySelector('.videoTexture[data-scene="'+this.indexSceneActive+'"]');for(a=0;a<t.length;a++)!e&&this.activeScene.settings.keepVisible&&t[a]==i||(t[a].pause(),addToLog("VIDEO DOM "+a+" PAUSE"))}},this.preparePattern=function(){var e=this;xr_createImageDataBuffer();var t=document.createElement("canvas");t.id="markerCanvas",t.width=640,t.height=640,_body.appendChild(t);var a=e.loadingScene.data.pattern;_nft=new nft;var i=_rootDirectory+"p/"+a.folder+"/"+a.id+"/"+a.id+".pat";_nft.init({maxDetectedPoints:1200,maxPointsAllowed:300,maxCornersPerTrainingLevel:150}),_nft.loadTraining(i,function(){e.onTrainingCompleted()})},this.onTrainingCompleted=function(){save_pattern_descriptors();getVideoStream(this.init3NFT,function(){alert("failed to get video stream")})},this.init3NFT=function(){_nft.init3(!1)},this.init3Done=function(){console.log("--> init3Done");_nft.object=this.loadingScene.rootOrientation,this.scene3=_nft.scene,this.addWindowEvents(),$("#sceneLoader").css("display:none;"),this.loadingScene.markerRoot=_nft.markerRoot,this.loadingScene.onReady()},this.addWindowEvents=function(){var e=this;window.addEventListener("blur",function(){e.activeScene.stopAudio(),e.pauseAllVideoTextures(!0)},!1),window.addEventListener("focus",function(){var t=!1;if(e.multipleTracking){var a;for(a=0;a<e.scenes.length;a++)if(e.scenes[a].markerRoot&&e.scenes[a].markerRoot.visible){t=!0;break}}else e.p_markerRoot&&e.p_markerRoot.visible&&(t=!0);var i=!1;t||(i=!0),e.activeScene.settings.keepVisible&&!e.activeScene.markerNeverFound&&(i=!0),i&&e.activeScene.playSceneVideos(),is.ios(arguments)&&setTimeout(function(){_video&&_video.play()},1e3)},!1)}}function scene(e,t,a){this.data=JSON.parse(JSON.stringify(e)),this.index=t,this.mode=a,this.type=null,this.url=e.url,this.projectFolder=null,this.isMediaScene=!1,this.isSlam=!1,this.settings=null,this.materials=null,this.materialsLinks=null,this.modules=null,this.rootSmoothing=null,this.rootNoMarker=null,this.markerRoot=null,this.rootOrientation=null,this.rootXR=null,this.rootModel=null,this.rootLighting=null,this.ambientLight=null,this.light=[],this.object=null,this.animations=null,this.textures=[],this.nbTextureFiles=0,this.currentTextureFileIndex=0,this.texturesTotalFileSize=0,this.tris=0,this.audioListener=null,this.sound=null,this.nbAudiosLoaded=0,this.mixer=null,this.modulesEngine=null,this.currentMediaPage=0,this.markerNeverFound=!0,this.needPlayButton=!1,this.hint=null,this.threejsCanvas=null,this.raycaster=null,this.flowRaycaster=null,this.isBundleScene=!1,this.tracking=null,this.init=function(){var e=this.data.model.type;"img"!=e&&"media"!=e||(this.isMediaScene=!0),this.addMissingData(),this.setup()},this.addMissingData=function(){var e=this.data,t=e.settings;if(t.lighting&&void 0==t.lighting.root&&(t.lighting.root={transform:{ar:{scale:{xyz:1}},vr:{scale:{xyz:1}}}}),void 0==t.orientationSelector&&(t.orientationSelector=1),void 0==t.vertical&&(t.vertical=!1),e.modules||t.tools&&(_isDebug&&console.log("scene "+this.index+": using old tools"),e.modules=t.tools),e.pattern||(e.pattern={id:null}),void 0==t.smoothing&&(t.smoothing=1),void 0==t.keepVisibleScale&&(t.keepVisibleScale=1),this.isMediaScene&&!e.composition.length){console.log("OBS: convert media to composition");var a,i,o=e.materials.length;for(a=0;a<o;a++){e.composition[a]={items:[],title:""+(a+1)};var s;(i=e.materials[a]).transform?(s=JSON.parse(JSON.stringify(i.transform))).rotation.x=0:(console.log("no transform"),s={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{xyz:10}}),e.composition[a].items[0]={transform:s,shape:"plane",matIndex:a,itemIndex:0}}if(e.transform){var n=e.transform.vr;n?(console.log("comp: fix vr t"),n.position.y=0,n.rotation.x=0):console.log("comp: no vr t")}}},this.setup=function(){var e=this.data,t=e.settings;if(this.projectFolder=_rootDirectory+"s/"+e.folder+"/"+e.url+"/",this.type=e.model.type,!this.isBundleScene&&t.slam&&1==t.slam.enabled&&(this.isSlam=!0),_xr.bundle&&(this.isBundleScene=!0),this.rootOrientation=new THREE.Group,this.rootOrientation.name="R Ori "+this.index,this.rootXR=new THREE.Group,this.rootXR.name="rootXR",this.rootModel=new THREE.Group,this.rootModel.name="rootModel",this.rootNoMarker=new THREE.Group,this.rootNoMarker.name="rootNoMarker "+this.index,this.rootSmoothing=new THREE.Group,this.rootSmoothing.name="rootSmoothing "+this.index,this.rootXR.add(this.rootModel),this.hint=_rootDirectory+"assets/xrplus-marker-512.png",e.pattern&&e.pattern.id&&(this.hint=_rootDirectory+"p/"+e.pattern.folder+"/"+e.pattern.id+"/"+e.pattern.url),e.branding&&e.branding.main&&e.branding.main.hint&&(this.hint=_rootDirectory+"s/"+e.folder+"/"+e.url+"/"+e.branding.main.hint),t.tools&&1==t.tools.enabled&&(this.modules=t.tools),t.modules&&1==t.modules.enabled&&(this.modules=this.data.modules),this.modules||(console.log("-> OBS create modules"),this.modules={}),!this.modules.states&&t.animations){var a=t.animations.activeIndex;void 0!=a&&-1!=a&&(_isDebug&&console.log("-> OBS convert settings.animations to states"),this.modules.states={defaultStateIndex:0,enabled:!0,open:!1,states:[{name:"state 1",order:0,enter:[{animationIndex:a,animationLoop:!0,type:"playAnimation"}]}]},t.animations=null)}if(t.audio&&t.audio.sounds&&-1!=t.audio.activeIndex&&void 0!=t.audio.activeIndex){console.log("-> OBS convert audio settings to states"),this.modules.states||(this.modules.states={defaultStateIndex:0,enabled:!0,open:!1,states:[{name:"state 1",order:0}]});(s=this.modules.states.states[this.modules.states.defaultStateIndex]).enter||(s.enter=[]),s.enter.push({type:"playAudio",audioIndex:0}),delete t.audio.activeIndex}if(this.isBundleScene&&(this.tracking=_xr.tracking,"selector"==this.tracking.type&&(e.pattern=this.tracking.singleMarker),"multiple"==this.tracking.type&&(e.pattern=_xr.bundle.scenes[this.index].marker,e.pattern||(e.pattern={id:null}))),this.settings=this.data.settings,this.materials=this.data.materials,this.materialsLinks=this.data.materialsLinks,this.modules.states&&this.modules.states.enabled&&this.modules.states.states){var i,o,s;for(i=0;i<this.modules.states.states.length;i++)if((s=this.modules.states.states[i]).enter)for(o=0;o<s.enter.length;o++)if("playAudio"==s.enter[o].type&&void 0!=s.enter[o].audioIndex&&-1!=s.enter[o].audioIndex){this.needPlayButton=!0;break}}_isDebug&&console.log("-> needPlayButton "+this.needPlayButton)},this.closePlayPanel=function(){var e=this;return void addToLog("-> scene "+e.index+" : close play panel")},this.setActive=function(e){if(e&&this.playSceneVideos(),this.isMediaScene){this.data.composition.length>1?($("#pages").css("display:block;"),$("#pages .buttons").css("display:none;"),$('#pages .buttons[data-scene="'+this.index+'"]').css("display:block;")):$("#pages").css("display:none;");var t=!0;if(this.markerRoot&&(t=!1,this.markerRoot.visible&&(t=!0),this.settings.keepVisible&&!this.markerNeverFound&&(t=!0)),t){var a,i=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');for(a=0;a<i.length;a++)if(i[a].getAttribute("data-mat")==this.currentMediaPage){i[a].play();break}}}else $("#pages").css("display:none;");$(".module").removeClass("activeScene"),$("#tools .button").removeClass("activeScene"),"ar"==this.mode&&e&&this.foundMarker(),this.modulesEngine&&this.modulesEngine.setActiveModules()},this.setupMainScreen=function(){if("ar"==this.mode){$("#mainButton").html(""),$("#social>span").css("display:none");var e=$('#social>span[data-index="'+this.index+'"]');e.css("display:block");var t=this.data.branding;if(this.isBundleScene&&_mainData.branding&&_mainData.branding.main&&(t=_mainData.branding),t){var a=t.main;if(a){if(a.buttons&&a.buttons[0]){var i=a.buttons[0],o=!0;0===i.enabled&&(o=!1),o&&i.textButton&&i.url&&$("#mainButton").html('<a href="'+i.url+'" target="_blank" class="button">'+i.textButton+"</a>")}a.social&&(a.social.enabled||e.css("display:none"));var s=$("#orientation ul");this.isSlam?s.css("display:none"):void 0!=a.orientationSelector&&(a.orientationSelector?s.css("display:block"):s.css("display:none"))}}}},this.resumeAudioContext=function(){if(this.audioListener){this.audioListener.context.resume().then(function(){console.log("audio Playback resumed ok")})}},this.foundMarker=function(){if(this.markerNeverFound&&this.modulesEngine){var e=this.modulesEngine.modulesData.states;e&&e.enabled&&this.modulesEngine.applyDefaultState()}this.playSceneVideos(),this.markerNeverFound=!1},this.load=function(){addToLog("-> scene "+this.index+" : load"),this.isMediaScene?this.loadMedias():(this.countTextures(),loadAB(this))},this.loadMedias=function(){var e=this;addToLog("-> load scene medias "+e.index);var t=new THREE.Group;t.name="medias root";var a,i=e.data.composition.length;if(i>1){var o=document.getElementById("pages"),s=document.createElement("div");s.className="buttons",s.setAttribute("data-scene",e.index),o.appendChild(s);var n,r;for(a=0;a<i;a++)(n=document.createElement("span")).className="button",0==a&&n.classList.add("active"),n.setAttribute("data-index",a),r=""+(a+1),e.data.composition[a].title&&(r=e.data.composition[a].title),n.textContent=r,s.appendChild(n),n.addEventListener(_clickOrTouch,function(){var t=this.getAttribute("data-index");e.currentMediaPage=t,e.buildComposition(),$("#pages .button").removeClass("active"),$("#pages .button").eq(t).addClass("active")})}e.onModelLoaded(t,null,null)},this.buildComposition=function(){_isDebug&&console.log("-->> -->> buildComposition page "+this.currentMediaPage);var e;if(this.object){for(;this.object.children.length>0;)this.object.remove(this.object.children[0]);var t=this.data.composition[this.currentMediaPage];if(t)if(t.items){this.pauseAllSceneVideos(),this.playSceneVideos();var a;for(e=0;e<t.items.length;e++){a=t.items[e];var i,o=this.data.materials[a.matIndex].shape;o||(o="plane"),"plane"==o&&(i=new THREE.PlaneGeometry(1,1)),"circle"==o&&(i=new THREE.CircleGeometry(.5,64)),i.rotateX(THREE.Math.degToRad(-90));var s=new THREE.Mesh(i,null);s.name="item "+e,s.itemIndex=e,s.matIndex=a.matIndex,this.object.add(s)}this.refreshComposition(),this.setupMaterials(this.object),this.startCompositionAnimations()}else console.log("COMPO ITEMS UNDEF");else console.log("COMPO UNDEF")}else console.log("buildComposition -> no object")},this.startCompositionAnimations=function(){var e,t,a=this.data.composition[this.currentMediaPage];for(t=0;t<a.items.length;t++){e=a.items[t];var i=this.data.materials[e.matIndex],o=i.animationType,s=i.animationSpeed,n=null;if(this.object.traverse(function(e){e.itemIndex==t&&(n=e)}),!n)return void console.log("animaed object is null");if("pulse"==o){var r=n.scale.x,l=n.scale.y,c=n.scale.z,d=1.1*r,h=1.1*l,u=1.1*c,f=800;"fast"==s&&(f=400);var m=new TWEEN.Tween(n.scale).to({x:d,y:h,z:u},f),p=new TWEEN.Tween(n.scale).to({x:r,y:l,z:c},600);m.chain(p),p.chain(m),m.start()}if("rot_y_clockwise"==o){f=2e3;"fast"==s&&(f=1e3);new TWEEN.Tween(n.rotation).to({y:"-"+Math.PI/2},f).onComplete(function(){Math.abs(n.rotation.y)>=2*Math.PI&&(n.rotation.y=n.rotation.y%(2*Math.PI))}).start().repeat(1/0)}if("rot_y_anticlockwise"==o){f=2e3;"fast"==s&&(f=1e3);new TWEEN.Tween(n.rotation).to({y:"+"+Math.PI/2},f).onComplete(function(){Math.abs(n.rotation.y)>=2*Math.PI&&(n.rotation.y=n.rotation.y%(2*Math.PI))}).start().repeat(1/0)}}},this.refreshComposition=function(){var e,t,a,i,o,s,n=this,r=n.data.materials,l=n.data.composition[n.currentMediaPage],c=0;"vr"==n.mode&&(n.object.position.set(0,1,0),n.object.rotation.set(THREE.Math.degToRad(90),0,0)),n.object.traverse(function(d){n.object!=d&&(c=d.itemIndex,i=l.items[c],o=i.transform,(s=r[i.matIndex]).colorMap&&s.colorMap.width&&(e=s.colorMap.width,t=s.colorMap.height,a=o.scale.xyz/10,d.scale.set(1*a,1*a,t/e*a)),d.position.set(1*o.position.x,1*o.position.y,1*o.position.z),d.rotation.set(1*o.rotation.x,1*o.rotation.y,1*o.rotation.z))})},this.updateTexturesLoader=function(e){"ar"==this.mode&&(e=50+e/2,_xr.updateLoader(e)),"vr"==this.mode&&_xr.updateTexturesLoader(e)},this.updateModelLoader=function(e){"ar"==this.mode&&_xr.updateLoader(e/2),"vr"==this.mode&&_xr.updateModelLoader(e)},this.updateLoader=function(e){this.updateModelLoader(e)},this.onModelLoaded=function(e,t){this.object=e,this.animations=t,this.updateLoader(100),this.loadTextures()},this.addObject=function(){var e=this.data.transform[this.mode],t=e.scale.xyz*this.data.transform.scaleToFit/10;if(this.rootModel.scale.set(t,t,t),"vr"==this.mode){this.rootModel.rotation.set(THREE.Math.degToRad(e.rotation.x),THREE.Math.degToRad(e.rotation.y),THREE.Math.degToRad(e.rotation.z)),this.rootModel.position.set(e.position.x/10,e.position.y/10,e.position.z/10-1);var a=new THREE.Vector3(e.position.x/10,e.position.y/10,e.position.z/10);new TWEEN.Tween(this.rootModel.position).to(a,1e3).easing(TWEEN.Easing.Quadratic.Out).start();this.rootModel.add(this.object)}"ar"==this.mode&&(this.rootModel.position.set(e.position.x/10,e.position.y/10,e.position.z/10),this.rootModel.rotation.set(THREE.Math.degToRad(e.rotation.x),THREE.Math.degToRad(e.rotation.y),THREE.Math.degToRad(e.rotation.z)),this.rootModel.add(this.object),this.rootXR.rotation.set(THREE.Math.degToRad(90),0,0),this.rootOrientation.add(this.rootXR))},this.countTextures=function(){this.nbTextureFiles=0;var e,t,a;for(e=0;e<this.materials.length;e++)(a=(t=this.materials[e]).colorMap)&&a.url&&this.nbTextureFiles++,(a=t.normalMap)&&a.url&&this.nbTextureFiles++,(a=t.metalnessMap)&&a.url&&this.nbTextureFiles++},this.loadTextures=function(){this.nbTextureFiles=0;var e,t,a,i=0;for(e=0;e<this.materials.length;e++)this.textures.push({}),(a=(t=this.materials[e]).colorMap)&&a.url&&this.nbTextureFiles++,_isDebug&&a&&a.webp&&(i+=a.fileSize-a.sizeWebp),(a=t.normalMap)&&a.url&&this.nbTextureFiles++,_isDebug&&a&&a.webp&&(i+=a.fileSize-a.sizeWebp),(a=t.metalnessMap)&&a.url&&this.nbTextureFiles++,_isDebug&&a&&a.webp&&(i+=a.fileSize-a.sizeWebp);addToLog("webpSavings "+i),0!=this.nbTextureFiles?this.loadTexture(0,"colorMap"):this.onTexturesLoaded()},this.loadTexture=function(e,t){var a=this,i=a.data.materials[e],o=i[t];if(o)if(o.url)if("metalnessMap"!=t||"MeshStandardMaterial"==i.type){var s=a.projectFolder+o.url;o.webp&&is.chrome(arguments)&&(addToLog("using webp "+o.webp),s=a.projectFolder+o.webp);if("mp4"!=s.substr(s.lastIndexOf(".")+1)){var n=new THREE.TextureLoader;a.textures[e][t]=n.load(s,function(i){i.wrapS=i.wrapT=THREE.RepeatWrapping,a.loadNextTexture(e,t),a.currentTextureFileIndex++},function(){},function(){addToLog("error loading texture: "+e+" "+t),a.loadNextTexture(e,t),a.currentTextureFileIndex++})}else{var r=document.createElement("video");r.setAttribute("loaded","false"),r.oncanplaythrough=function(){"true"!=r.getAttribute("loaded")&&(r.setAttribute("loaded","true"),a.loadNextTexture(e,t),a.currentTextureFileIndex++)},r.onprogress=function(){"true"!=r.getAttribute("loaded")&&this.duration&&this.buffered&&(r.setAttribute("loaded","true"),a.loadNextTexture(e,t),a.currentTextureFileIndex++)};var l=!0;i.audio&&1==i.audio&&(_isDebug&&addToLog("video requires a play button"),l=!1,a.needPlayButton=!0),r.className="videoTexture",r.setAttribute("height",128),r.setAttribute("width",128),r.setAttribute("data-scene",a.index),r.setAttribute("data-mat",e),document.body.appendChild(r),r.loop=!0,r.playsInline=!0,l&&(r.muted=!0),console.log("muted "+r.muted);var c=document.createElement("source");c.src=s,c.setAttribute("type","video/mp4"),r.appendChild(c),r.load(),a.textures[e][t]=new THREE.VideoTexture(r);var d=o.width,h=o.height;if(d&&0==(d&d-1)&&(h&&0==(h&h-1))){var u=!0;is.android(arguments)&&is.firefox(arguments)&&(u=!1),u&&(a.textures[e][t].wrapS=a.textures[e][t].wrapT=THREE.RepeatWrapping)}}}else a.loadNextTexture(e,t);else a.loadNextTexture(e,t);else a.loadNextTexture(e,t)},this.loadNextTexture=function(e,t){var a=parseInt(100*this.currentTextureFileIndex/this.nbTextureFiles);if(this.updateTexturesLoader(a),"colorMap"!=t){if("normalMap"!=t)return"metalnessMap"==t?++e==this.textures.length?void this.onTexturesLoaded():void this.loadTexture(e,"colorMap"):void 0;this.loadTexture(e,"metalnessMap")}else this.loadTexture(e,"normalMap")},this.onTexturesLoaded=function(){$("#textures .fill").css("width:100%;");this.loadAudios()},this.loadAudios=function(){if(this.nbAudiosLoaded=0,this.settings.audio)if(this.settings.audio.sounds){this.sound=[];var e,t=this.settings.audio.sounds.length;if(t)for(this.audioListener=new THREE.AudioListener,e=0;e<t;e++)this.sound[e]=new THREE.Audio(this.audioListener),this.loadOneAudio(e,t)}else this.onAudiosLoaded();else this.onAudiosLoaded()},this.loadOneAudio=function(e,t){var a=this,i=a.projectFolder+a.settings.audio.sounds[e].url;(new THREE.AudioLoader).load(i,function(i){a.nbAudiosLoaded++,a.sound[e].setBuffer(i),a.nbAudiosLoaded>=t&&a.onAudiosLoaded()},function(){},function(){a.nbAudiosLoaded++,addToLog("audio error "+e+" : "+a.nbAudiosLoaded+" / "+t),a.nbAudiosLoaded>=t&&a.onAudiosLoaded()})},this.onAudiosLoaded=function(){if("vr"!=this.mode){if("ar"==this.mode){if(!this.isBundleScene&&this.isSlam)return console.log("single slam"),void this.onReady();if(this.isBundleScene&&"slam"==this.tracking.type)return console.log("bundle slam"),void this.onReady()}if("ar"==this.mode)if("none"==document.getElementById("playPanel").style.display&&this.settings.audio&&(_body.classList.contains("m")||1==this.settings.audio.noMarker)&&_xr.playAudio(this,0),0==this.index){var e=!1;"undefined"!=typeof _isNFT&&(e=_isNFT),e?_xr.preparePattern():window.ARController&&ARController.getUserMediaThreeScene?_xr.ARThreeOnLoad():(addToLog("ERROR 345 arcon"),console.log("ERROR 345 arcon"))}else _xr.loadMarker()}else this.onReady()},this.onReady=function(){if(addToLog("-> scene "+this.index+" : ready"),this.threejsCanvas=document.getElementById("threejs"),this.setupRayCast(),this.isMediaScene){this.data.composition[this.currentMediaPage].items&&this.buildComposition()}if(this.setupMaterials(),this.setupLighting(),this.setupAnimations(),this.setupEnvMap(),this.addObject(),this.modules&&(this.modulesEngine=new modules(_xr,this)),void 0!=document.querySelectorAll("#sceneSelector li")){var e=document.querySelectorAll("#sceneSelector li")[this.index];e&&(e.style.visibility="visible")}_xr.allSceneDataLoaded()},this.setupRayCast=function(){var e=this;e.raycaster=new THREE.Raycaster;_xr.renderer;_body.classList.contains("nft")&&_nft.renderer,e.threejsCanvas.addEventListener("click",function(t){$("#bgModal").length>0||e.rayCast(t)},!1)},this.applyDefaultState=function(){this.modulesEngine&&this.modulesEngine.applyDefaultState()},this.pauseAllSceneVideos=function(){var e=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(e){var t;for(t=0;t<e.length;t++)e[t].pause()}},this.playVideo=function(e){var t=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(t){var a;for(a=0;a<t.length;a++)if(t[a].getAttribute("data-mat")==e)return t[a].play(),t[a].setAttribute("data-stopped","false"),void t[a].setAttribute("data-paused","false")}},this.stopVideo=function(e){var t=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(t){var a;for(a=0;a<t.length;a++)if(t[a].getAttribute("data-mat")==e)return t[a].pause(),t[a].currentTime=0,void t[a].setAttribute("data-stopped","true")}},this.pauseVideo=function(e){var t=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(t){var a;for(a=0;a<t.length;a++)if(t[a].getAttribute("data-mat")==e)return t[a].pause(),void t[a].setAttribute("data-paused","true")}},this.playVideoTextures=function(){console.log("DEP : playVideoTextures"),this.playSceneVideos()},this.playSceneVideos=function(){var e=null;this.isMediaScene&&(e=this.data.composition[this.currentMediaPage]);var t=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(t){var a,i;for(a=0;a<t.length;a++)if("true"!=(i=t[a]).getAttribute("data-stopped")){if(this.isMediaScene){var o,s=i.getAttribute("data-mat");for(o=0;o<e.items.length;o++)if(e.items[o].matIndex==s){!0;break}}if(is.ios(arguments)){var n=i.play();void 0!==n&&n.then(function(){}).catch(function(){console.log("auto play prevented")})}else i.play()}else console.log("abort auto play")}},this.playAudio=function(e,t){if(1!=t&&(t=!1),!(void 0==e||e<0)&&this.sound){this.stopAudio();var a=this.sound[e];if(a)try{a.loop=t,a.play()}catch(e){console.log(e)}}},this.stopAudio=function(){if(this.sound){var e;for(e=0;e<this.sound.length;e++)this.sound[e].isPlaying&&this.sound[e].stop()}},this.playSFX=function(e){if(!(void 0==e||e<0)&&this.sound){var t=this.sound[e];if(t)try{t.loop=!1,t.play()}catch(e){console.log(e)}}},this.openLink=function(e,t){if(!document.getElementById("bgModal")&&(t=cleanString(t),is.url(t)))if(void 0===e.wwwModal&&(e.wwwModal=!0),void 0===e.wwwSameTab&&(e.wwwSameTab=!1),e.wwwModal){var a='Would you like to open\n<strong style="font-size:15px">'+t+"</strong>\nin a new tab?";e.wwwSameTab&&(a='Would you like to visit\n<strong style="font-size:15px">'+t+"</strong>?"),openModal(a,function(){e.wwwSameTab?(window.location=t,_body.innerHTML="",_body.style.background="#a0a0a0"):window.open(t,"_blank")},function(){},"yes","cancel")}else e.wwwSameTab?(window.location=t,_body.innerHTML="",_body.style.background="#a0a0a0"):window.open(t,"_blank")},this.setupMaterials=function(){var e=this;if(e.object){var t=0,a=0;e.object.geometry&&e.setupMaterial(e.object,t),t=1,e.object.traverse(function(i){i.geometry&&(e.isMediaScene?e.setupCompositionItemMaterial(i):e.setupModelMaterial(i,t),i.geometry.attributes&&i.geometry.attributes.normal&&(a+=i.geometry.attributes.normal.count)),t++}),e.tris=parseInt(a/3*10/10)}else console.log("--> setup materials : object is NULL "+e.index)},this.setupModelMaterial=function(e,t){var a,i,o=this.data.materialsLinks,s=[],n=!1;for(a=0;a<o.length;a++)if(void 0==!Array.isArray(o[a].mats)){if(o[a].id==t){n=!0,s[0]=o[a].m;break}}else if(o[a].id==t){for(n=!0,i=0;i<o[a].mats.length;i++)s[i]=o[a].mats[i].m;break}if(0==n){console.log("!! did not find a matching ID for "+e.name+" > fixing it");var r={id:t,mats:[{m:0}]};this.data.materialsLinks.push(r),s[0]=0}this.setupMaterial(e,s)},this.setupCompositionItemMaterial=function(e){var t=e.itemIndex,a=this.currentMediaPage,i=[1*this.data.composition[a].items[t].matIndex];this.setupMaterial(e,i)},this.setupMaterial=function(t,a){var i,o,s=[],n=!1;"SkinnedMesh"==t.type&&(n=!0);var r=new THREE.MeshPhongMaterial({color:16776960,specular:2236962,shininess:0,skinning:n});if(0==a.length){if(addToLog("- - -  no mat - - -"),!this.isMediaScene)return void(t.material=r);_isDebug&&console.log("fixing it on img scene"),a=[0]}for(i=0;i<a.length;i++){o=0,i<a.length&&(o=a[i]),o>=e.materials.length&&(o=0);var l=this.data.materials[o],c=l.type,d=l.shininess,h=l.color,u=l.specular;void 0==u&&(u=1118481);var f=l.reflectivity,m=l.doubleSide,p=l.colorMap,v=l.normalMap,g=l.metalnessMap,b=l.roughness,y=l.metalness,_=l.chroma,x=l.opacity;if(void 0==x&&(x=1),this.isMediaScene&&(m=!0),"MeshStandardMaterial"==c&&(s[i]=new THREE.MeshStandardMaterial({color:h,skinning:n,roughness:b,metalness:y})),"MeshLambertMaterial"==c&&(c="MeshPhongMaterial"),"MeshPhongMaterial"==c&&(s[i]=new THREE.MeshPhongMaterial({color:h,specular:u,reflectivity:f,shininess:d,skinning:n})),"MeshBasicMaterial"==c&&(s[i]=new THREE.MeshBasicMaterial({color:h,skinning:n})),"MeshToonMaterial"==c&&(s[i]=new THREE.MeshToonMaterial({color:h,specular:u,reflectivity:f,shininess:d,skinning:n})),"VideoMaterial"==c&&(_||(s[i]=new THREE.MeshBasicMaterial({color:h,skinning:n}))),_&&("MeshBasicMaterial"==c||"VideoMaterial"==c)){p=this.textures[o].colorMap;var M=new THREE.Color(l.chromaColor),w=l.range,E=l.chromaSmoothness;void 0==w&&(w=.5),void 0==E&&(E=7),s[i]=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:p},color:{type:"c",value:M}},vertexShader:"varying mediump vec2 vUv;\nvoid main(void)\n{\nvUv = uv;\nmediump vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"uniform mediump sampler2D texture;\nuniform mediump vec3 color;\nvarying mediump vec2 vUv;\nvoid main(void)\n{\n  mediump vec3 tColor = texture2D( texture, vUv ).rgb;\n  mediump float a = (length(tColor - color) - "+w+") * "+E+".0;\n  gl_FragColor = vec4(tColor, a);\n}",transparent:!0})}if("MaskMaterial"==c){s[i]=new THREE.MeshBasicMaterial({color:h,skinning:n,colorWrite:!1});var T=l.maskedObject;if(T){t.renderOrder=100;var S,k,A;for(S=0;S<T.length;S++)-1!=(k=T[S])&&(A=this.findObjectByIndex(k))&&(A.renderOrder=101)}}if(void 0==s[i]&&(console.log("ERROR: m[i] is undefined > DEFAULT MAT"),s[i]=r),_||(s[i].transparent=!1),p&&p.url&&""!=p.url){"mp4"!=p.url.substr(p.url.lastIndexOf(".")+1)&&1==p.useAlpha&&(s[i].transparent=!0),s[i].map=this.textures[o].colorMap}v&&"MeshBasicMaterial"!=c&&v.url&&""!=v.url&&(s[i].normalMap=this.textures[o].normalMap),"MeshStandardMaterial"==c&&g&&""!=g.url&&void 0!=g.url&&(s[i].metalnessMap=this.textures[o].metalnessMap,s[i].roughnessMap=this.textures[o].metalnessMap),s[i].side=1==m?THREE.DoubleSide:THREE.FrontSide,s[i].opacity=x,1!=x&&(s[i].transparent=!0)}var L=!1;t.geometry.groups&&t.geometry.groups.length>0&&(L=!0),L&&a.length>1?t.material=s:t.material=s[0]},this.updateMaterial=function(e){var t=this,a=0,i=[];t.object.geometry&&(i=t.getMaterialsIndexesByMesh(t.object,a),i.includes(e,0)&&t.setupMaterial(t.object,i)),a=1,t.object.traverse(function(o){o.geometry&&(i=t.getMaterialsIndexesByMesh(o,a),i.includes(e,0)&&t.setupMaterial(o,i)),a++})},this.getMaterialsIndexesByMesh=function(t,a){var i,o,s=[],n=this.data.materialsLinks,r=[];for(i=0;i<n.length;i++)if(void 0==!Array.isArray(n[i].mats));else if(n[i].id==a&&n[i].mats){for(o=0;o<n[i].mats.length;o++)r[o]=n[i].mats[o].m;break}var l;for(i=0;i<r.length;i++)l=0,i<r.length&&(l=r[i]),l>=e.materials.length&&(l=0),s.push(l);return s},this.findObjectByIndex=function(e){var t=[];return this.object.traverse(function(e){e.geometry&&t.push(e)}),t[e]},this.setupLighting=function(){var e=this.settings.lighting;if(e&&(void 0==e.enableModelLights&&(e.enableModelLights=!1),this.object.traverse(function(t){t.isLight&&(t.visible=e.enableModelLights)}),!e.unlit)){this.rootLighting=new THREE.Group,this.rootLighting.name="rootLighting",this.rootXR.add(this.rootLighting);var t=e.root.transform[this.mode].scale.xyz;this.ambientLight=new THREE.AmbientLight,this.ambientLight.intensity=e.ambient.intensity,this.ambientLight.color=new THREE.Color(e.ambient.color),this.rootLighting.add(this.ambientLight);var a,i;for(a=0;a<3;a++)i=e.lights[a],this.light[a]=new THREE.PointLight,this.light[a].color=new THREE.Color(i.color),this.light[a].intensity=i.intensity,this.light[a].position.set(i.position.x*t,i.position.y*t,i.position.z*t),this.rootLighting.add(this.light[a])}},this.setupEnvMap=function(){var e=this;if(void 0!=e.settings.envMap){var t=e.settings.envMap.index;if(0!=t)if(_xr.renderer){_xr.renderer.gammaInput=!0,_xr.renderer.gammaOutput=!0,_xr.renderer.toneMapping=THREE.NoToneMapping,_xr.renderer.toneMappingExposure=1;var a=_rootDirectory+"assets/textures/envmap"+t+".jpg",i=(new THREE.TextureLoader).load(a,function(){i.mapping=THREE.SphericalReflectionMapping,e.object.traverse(function(e){e.geometry&&e.material&&(e.material.envMap=i,"MeshBasicMaterial"!=e.material.type&&"VideoMaterial"!=e.material.type||(e.material.envMap=null),e.material.needsUpdate=!0)})})}else console.log("setupEnvMap -> no renderer -> NFT scene?")}},this.setupAnimations=function(){this.animations&&(this.mixer=new THREE.AnimationMixer(this.object))},this.playAnimation=function(e,t){if(-1!=e){var a=this.mixer;if(a||console.log("mixer is NULL"),a.stopAllAction(),this.animations&&!(e>=this.animations.length)){var i=a.clipAction(this.animations[e]);i.time=0,t||(i.loop=THREE.LoopOnce,i.clampWhenFinished=!0),a.addEventListener("loop",onLoopAction),a.addEventListener("finished",onFinishedAction),i.play()}}},this.loop=function(e){this.mixer&&this.mixer.update(e),this.modulesEngine&&this.modulesEngine.loop()},this.rayCast=function(e){var t=this,a=_xr.renderer,i=_xr.camera,o=new THREE.Vector2;_body.classList.contains("p");var s=!1;_body.classList.contains("p")&&_body.classList.contains("fid")&&(s=!0),_body.classList.contains("p")&&_body.classList.contains("nft")&&(s=!0),_body.classList.contains("nft")&&(a=_nft.renderer,i=_nft.camera);var n=a.domElement,r=n.getBoundingClientRect().width/n.offsetWidth;s&&(r=n.getBoundingClientRect().height/n.offsetWidth);var l=e.clientX,c=e.clientY;if(s){var d=l;l=c,c=d}var h=n.clientWidth*r,u=n.clientHeight*r,f=n.getBoundingClientRect().x,m=n.getBoundingClientRect().y,p=l-f,v=c-m;s&&(p=l-m,v=c-f);var g=parseInt(100*p/h),b=parseInt(100*v/u);s&&(g=100-g);var y=g/100*2-1,_=-b/100*2+1;if(o.x=y,o.y=_,t.rootOrientation.visible){i||(i=_arScene.camera),t.raycaster.setFromCamera(o,i);var x=[];t.rootModel.traverse(function(e){x.push(e)});var M=t.raycaster.intersectObjects(x);if(M.length>0){var w=M[0].object;w.name.toLowerCase();if(t.isMediaScene){var E=t.data.materials[w.matIndex];if(E.actionType&&"www"==E.actionType){var T=E.actionUrl;setTimeout(function(){t.openLink(E,T)},100)}}else if(t.modulesEngine){var S=t.modulesEngine.modulesData.states;S&&S.enabled&&t.modulesEngine.rayCastOnObject(w)}}}},this.init()}function onLoopAction(e){var t=_xr.activeScene;if(t.modulesEngine){var a=e.action;t.modulesEngine.animationEndEvent(a)}}function onFinishedAction(e){var t=_xr.activeScene;if(t.mixer.removeEventListener("finished",onFinishedAction),t.modulesEngine){var a=e.action;t.modulesEngine.animationEndEvent(a)}}function getDistanceBetween(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function modules(e,t){this.xr=e,this.scene=t,this.canvas=document.getElementById("threejs"),this.modulesData=null,this.body=document.body,this.footerDom=null,this.toolsDom=null,this.toolsButtonsWrapper=null,this.statesModuleDom=null,this.currentStateIndex=0,this.photoModuleDom=null,this.materialsModuleDom=null,this.eggModuleDom=null,this.photoData=null,this.gesturesHook=null,this.rotationY=0,this.startTouch={x:0,y:0},this.lastTouch={x:0,y:0},this.isMouseDown=!1,this.skipRotation=!1,this.currentScale=1,this.baseScale=1,this.setupModules=function(){if(this.footerDom=document.querySelector("footer"),document.querySelector("#xr footer")&&(console.log("using #xr footer"),this.footerDom=document.querySelector("#xr footer")),this.footerDom){this.modulesData=this.scene.modules;var e=document.createElement("div");e.id="loadingTools",e.innerHTML="<p>please wait...</p>",this.body.appendChild(e),document.getElementById("tools")?(this.toolsDom=document.getElementById("tools"),this.toolsButtonsWrapper=document.getElementById("toolsButtonsWrapper")):(this.toolsDom=document.createElement("div"),this.toolsDom.id="tools",this.footerDom.insertBefore(this.toolsDom,document.querySelector("footer .title")),this.toolsButtonsWrapper=document.createElement("div"),this.toolsButtonsWrapper.id="toolsButtonsWrapper",this.toolsDom.appendChild(this.toolsButtonsWrapper)),this.modulesData.states&&1==this.modulesData.states.enabled&&this.statesModule(),this.modulesData.photo&&1==this.modulesData.photo.enabled&&"ar"==this.scene.mode&&this.photoModule(),this.modulesData.materials&&1==this.modulesData.materials.enabled&&this.materialsModule(),this.modulesData.gestures&&1==this.modulesData.gestures.enabled&&"ar"==this.scene.mode&&this.gesturesModule(),this.modulesData.egg&&1==this.modulesData.egg.enabled&&"ar"==this.scene.mode&&(this.eggModule(),this.closeModules(),this.eggModuleDom.classList.add("open"),this.body.classList.add("eggModule")),document.onkeyup=function(e){if(13==e.which)return document.activeElement.blur(),!1}}else console.log("no footer -> abort modules")},this.closeModules=function(){$('.module[data-scene="'+this.scene.index+'"]').removeClass("open"),this.body.classList.remove("eggModule")},this.setActiveModules=function(){$('.module[data-scene="'+this.scene.index+'"]').addClass("activeScene"),$('#tools .button[data-scene="'+this.scene.index+'"]').addClass("activeScene")},this.insertModuleDom=function(e){var t=document.querySelector("footer .modules");document.querySelector("#xr footer .modules")&&(t=document.querySelector("#xr footer .modules")),t.prepend(e)},this.statesModule=function(){var e=this,t=e.modulesData.states,a=t.title;void 0==a&&(a="interactions");var i=t.states[t.defaultStateIndex],o=0;if(i.button&&(o=i.button.length),o>0){var s=document.createElement("span");s.className="button",s.innerText=a,s.setAttribute("data-scene",e.scene.index),e.toolsButtonsWrapper.appendChild(s)}if(e.statesModuleDom=document.createElement("div"),e.statesModuleDom.setAttribute("class"," module statesModule brandingBg"),e.statesModuleDom.setAttribute("data-scene",e.scene.index),t.open&&e.statesModuleDom.classList.add("open"),e.insertModuleDom(e.statesModuleDom),o>0&&!t.hideCloseButton){var n=document.createElement("span");n.className="b_close",e.statesModuleDom.appendChild(n)}if(""!=a){var r=document.createElement("h3");r.innerText=a,e.statesModuleDom.appendChild(r)}var l=document.createElement("div");l.className="buttons",e.statesModuleDom.appendChild(l),"vr"==e.scene.mode&&e.applyDefaultState(),o>0&&(s.addEventListener("click",function(){e.closeModules(),e.statesModuleDom.classList.add("open")}),n&&n.addEventListener(_clickOrTouch,function(){e.closeModules()}))},this.findObjectByIndex=function(e){var t=[];return this.scene.object.traverse(function(e){e.geometry&&t.push(e)}),t[e]},this.debugObjectByIndex=function(e){var t=0,a=this.findObjectByIndex(e);console.log("debug: "+a.name),console.log(a);var i=a.parent;for(t=0;t<20;t++){if(!i){console.log("parent is null");break}console.log(t+" "+i.name+" : "+i.visible),i=i.parent}console.log("box");var o=(new THREE.Box3).setFromObject(a),s=new THREE.Vector3(0,0,0);o.getSize(s);console.log(o),console.log("done")},this.applyDefaultState=function(){_isDebug&&console.log("- - - - - apply default state");var e=this.modulesData.states;if(e){var t=e.defaultStateIndex;void 0!=t&&this.applyState(t)}},this.applyState=function(e){var t=this;if(""!==e&&!(e<0))if(void 0==e||isNaN(e))console.log("state index is not valid _"+e+"_");else{var a=t.modulesData.states;if(!(e>=a.states.length)){var i=a.states[e];t.highLightStateButton(e),t.currentStateIndex=e;var o,s;if(i.enter)for(o=0;o<i.enter.length;o++){if("show"==(s=i.enter[o]).type){(n=t.findObjectByIndex(s.objectIndex))&&_isDebug&&console.log("show "+n.name+" "+s.objectIndex),n&&(n.visible=!0)}if("hide"==s.type){var n;(n=t.findObjectByIndex(s.objectIndex))&&_isDebug&&console.log("hide "+n.name+" "+s.objectIndex),n&&(n.visible=!1)}if("playAnimation"==s.type){var r=s.animationIndex;if(void 0!=r&&r>=0){var l=!1;s.animationLoop&&(l=!0),t.scene.playAnimation(r,l)}}if("playAudio"==s.type){var c=s.audioIndex;if(void 0!=c&&c>=0){l=!1;s.audioLoop&&(l=!0),t.scene.playAudio(c,l)}}if("stopAudio"==s.type&&t.scene.stopAudio(),"playVideo"==s.type){if(void 0!=(d=s.playvideoIndex)&&d>=0){l=!0;t.scene.playVideo(d,l)}}if("stopVideo"==s.type){void 0!=(d=s.stopvideoIndex)&&d>=0&&t.scene.stopVideo(d)}if("pauseVideo"==s.type){var d;void 0!=(d=s.stopvideoIndex)&&d>=0&&t.scene.pauseVideo(d)}if("title"==s.type){var h=s.title;void 0==h&&(h=""),$('.statesModule[data-scene="'+t.scene.index+'"] h3').text(h)}if("timer"==s.type&&s.timer){var u=t.currentStateIndex,f=s.timerEnd;setTimeout(function(){t.currentStateIndex==u&&t.applyState(f)},s.timer)}if("property"==s.type){var m=s.indexMaterial,p=s.propertyValue,v=s.duration,g=t.scene.data.materials[m];g.color=new THREE.Color(g.color);var b=new THREE.Color(p);if(v>10){!function(e,a){var i=a;new TWEEN.Tween(g.color).to(i,v).start().onUpdate(function(){t.scene.updateMaterial(e)})}(m,b)}else g.color=new THREE.Color(b),t.scene.updateMaterial(m)}var y=document.querySelector('.statesModule[data-scene="'+t.scene.index+'"] .buttons');if(y){i.buttonsAlign||(i.buttonsAlign="left"),y.style.textAlign=i.buttonsAlign,y.innerText="";var _,x,M,w,E=!1;if(i.button&&i.button.length&&(E=!0),E||((x=document.createElement("span")).className="button",x.style.visibility="hidden",y.appendChild(x)),E){y.setAttribute("data-buttons",i.button.length);var T,S;for(M=0;M<i.button.length;M++){if(_=i.button[M],x=document.createElement("span"),x.className="button",S="",T="",a.buttons){var k,A;for(k=0;M<a.buttons.length;k++)if(a.buttons[k].id==_.id){S=(A=a.buttons[k]).type,w=A.label,S||(S="switchState"),T=A.stateIndex,x.setAttribute("data-index",T),x.setAttribute("data-pool",k),A.customColors&&(x.style.background=A.background,x.style.color=A.color);break}}else w=_.name,S="switchState",T=_.stateIndex,x.setAttribute("data-index",T);x.innerText=w,"switchState"==S&&T==e&&x.classList.add("active"),y.appendChild(x),x.addEventListener(_clickOrTouch,function(){t.buttonAction(t,this,null)})}}}}}}},this.buttonAction=function(e,t,a){var i,o=e.modulesData.states,s=null;if(t)if(o.buttons){var n=t.getAttribute("data-pool");(i=(s=o.buttons[n]).type)||(i="switchState")}else i="switchState",s={stateIndex:t.getAttribute("data-index")};if(a&&(i=(s=a).type),"switchState"==i){if(t&&t.classList.contains("active"))return;e.applyState(s.stateIndex)}if("playAudio"==i){var r=s.audioIndex;s.audioLoop;void 0!=r&&r>=0&&e.scene.playAudio(r,s.audioLoop)}if("stopAllAudios"==i&&e.scene.stopAudio(),"www"==i){var l=s,c=l.www;e.scene.openLink(l,c)}if("setMaterial"==i){var d=s.indexMesh-1,h=s.indexLink,u=s.newMaterial;e.scene.data.materialsLinks[d].mats[h].m=u,e.scene.updateMaterial(u)}if(void 0!=s.sfx){var f=s.sfx;f>=0&&e.scene.playSFX(f)}},this.getNextState=function(e){var t,a=this.modulesData.states.states[this.currentStateIndex],i=null;for(t=0;t<this.scene.animations.length;t++)if(e.name==this.scene.animations[t].name){i=t;break}if(null!=i){var o=a.enter;for(t=0;t<o.length;t++)if("playAnimation"==o[t].type&&void 0!==o[t].animationEnd&&o[t].animationIndex===i){var s=o[t].animationEnd;return void(-1!=s&&this.applyState(s))}}else console.log("clip not found ...")},this.highLightStateButton=function(e){document.querySelectorAll("#statesModule .buttons .button").forEach(function(t){t.getAttribute("data-index")==e?t.classList.add("active"):t.classList.remove("active")})},this.rayCastOnObject=function(e){var t=this.modulesData.states;if(t.virtualButtons){var a,i,o;for(a=0;a<t.virtualButtons.length;a++)if(i=t.virtualButtons[a],(o=this.findObjectByIndex(i.objectIndex))==e){this.buttonAction(this,null,i),o.originalScale||(o.originalScale={x:e.scale.x,y:e.scale.y,z:e.scale.z});var s=o.originalScale.x,n=o.originalScale.y,r=o.originalScale.z;e.scale.set(.9*s,.9*n,.9*r);return void new TWEEN.Tween(e.scale).to({x:s,y:n,z:r},300).start()}}},this.materialsModule=function(){var e=this;if(1!=e.xr.multipleTracking){var t=e.modulesData.materials;if(t.mats){var a,i,o=t.mats,s=!1;for(i=0;i<o.length;i++)if(1==o[i].enabled&&!o[i].usePalette){s=!0;break}if(addToLog("needJscolor "+s),s&&void 0==window.jscolor){var n=document.createElement("script");return n.onload=function(){e.materialsModule()},n.src=_rootDirectory+"js/tools/jscolor.min.js",void document.head.appendChild(n)}var r=t.title;void 0==r&&(r="colors");var l=document.createElement("span");if(l.className="button",l.innerText=r,l.setAttribute("data-scene",e.scene.index),e.toolsButtonsWrapper.appendChild(l),e.setActiveModules(),e.materialsModuleDom=document.createElement("div"),e.materialsModuleDom.setAttribute("class","module materialsModule brandingBg"),e.materialsModuleDom.setAttribute("data-scene",e.scene.index),t.open&&e.materialsModuleDom.classList.add("open"),e.insertModuleDom(e.materialsModuleDom),!t.hideCloseButton){var c=document.createElement("span");c.className="b_close",e.materialsModuleDom.appendChild(c)}if(""!=r){var d=document.createElement("h3");d.innerText=r,e.materialsModuleDom.appendChild(d)}var h=document.createElement("div");h.className="buttons",e.materialsModuleDom.appendChild(h);var u,f,m,p,v;f=0;var g=e.scene.materials;for(a=0;a<g.length;a++){for(v=g[a].name,i=0;i<o.length;i++)if(o[i].name==v&&1==o[i].enabled)if(p="string"==typeof g[a].color?g[a].color.replace("#",""):"#ffffff",u=document.createElement("span"),h.appendChild(u),u.className="button",u.setAttribute("data-index",f),u.innerText=excerpt(v,13),u.style.background="#"+p,o[i].usePalette){if(u.setAttribute("data-index-mat-module",i),u.addEventListener("click",function(){var t=this.getAttribute("data-index"),a=this.getAttribute("data-index-mat-module"),i=e.modulesData.materials.mats[a].palette;e.openColorPalette(t,i,h)}),o[i].openPalette){var b=e.modulesData.materials.mats[i].palette;e.openColorPalette(f,b,h)}}else(m=document.createElement("input")).setAttribute("class","jscolor {width:220,padding:10,borderWidth:0}"),m.setAttribute("readonly","readonly"),m.setAttribute("data-index",a),m.setAttribute("value",p),u.appendChild(m),m.addEventListener(_clickOrTouch,function(){var e=document.querySelector("footer .palette");e&&e.parentElement.removeChild(e),document.activeElement.blur()}),m.addEventListener("change",function(){var t=this.getAttribute("data-index"),a="#"+this.value;g[t].color=a,this.parentElement.style.background=a,e.scene.setupMaterials()});f++}s&&window.jscolor.installByClassName("jscolor"),l.addEventListener("click",function(){e.closeModules(),e.materialsModuleDom.classList.add("open")}),c&&c.addEventListener(_clickOrTouch,function(){var t=document.querySelector("footer .palette");t?t.parentElement.removeChild(t):e.closeModules()}),e.setActiveModules()}}},this.openColorPalette=function(e,t,a){var i=this,o=i.scene.materials,s=document.querySelector("footer .palette");if(s){var n=s.getAttribute("data-index");if(s.parentElement.removeChild(s),n==e)return}var r=document.createElement("div");r.setAttribute("class","palette bgBranding"),r.setAttribute("data-index",e);var l,c;for(l=0;l<t.length;l++)(c=document.createElement("span")).className="color",c.setAttribute("data-color",t[l].color),c.setAttribute("data-index",e),c.style.background=t[l].color,r.appendChild(c),c.addEventListener("click",function(){var e=this.getAttribute("data-index"),t=this.getAttribute("data-color");o[e].color=t,i.scene.setupMaterials();i.materialsModuleDom.querySelector('.button[data-index="'+e+'"]').style.background=t});a.appendChild(r)},this.gesturesModule=function(){function e(e){t.isMouseDown=!0,l(e)}var t=this,a=t.modulesData.gestures;t.gesturesHook=new THREE.Group,t.gesturesHook.name="gesturesHook",t.scene.rootXR.add(t.gesturesHook),t.gesturesHook.add(t.scene.rootModel);var i=null,o=null,s=[],n=[],r="ontouchend"in window,l=function(e){var a=1;e.touches&&(a=e.touches.length),a>1&&(t.skipRotation=!0);var r=new THREE.Vector2,l=t.canvas.getBoundingClientRect(),c=l.top+document.body.scrollTop,d=l.left+document.body.scrollLeft,h=window.innerWidth,u=window.innerHeight;if(r.x=(e.clientX-d)/h*2-1,r.y=-(e.clientY-c)/u*2+1,t.startTouch={x:e.clientX,y:e.clientY},t.lastTouch={x:e.clientX,y:e.clientY},s.push(e),e.touches&&(2!=s.length&&1!=s.length||(n[0]={x:e.touches[0].screenX,y:e.touches[0].screenY},e.touches[1]&&(n[1]={x:e.touches[1].screenX,y:e.touches[1].screenY}))),2==s.length&&n[0]){var f=getDistanceBetween(n[0],n[1]);o=null,i=f}s.length>2&&s.pop()},c=function(e){if(e.target==t.canvas){var s,l,c=window.innerWidth;if(r?(s=e.changedTouches[0].clientX,l=e.changedTouches[0].clientY):(s=e.clientX,l=e.clientY),a.rotation.enabled&&!t.skipRotation){var d=(s-t.lastTouch.x)/c,h=1*a.rotation.sensibility;t.rotationY+=90*d*h}if(t.lastTouch={x:s,y:l},a.zoom.enabled&&e.touches&&2==e.touches.length){n[0]={x:e.touches[0].screenX,y:e.touches[0].screenY},n[1]={x:e.touches[1].screenX,y:e.touches[1].screenY};var u=getDistanceBetween(n[0],n[1]);null!=o?(o=i,i=u):(o=u,i=u);var f=(i-o)/10/(window.screen.width/8)*(h=a.rotation.sensibility/2);t.currentScale+=f;var m=.6*t.baseScale,p=1.5*t.baseScale;t.currentScale<m&&(t.currentScale=m),t.currentScale>p&&(t.currentScale=p)}}},d=function(e){0==(e.touches?e.touches.length:0)&&(t.skipRotation=!1),s=[],o=null};r?(document.addEventListener("touchstart",function(t){t.preventDefault(),t.clientX=t.touches[0].clientX,t.clientY=t.touches[0].clientY,e(t)},!1),document.addEventListener("touchmove",function(e){c(e)},!1),document.addEventListener("touchend",function(e){t.isMouseDown=!1,d(e)},!1)):(document.addEventListener("mousedown",e,!1),document.addEventListener("mouseup",function(){t.isMouseDown=!1},!1),document.addEventListener("mousemove",function(e){t.isMouseDown&&(e.preventDefault(),c(e))},!1))},this.photoModule=function(){var e=this;_body.classList.add("photoM");var t=document.createElement("span");t.id="b_takePhoto",t.className="button",t.innerHTML='<img src="'+_rootDirectory+'assets/icon-camera.svg" alt=""/>',e.footerDom.insertBefore(t,e.footerDom.firstChild),e.photoModuleDom=document.createElement("div"),e.photoModuleDom.setAttribute("class","module photoModule brandingBg"),e.photoModuleDom.setAttribute("data-scene",e.scene.index),e.body.appendChild(e.photoModuleDom);var a=document.createElement("span");a.className="b_close",e.photoModuleDom.appendChild(a);var i=document.createElement("div");i.id="photoPreviewWrapper",e.photoModuleDom.appendChild(i);var o=document.createElement("img");o.id="photoPreview",o.className="preview",i.appendChild(o);var s=document.createElement("div");s.id="photoForm",this.photoModuleDom.appendChild(s);var n=document.createElement("div");n.className="fields",s.appendChild(n);var r=!1;if("izs"!=e.scene.url&&"ibm"!=e.scene.url&&"123"!=e.scene.url&&"w0k"!=e.scene.url||navigator.share&&(r=!0),r){(h=document.createElement("span")).className="button",h.innerText="share photo",n.appendChild(h),n.style.textAlign="center"}else{var l=document.createElement("p"),c="Share the photo by email";void 0!==_texts&&_texts.shareThePhotoByEmail&&(c=_texts.shareThePhotoByEmail),l.innerText=c,n.appendChild(l);var d=document.createElement("input");d.id="photoEmail",d.setAttribute("placeholder","email"),d.setAttribute("type","email"),d.setAttribute("autocorrect","off"),d.setAttribute("autocapitalize","off"),n.appendChild(d);var h;(h=document.createElement("span")).id="b_sendPhoto",h.className="button",h.innerText="send",n.appendChild(h)}if(!is.desktop(_arguments)||_isDebug){var u=!1,f=e.scene;if(f.settings.slam&&"ar"==f.mode&&1==f.settings.slam.enabled&&(u=!0),e.modulesData.photo.switchCamera&&u){var m=document.createElement("span");m.className="button",m.id="swapCamera",e.footerDom.insertBefore(m,e.footerDom.firstChild),$("#swapCamera").on("click",function(){_xr.videoStream.swapCamera()})}}a.addEventListener("click",function(){e.closeModules()}),t.addEventListener(_clickOrTouch,function(){e.takePhoto()}),h.addEventListener("click",function(){r?e.sharePhoto():e.sendPhoto()})},this.eggModule=function(){function e(){var e,t,a;for(e=0;e<r*r;e++)a=16*parseInt(e/r),t=e%r*16,p.fillStyle=u[e].getAttribute("data-color"),p.fillRect(t,a,16,16);var i=p.getImageData(0,0,64,64);p.putImageData(i,0,0),f.material.needsUpdate=!0,f.material.map.needsUpdate=!0}var t=this;$("footer .title").css("display:none");var a=document.createElement("span");a.className="button",a.innerText="Paint the egg",a.setAttribute("data-scene",t.scene.index),t.toolsButtonsWrapper.appendChild(a),t.eggModuleDom=document.createElement("div"),t.eggModuleDom.setAttribute("class","module eggModule brandingBg open"),t.eggModuleDom.setAttribute("data-scene",t.scene.index),t.insertModuleDom(t.eggModuleDom);var i=document.createElement("span");i.className="b_close",t.eggModuleDom.appendChild(i);var o,s,n,r=4,l=document.createElement("div");for(l.id="palette",t.eggModuleDom.appendChild(l),o=0;o<8;o++){switch(s=document.createElement("div"),s.className="cell",o){case 0:n="#ffb000";break;case 1:n="#59b1ff";break;case 2:n="#FF33CC";break;case 3:n="#80ff33";break;case 4:n="#ff0000";break;case 5:n="#ffffff";break;case 6:n="#909090";break;case 7:n="#202020"}s.setAttribute("data-color",n),s.style.background=n,l.appendChild(s)}var c=document.querySelectorAll("#palette .cell"),d=c[0].getAttribute("data-color");for(c[0].classList.add("active"),o=0;o<c.length;o++)c[o].addEventListener(_clickOrTouch,function(){d=this.getAttribute("data-color");var e;for(e=0;e<c.length;e++)c[e].classList.remove("active");this.classList.add("active")});var h=document.createElement("div");for(h.id="patternGrid",t.eggModuleDom.appendChild(h),o=0;o<r*r;o++)(s=document.createElement("div")).className="cell",s.setAttribute("data-color","#FFFFFF"),s.setAttribute("data-index",o),s.style.background="#FFFFFF",h.appendChild(s);var u=document.querySelectorAll("#patternGrid .cell");for(o=0;o<u.length;o++)u[o].addEventListener(_clickOrTouch,function(){d!=this.getAttribute("data-color")&&(this.style.background=d,this.setAttribute("data-color",d),e())});h.addEventListener("touchmove",function(t){var a=h.getBoundingClientRect().width/r,i=h.getBoundingClientRect().left,o=t.touches[0].pageX-i,s=window.innerHeight-t.touches[0].pageY-i,n=parseInt(o/a),l=r-1-parseInt(s/a),c=u[l*r+n];d!=c.getAttribute("data-color")&&(c.style.background=d,c.setAttribute("data-color",d),e())});var f=t.scene.object.children[0],m=document.createElement("canvas");m.width=64,m.height=64;var p=m.getContext("2d");p.imageSmoothingEnabled=!1,p.webkitImageSmoothingEnabled=!1;var v=new THREE.Texture(m);v.wrapS=v.wrapT=THREE.RepeatWrapping,v.repeat.set(8,8),p.fillStyle="#ffffff",p.fillRect(0,0,64,64),f.material.map=v,f.material.needsUpdate=!0,f.material.map.needsUpdate=!0,a.addEventListener("click",function(){t.closeModules(),t.eggModuleDom.classList.add("open")}),i.addEventListener(_clickOrTouch,function(){t.closeModules()})},this.startLoading=function(){$("#loadingTools").css("display:block")},this.stopLoading=function(){$("#loadingTools").css("display:none")},this.takePhoto=function(){var e=this;$("#b_takePhoto").css("display:none"),e.closeModules(),setTimeout(function(){var t=e.canvas;e.photoData=new FormData,function(){if(e.body.classList.contains("p")&&!e.body.classList.contains("slam")){var a=new Image;a.src=t.toDataURL();var i=document.createElement("canvas");i.width=t.height,i.height=t.width;var o=i.getContext("2d");a.onload=function(){o.translate(0,a.width),o.rotate(-90*Math.PI/180),o.drawImage(a,0,0);var t=i.toDataURL("image/jpeg",.8);i=null,document.getElementById("photoPreview").src=t,e.photoData.append("imgBase64",t),e.photoData.append("url",_projectURL),e.photoModuleDom.classList.add("open")}}else{var s=t.toDataURL("image/jpeg",.8);document.getElementById("photoPreview").src=s,e.photoData.append("imgBase64",s),e.photoData.append("url",_projectURL),e.photoModuleDom.classList.add("open")}}(),setTimeout(function(){$("#b_takePhoto").css("display:inline-block")},600),document.activeElement.blur()},50)},this.savePhoto=function(){var e="xr-dot-plus-"+_projectURL+".jpg",t=document.getElementById("photoPreview").src;is.safari(_arguments)||(t=t.replace(/^data:image\/[^;]/,"data:application/octet-stream"));var a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("download",e),document.body.appendChild(a),a.click()},this.sendPhoto=function(){var e=this;document.activeElement.blur();var t=document.getElementById("photoEmail").value;if(validateEmail(t)){e.startLoading();var a=_rootDirectory+"d/take-photo.php",i=document.location.href;try{i=window.location!=window.parent.location?document.referrer:document.location.href}catch(e){console.error("catch visiturl")}var o=e.photoData;o.append("email",t),o.append("referrer",i);var s=new XMLHttpRequest;s.open("POST",a,!0),s.onload=function(){if(s.status>=200&&s.status<400){e.stopLoading(),e.closeModules();var t="Your photo has been sent";void 0!==_texts&&_texts.yourPhotoHasBeenSent&&(t=_texts.yourPhotoHasBeenSent);var a=JSON.parse(s.response);a.error&&(t="error : "+a.error),openModal(t)}else console.log("error a"),e.stopLoading(),openModal("something went wrong...")},s.onerror=function(){console.log("error b"),e.stopLoading(),openModal("something went wrong...")},s.send(o)}else openModal("Please enter a valid email")},this.sharePhoto=function(){var e=this;addToLog("share photo"),e.startLoading();var t=new Date,a=t.getFullYear(),i=1+t.getMonth();i<10&&(i="0"+i);var o=""+t.getDate()+t.getHours()+t.getMinutes()+t.getSeconds()+(10+parseInt(89*Math.random())),s=e.scene.url+"-"+o,n=""+a+i,r=n+"/"+s;addToLog(r),e.shareAPI(r);var l=_rootDirectory+"d/share-photo.php",c=e.photoData;c.append("folder",n),c.append("file",s);var d=new XMLHttpRequest;d.open("POST",l,!0),d.onload=function(){if(d.status>=200&&d.status<400){var t=JSON.parse(d.response);if(_isDebug&&console.log(t),t.error){var a="error : "+t.error;return e.stopLoading(),void openModal(a)}addToLog(t.url),setTimeout(function(){e.stopLoading()},2e3)}else console.log("error a"),e.stopLoading(),openModal("something went wrong...")},d.onerror=function(){console.log("error b"),e.stopLoading(),openModal("something went wrong...")},d.send(c)},this.shareAPI=function(e){e="https://xr.plus/photos/?p="+e;var t=this.scene.data.name+" | XR photo #webAR",a=t;navigator.share({title:a,text:t,url:e}).then(function(){console.log("shared")}).catch(function(e){console.log("share api error catch +"),console.log(e),console.log(""+e),(""+e).toLowerCase().includes("share canceled")||(""+e).toLowerCase().includes("aborterror")||openModal("Could not share, try again later <br/>"+e)})},this.animationEndEvent=function(e){var t=this.modulesData,a=e.getClip();t.states&&t.states.enabled&&this.getNextState(a)},this.loop=function(){var e=this.modulesData;if(e.gestures&&e.gestures.enabled){var t=this.gesturesHook;if(t&&e.gestures.zoom.enabled){var a=this.currentScale;t.scale.x!=a&&t.scale.set(a,a,a)}t&&e.gestures.rotation.enabled&&(t.rotation.set(0,0,0),t.rotateY(THREE.Math.degToRad(this.rotationY)))}},this.setupModules()}function checksAR(){this.ok=1,this.arguments=null,this.missing=null,this.urlAR=window.location.href,this.urlVR="",this.start=function(){if(this.arguments=this.getArguments(),"#"===this.urlAR.substr(-1)&&(this.urlAR=this.urlAR.substr(0,this.urlAR.length-1)),this.urlVR=this.urlAR.replace("xr.plus/","xr.plus/vr/"),is.ios(this.arguments)){var e=0;if(void 0!=(o=iOSversion())&&(e=o[0]),e<11){(a=document.getElementById("access"))&&a.parentElement.removeChild(a);var t="Unfortunately, <br/>augmented reality on the web requires iOS 11 or newer.<br/>";return t+="<br/>",void this.showFail(t)}if(!is.safari(this.arguments)){var a;(a=document.getElementById("access"))&&a.parentElement.removeChild(a);t="<br/>Please open this page in Safari<br/>&nbsp;";this.showFail(t);var i=document.createElement("span");i.id="helpOpenSafari",i.innerHTML="Tap here and choose<br/>'open in browser'";return void document.getElementById("fail").appendChild(i)}}if(void 0===navigator.getUserMedia&&void 0===navigator.mediaDevices&&(this.ok=0,this.missing="A"),void 0!==navigator.mediaDevices&&(void 0===navigator.mediaDevices.enumerateDevices&&(this.ok=0,this.missing="B"),void 0===navigator.mediaDevices.getUserMedia&&(this.ok=0,this.missing="C")),this.ok||addToLog("check failed "+this.missing),!is.ios(this.arguments)&&!is.android(this.arguments)&&!this.ok){t="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>";t+='<a href="'+this.urlVR+'" class="button">View the scene in 360&#186;</a>',this.showFail(t)}if(is.ios(this.arguments)&&!this.ok){t="<br/>"+this.urlAR+"<br/><br/><br/>";t+="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>",t+="Please open this page in Safari",this.showFail(t)}if(is.android(this.arguments)&&is.not.windowsPhone(this.arguments)){if(is.chrome(this.arguments)){var o;if(void 0!=(o=getChromeVersion())&&(addToLog("Chrome v "+o),o<57)){t="This version of Chrome ("+o+") is too old, <br/><br/>update it and try again.";return void this.showFail(t)}}if(is.not.chrome(this.arguments)&&is.not.firefox(this.arguments)&&(this.ok=0),!this.ok){t='Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>If you have Chrome installed, <br/><a href="#" id="chromeButton">tap here</a> <br/>to visit this page in Chrome.<br/><br/>';this.showFail(t);document.getElementById("chromeButton").onclick=function(){var e=window.location.href;"#"===e.substr(-1)&&(e=e.substr(0,e.length-1)),e="googlechrome://navigate?url="+e,document.location=e}}}},this.showFail=function(e){addToLog("show fail");var t=document.createElement("div");t.id="fail",document.body.appendChild(t);var a=document.createElement("div");a.id="message",a.innerHTML=e,t.appendChild(a);var i=document.getElementById("preloader");i&&i.parentElement.removeChild(i)},this.getArguments=function(){return arguments},this.start()}function WasmSupported(){var e=!1;try{var t=new Uint8Array([0,97,115,109,1,0,0,0,1,7,1,96,2,127,127,1,127,3,2,1,0,7,7,1,3,88,79,82,0,0,10,9,1,7,0,32,0,32,1,115,11]),a=new WebAssembly.Instance(new WebAssembly.Module(t)).exports.XOR;if(57005!==a(65280,8621)||48879!==a(43605,5306))throw!1;e=!0}catch(t){e=!1}return e}function iOSversion(){if(/iP(hone|od|ad)/.test(navigator.platform)){var e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3]||0,10)]}}function removeAccessPanel(){var e=document.getElementById("access");e&&e.parentElement.removeChild(e)}function addToLog(e){if(_isDebug){console.log(e);var t=document.getElementById("mainLog");t.innerHTML=e+"<br/>"+t.innerHTML}}function gestureChange(e){1!==(e=e.originalEvent||e).scale&&(e.preventDefault(),_body.style.transform="scale(1)")}function doChecks(){if(navigator.share||$("#b_share").css("display:none;"),_checks=new checksAR,_isDesktop&&document.getElementById("youtubeIframeWrapper")&&(document.getElementById("youtubeIframeWrapper").innerHTML='<iframe width="711" height="400" src="https://www.youtube.com/embed/HCI3-NJR1kQ?rel=0" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>'),1==_checks.ok)if(!_isDesktop||_skipDesktopAR||_isDebug||"https://xr.plus/"!=_rootDirectory)loadSceneData();else{var e=document.getElementById("preloader");e&&e.parentElement.removeChild(e),$("#desktop").css("backgroundImage: url('"+_rootDirectory+"assets/bg-ar-desktop.jpg');display:block"),$("#desktop .url").html(_visitUrl),$("#access").css("display:none;"),$("#b_continueOnDesktop").on(_clickOrTouch,function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getMedia({video:!0},function(){$("#desktop").css("display:none;"),loadSceneData()},function(){$("#desktop").css("display:none;"),$("#noAccess").css("display:block;"),$("#noCamera").css("display:block;"),$("#yesCamera").css("display:none;")})}),$("#logo").on(_clickOrTouch,function(){document.getElementById("desktop")&&"block"==document.getElementById("desktop").style.display&&(top.location=_rootDirectory)})}}function loadSceneData(){addToLog("loadSceneData");var e=document.getElementById("desktop");e&&e.parentElement.removeChild(e);var t=encodeURIComponent(document.referrer),a=_rootDirectory+"d/get-scene-front.php?url="+_projectURL+"&r="+t+"&ar";_isDebug&&(a+="&d");var i=new XMLHttpRequest;i.open("GET",a,!0),i.onload=function(){if(i.status>=200&&i.status<400){var e=JSON.parse(i.responseText);if(e.error)return void alert("error : "+e.error);dataSceneLoaded(e)}else console.log("error a")},i.onerror=function(){console.log("error b")},i.send()}function dataSceneLoaded(e){(_mainData=e).settings.bundle&&(_isBundle=!0);var t=e.scenesData,a=e.brandingSettings;a&&a.texts&&($("[data-text='loadingTheMagic']").text(a.texts.loading),a.texts.allowAccess&&$("[data-text='allowAccess']").text(a.texts.allowAccess),a.texts.help&&$("[data-text='help']").text(a.texts.help),a.texts.direct&&$("[data-text='direct']").text(a.texts.direct)),t.length>1&&$("body").addClass("collection");var i=!1;if(e.settings.multiScene&&e.settings.multiScene.multiMarkers&&1==e.settings.multiScene.multiMarkers&&(i=!0),e.settings.bundle&&"multiple"==e.settings.tracking.type&&(i=!0),!i&&t.length>1){var o=document.getElementById("sceneSelector");$("body").addClass("sceneSelector");var s=document.createElement("ul");o.appendChild(s);var n,r,l;for(n=0;n<t.length;n++)l=_rootDirectory+"s/"+t[n].folder+"/"+t[n].url+"/"+t[n].preview,(r=document.createElement("li")).setAttribute("data-index",n),r.innerHTML='<img class="preview" src="'+l+'" alt=""/>',s.appendChild(r),r.addEventListener(_clickOrTouch,function(){var e=this.getAttribute("data-index");_xr.selectScene(e),$("#sceneSelector li").attr("class",""),this.className="active"});$("#sceneSelector li").eq(0).attr("class","active")}startAR(0,e)}function startAR(e,t){addToLog("D: startAR "+e+" / "+t.scenesData.length),_isDebug&&console.log(t.scenesData);var a=0;t.settings.slam&&(a=t.settings.slam.enabled),t.settings.bundle&&"slam"==t.settings.tracking.type&&(a=1),a&&checkGyro(e,t),a||_isNFT||((_xr=new ar(t)).setNewData(e),_xr.initScene3()),!a&&_isNFT&&((_xr=new ar(t)).setNewData(e),_xr.initScene3()),$("#logo").on(_clickOrTouch,function(){clickOnlogo()})}function checkGyro(e,t){if(_isIOS){if("safari"==_browser.name&&_browser.version>=13)return addToLog("_needDeviceOrientationPermission"),_needDeviceOrientationPermission=!0,void gyroCheckSuccess(e,t);var a=function(){clearTimeout(i),window.removeEventListener("deviceorientation",a),gyroCheckSuccess(e,t)},i=setTimeout(function(){openModal("Turn on your motion sensors\n\nEnable device orientation in \nSettings > Safari \n> Motion & Orientation Access"),$("#preloader").css("display:none;"),$("#alertModal .button.ok").on(_clickOrTouch,function(){window.removeEventListener("deviceorientation",a),checkGyro(e,t)})},500);window.addEventListener("deviceorientation",a)}else gyroCheckSuccess(e,t)}function gyroCheckSuccess(e,t){(_xr=new slam(t)).setNewData(e),_xr.initScene3()}function clickOnlogo(){var e=_xr.activeScene.data,t=[],a=e.settings.logoMenu;a&&(t=a.moreButtons),e.branding&&e.branding.more&&(a=e.branding.more,t=e.branding.more.buttons);e.name,e.shortDescription;if(a&&t&&t.length>0){var i,o=0;for($("#redirection").css("display:block;"),$("#redirection>div").html(""),o=0;o<t.length;o++)""!=t[o].url&&void 0!=t[o].url&&(i="",t[o].textParagraph&&(i+="<p>"+t[o].textParagraph+"</p>"),i+='<p><a class="button" href="'+t[o].url+'" target="_top">'+t[o].textButton+"</a></p>",$("#redirection>div").insertLast(i)),t[o].textParagraph&&!t[o].url&&(i="",t[o].textParagraph&&(i+="<p>"+t[o].textParagraph+"</p>"),$("#redirection>div").insertLast(i))}"block"!=document.getElementById("more").style.display?$("#more").css("display:block;"):$("#more").css("display:none;")}function shareScene(){addToLog("share scene"),console.log(_xr.activeScene);_xr.activeScene;var e=_visitUrl,t=_shareText,a=_shareTitle;navigator.share({title:t,text:a,url:e}).then(function(){console.log("shared")}).catch(function(e){console.log("share api error catch +"),console.log(e),console.log(""+e),(""+e).toLowerCase().includes("share canceled")||(""+e).toLowerCase().includes("aborterror")||openModal("Could not share, try again later <br/>"+e)})}function startFid(){var e=0;if(WasmSupported())setTimeout(function(){if(!e){_body.innerHTML="",_xr=null;openModal("Your device is low on memory\n\nClose your browser, reopen it and try again..."),$("#alertModal .button").css("display:none")}},15e3),window.addEventListener("artoolkit-loaded",function(){e=1,doChecks()});else{addToLog("wasm not supported");new checksAR}}function startSlam(){doChecks()}function startNFT(){if(WasmSupported())doChecks();else{addToLog("wasm not supported");new checksAR}}function startAny(){if(_isDesktop&&!_desktopEnabled){var e=document.getElementById("preloader");e&&e.parentElement.removeChild(e),$("#desktop").css("backgroundImage: url('"+_rootDirectory+"assets/bg-ar-desktop.jpg');display:block"),$("#access").css("display:none;");var t=document.createElement("script");return t.onload=function(){if($("#desktop .url").text(_visitUrl),document.getElementById("qrcode"))new QRCode(document.getElementById("qrcode"),{text:_visitUrl,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.L})},t.src=_rootDirectory+"js/qrcode.min.js",void document.head.appendChild(t)}if(_isNFT)startNFT();else{_body.classList.contains("slam")?startSlam():startFid()}}var _texts={},la=_language.substring(0,2);"fr"==la&&(_texts={betterOnMobile:"La réalité augmentée, c'est mieux sur téléphone",visitOnMobile:"Avec le navigateur internet de votre téléphone, visitez ",continueAnyway:"Continuer sur cet écran",print:"Imprimer le motif R.A.",allowAccess:"Veuillez autoriser l'accès à la caméra",noAccess:"pas d'accès à la caméra",yesCamera:"L'accès à votre caméra est necéssaire",noCamera:"Il semble que votre appareil n'a pas de caméra connectée",tryAgain:"réessayer",displayThePattern:"afficher le motif R.A.",loadingTheMagic:"Chargement",direct:"Pointez la caméra vers ce motif",directMultiple:"Pointez la caméra vers ces motifs",onAnother:"Avec un autre téléphone ou un ordinateur, visitez "+_domainMin+"/p pour afficher le motif R.A.",visitThisLink:"Visitez ce lien avec le navigateur internet de votre téléphone \net dirigez la caméra ici.",flat:"à plat",vertical:"vertical",by:"par",start:"démarrer",discoverMoreOnTheHome:"Découvrez d'autres scènes sur la page d'accueil",discoverMore:"Découvrir d'autres scènes",joinTheCommunityTop:"Rejoignez la communauté et publiez vos modèles 3D",joinTheCommunity:"Rejoignez la communauté et publiez vos modèles 3D",joinNow:"Rejoindre la communauté",help:"aide",shareThePhotoByEmail:"Envoyer la photo via email",yourPhotoHasBeenSent:"La photo a été envoyée"}),"pl"==la&&(_texts={betterOnMobile:"Rozszerzona rzeczwistość jest lepsza na urządzeniach mobilnych",visitOnMobile:"Odwiedź na swoim telefonie: ",continueAnyway:"kontynuuj mimo to",print:"Wydrukuj wzór AR",allowAccess:"Zezwól na dostęp do kamery",noAccess:"Brak dostępu do kamery",yesCamera:"Dostęp do kamery urządzenia jest niezbędny, jeśli chcesz doświadczyć rozszerzonej rzeczywistości",noCamera:"Przepraszamy, nie wykryto kamery. Podłącz kamerę i spróbuj ponownie.",tryAgain:"spróbuj ponownie",displayThePattern:"wyświetl wzór AR",loadingTheMagic:"Ładowanie",direct:"Skieruj kamerę na ten wzór",directMultiple:"Skieruj kamerę na ten wzór",onAnother:"Żeby wyświetlić wzór AR, odwiedź "+_domainMin+"/p na innym telefonie lub komputerze",visitThisLink:"Otwórz link w przeglądarce na telefonie \ni skieruj kamerę tutaj.",flat:"płaski",vertical:"pionowy",by:"by",start:"start",discoverMoreOnTheHome:"Odkryj więcej",discoverMore:"Odkryj więcej",joinTheCommunityTop:"Dołącz do społeczności i dodaj swoje modele 3D!",joinTheCommunity:"Dołącz do społeczności i dodaj swoje modele",joinNow:"Dołącz teraz",help:"pomoc"}),"es"==la&&(_texts={betterOnMobile:"La Realidad Aumentada es mejor en móviles",visitOnMobile:"En el navegador web de tu móvil, visita ",continueAnyway:"continuar de todas maneras",print:"Imprimir el patrón RA",allowAccess:"Por favor, permite acceder a la cámara",noAccess:"No hay acceso a la cámara",yesCamera:"Acceso a la cámara de tu dispositivo es requerido para las experiencias de Realidad Aumentada",noCamera:"Lo sentimos, pero parece ser que no cuentas con una cámara. Instala una cámara e intenta de nuevo",tryAgain:"Intentar de nuevo",displayThePattern:"Desplegar el patrón RA",loadingTheMagic:"Cargando",direct:"Dirige la cámara hacia este patrón",directMultiple:"Dirige la cámara hacia estos patrones",onAnother:"En otro móvil o en una computadora, visita "+_domainMin+"/p para desplegar el patrón de RA",visitThisLink:"Visita esta liga con el navegador de tu móvil y apunta la cámara aquí.",flat:"Plano",vertical:"Vertical",by:"by",start:"start",discoverMoreOnTheHome:"Decubre más en la página de inicio",discoverMore:"Descubre más",joinTheCommunityTop:"Únete a la comunidad y sube tus modelos 3D",joinTheCommunity:"Únete a la comunidad y sube tus modelos 3D",joinNow:"Únete a la comunidad",help:"Ayuda",shareThePhotoByEmail:"Comparte la foto por correo electrónico",yourPhotoHasBeenSent:"La foto ha sido enviada"}),"ru"==la&&(_texts={betterOnMobile:"Дополненная реальность лучше выглядит на телефоне",visitOnMobile:"Открой на телефоне: ",continueAnyway:"все равно продолжить",print:"Распечатай пример AR",allowAccess:"Разреши доступ к камере",noAccess:"Камера недоступна",yesCamera:"Чтобы испытать дополнительную реальность нужен доступ к камере",noCamera:"К сожалению камера не найдена. Подключи камеру и попробуй снова",tryAgain:"попробуй снова",displayThePattern:"отобразить шаблон AR",loadingTheMagic:"Загрузка",direct:"Наведи камеру на шаблон",directMultiple:"Направь камеру на шаблон",onAnother:"Чтобы отобразить шаблон AR, открой "+_domainMin+"/p на другом телефоне или компьютере",visitThisLink:"Открой ссылку в браузере телефона \nи наведи камеру сюда.",flat:"горизонт.",vertical:"вертикал.",by:"by",start:"start",discoverMoreOnTheHome:"Еще больше на главной странице",discoverMore:"Открой больше",joinTheCommunityTop:"Присоединайся к сообществу и добавь свои 3D модели!",joinTheCommunity:"Присоединайся к сообществу и добавь свои модели",joinNow:"Присоединяйся уже сейчас",help:"Помощь"}),"ua"==la&&(_texts={betterOnMobile:"Доповнена реальність виглядає краще на телефоні",visitOnMobile:"Відкрий на телефоні: ",continueAnyway:"все одно продовжити",print:"Роздрукуй шаблон AR",allowAccess:"Дозволь доступ до камери",noAccess:"Камера недоступна",yesCamera:"Щоб випробувати доповнену реальність необхідний доступ до камери",noCamera:"Нажаль камера не знайдена. Підключи камеру і спробуй знову",tryAgain:"спробуй знову",displayThePattern:"показати шаблон AR",loadingTheMagic:"Завантаження",direct:"Спрямуй камеру на цей шаблон.",directMultiple:"Спрямуй камеру на цей шаблон",onAnother:"Щоб відобразити шаблон, відвідай "+_domainMin+"/p на іншому телефоні або комп'ютері",visitThisLink:"Відкрий лінк в браузері телефону \nі спрямуй камеру сюди.",flat:"горизонт.",vertical:"вертикал.",by:"by",start:"start",discoverMoreOnTheHome:"Ще більше на головній сторінці",discoverMore:"Відкрий більше",joinTheCommunityTop:"Присоединяйся к сообществу и добавь свои 3D модели!",joinTheCommunity:"Присоединяйся к сообществу и добавь свои модели",joinNow:"Приєднуйся вже зараз",help:"Допомога"});var k;for(k in _texts)setText(k,_texts[k]);var _clickOrTouch="ontouchend"in window?"touchend":"click",nano=function(e){return this.value=Array.prototype.slice.call(document.querySelectorAll(e)),this};nano.prototype={eq:function(e){return this.value=[this.value[e]],this},each:function(e){return[].forEach.call(this.value,e),this},css:function(e){return this.each(function(t){t.style.cssText=t.style.cssText+e})},cssdom:function(e){return this.each(function(t){for(var a in e)t.style[a]=e[a]})},attr:function(e,t){return this.each(function(a){a.setAttribute(e,t)})},getAttr:function(e){return this.value[0].getAttribute(e)},removeAttr:function(e){return this.each(function(t){t.removeAttribute(e)})},animate:function(e,t,a,i,o,s,n,r,l,c){return this.each(function(d){d.style.cssText=d.style.cssText+"transition: all "+e+"s ease-in-out; transform: scale("+t+") rotate("+a+"deg) rotateX("+i+"deg) rotateY("+o+"deg) translate("+s+"px, "+n+"px) skew("+r+"deg, "+l+"deg); opacity:"+c+";)"})},on:function(e,t){return this.each(function(a){a.addEventListener(e,t,!1)})},addClass:function(e){return this.each(function(t){t.classList?t.classList.add(e):t.className+=" "+e})},toggleClass:function(e){return this.each(function(t){t.classList.toggle(e)})},removeClass:function(e){return this.each(function(t){t.classList.remove(e)})},html:function(e){return this.each(function(t){t.innerHTML=e})},text:function(e){return this.each(function(t){t.innerText=e})},insertBefore:function(e){return this.each(function(t){t.insertAdjacentHTML("beforeBegin",e)})},insertAfter:function(e){return this.each(function(t){t.insertAdjacentHTML("afterEnd",e)})},insertFirst:function(e){return this.each(function(t){t.insertAdjacentHTML("afterBegin",e)})},insertLast:function(e){return this.each(function(t){t.insertAdjacentHTML("beforeEnd",e)})},empty:function(){return this.each(function(e){e.innerHTML=""})},offset:function(){return this.each(function(e){offset=e.getBoundingClientRect()})}};var $=function(e){return new nano(e)},jsfeat=jsfeat||{REVISION:"ALPHA"};!function(e){var t=256,a=512,i=1024,o=new Int32Array([-1,1,4,-1,4,-1,-1,-1,8,-1,-1,-1,-1,-1,-1,-1,8]),s=function(e){return 65280&e},n=function(e){return 255&e},r=function(e){return o[(65280&e)>>8]},l=function(){return function(e,t){this.size=-8&(e+7|0),void 0===t?this.buffer=new ArrayBuffer(this.size):(this.buffer=t,this.size=t.length),this.u8=new Uint8Array(this.buffer),this.i32=new Int32Array(this.buffer),this.f32=new Float32Array(this.buffer),this.f64=new Float64Array(this.buffer)}}(),c=function(){function e(e,o,r,l){this.type=0|s(r),this.channel=0|n(r),this.cols=0|e,this.rows=0|o,void 0===l?this.allocate():(this.buffer=l,this.data=this.type&t?this.buffer.u8:this.type&a?this.buffer.i32:this.type&i?this.buffer.f32:this.buffer.f64)}return e.prototype.allocate=function(){delete this.data,delete this.buffer,this.buffer=new l(this.cols*r(this.type)*this.channel*this.rows),this.data=this.type&t?this.buffer.u8:this.type&a?this.buffer.i32:this.type&i?this.buffer.f32:this.buffer.f64},e.prototype.copy_to=function(e){for(var t=e.data,a=this.data,i=0,o=this.cols*this.rows*this.channel|0;i<o-4;i+=4)t[i]=a[i],t[i+1]=a[i+1],t[i+2]=a[i+2],t[i+3]=a[i+3];for(;i<o;++i)t[i]=a[i]},e.prototype.resize=function(e,t,a){void 0===a&&(a=this.channel);e*r(this.type)*a*t>this.buffer.size?(this.cols=e,this.rows=t,this.channel=a,this.allocate()):(this.cols=e,this.rows=t,this.channel=a)},e}(),d=function(){function e(e){this.levels=0|e,this.data=new Array(e),this.pyrdown=jsfeat.imgproc.pyrdown}return e.prototype.allocate=function(e,t,a){for(var i=this.levels;--i>=0;)this.data[i]=new c(e>>i,t>>i,a)},e.prototype.build=function(e,t){void 0===t&&(t=!0);var a=2,i=e,o=this.data[0];if(!t)for(var s=e.cols*e.rows;--s>=0;)o.data[s]=e.data[s];for(o=this.data[1],this.pyrdown(i,o);a<this.levels;++a)i=o,o=this.data[a],this.pyrdown(i,o)},e}(),h=function(){return function(e,t,a,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===o&&(o=-1),this.x=e,this.y=t,this.score=a,this.level=i,this.angle=o}}();e.U8_t=t,e.S32_t=a,e.F32_t=i,e.S64_t=2048,e.F64_t=4096,e.C1_t=1,e.C2_t=2,e.C3_t=3,e.C4_t=4,e.U8C1_t=1|t,e.U8C3_t=3|t,e.U8C4_t=4|t,e.F32C1_t=1|i,e.F32C2_t=2|i,e.S32C1_t=1|a,e.S32C2_t=2|a,e.EPSILON=1.192092896e-7,e.FLT_MIN=1e-37,e.COLOR_RGBA2GRAY=0,e.COLOR_RGB2GRAY=1,e.COLOR_BGRA2GRAY=2,e.COLOR_BGR2GRAY=3,e.BOX_BLUR_NOSCALE=1,e.SVD_U_T=1,e.SVD_V_T=2,e.get_data_type=s,e.get_channel=n,e.get_data_type_size=r,e.data_t=l,e.matrix_t=c,e.pyramid_t=d,e.keypoint_t=h}(jsfeat),function(e){var t=function(){var e,t,a=function(){function e(e){this.next=null,this.data=new jsfeat.data_t(e),this.size=this.data.size,this.buffer=this.data.buffer,this.u8=this.data.u8,this.i32=this.data.i32,this.f32=this.data.f32,this.f64=this.data.f64}return e.prototype.resize=function(e){delete this.data,this.data=new jsfeat.data_t(e),this.size=this.data.size,this.buffer=this.data.buffer,this.u8=this.data.u8,this.i32=this.data.i32,this.f32=this.data.f32,this.f64=this.data.f64},e}(),i=0;return{allocate:function(o,s){e=t=new a(s);for(var n=0;n<o;++n){var r=new a(s);t=t.next=r,i++}},get_buffer:function(t){var a=e;return e=e.next,i--,t>a.size&&a.resize(t),a},put_buffer:function(e){t=t.next=e,i++}}}();e.cache=t,t.allocate(30,2560)}(jsfeat),function(e){var t=function(){var e=new Int32Array(96);return{get_gaussian_kernel:function(e,t,a,i){var o=0,s=0,n=0,r=0,l=0,c=0,d=jsfeat.cache.get_buffer(e<<2),h=d.f32;if(1==(1&e)&&e<=7&&t<=0)switch(e>>1){case 0:h[0]=1,c=1;break;case 1:h[0]=.25,h[1]=.5,h[2]=.25,c=1;break;case 2:h[0]=.0625,h[1]=.25,h[2]=.375,h[3]=.25,h[4]=.0625,c=1;break;case 3:h[0]=.03125,h[1]=.109375,h[2]=.21875,h[3]=.28125,h[4]=.21875,h[5]=.109375,h[6]=.03125,c=1}else for(l=-.5/((r=t>0?t:.3*(.5*(e-1)-1)+.8)*r);o<e;++o)s=o-.5*(e-1),n=Math.exp(l*s*s),h[o]=n,c+=n;if(i&jsfeat.U8_t)for(c=256/c,o=0;o<e;++o)a[o]=h[o]*c+.5|0;else for(c=1/c,o=0;o<e;++o)a[o]=h[o]*c;jsfeat.cache.put_buffer(d)},perspective_4point_transform:function(e,t,a,i,o,s,n,r,l,c,d,h,u,f,m,p,v){var g=t,b=c,y=n,_=g*b*y,x=m,M=g*x,w=b*M,E=d,T=g*E,S=s,k=a,A=f,L=k*A,R=L*S,j=A*S*E,D=A*y,C=A*E,I=b*y,P=x*b,z=x*S,H=E*S,V=1/(D-C-I+P-z+H),O=g*A,B=k*S,F=y*g,N=x*F,$=k*b,q=L*E,U=k*E*S,W=y*x*b,G=x*k,Z=-(w-_+T*S-S*M-L*b+R-j+D*b)*V,X=(_-w-O*y+O*E+R-b*B+z*b-j)*V,Y=g,J=(-E*M+N+$*y-L*y+q-U+z*E-W)*V,Q=(F*E-N-G*b+q-U+G*S+W-D*E)*V,K=k,ee=(-T+F+$-B+C-D-P+z)*V,te=(-M+T+L-$+z-H-D+I)*V,ae=-((w=(b=h)*(M=(g=i)*(x=v)))-(_=g*b*(y=l))+(T=g*(E=u))*(S=r)-S*M-(L=(k=o)*(A=p))*b+(R=L*S)-(j=A*S*E)+(D=A*y)*b)*(V=1/(D-(C=A*E)-(I=b*y)+(P=x*b)-(z=x*S)+(H=E*S))),ie=(_-w-(O=g*A)*y+O*E+R-b*(B=k*S)+z*b-j)*V,oe=g,se=(-E*M+(N=x*(F=y*g))+($=k*b)*y-L*y+(q=L*E)-(U=k*E*S)+z*E-(W=y*x*b))*V,ne=(F*E-N-(G=x*k)*b+q-U+G*S+W-D*E)*V,re=k,le=(-T+F+$-B+C-D-P+z)*V,ce=(-M+T+L-$+z-H-D+I)*V,de=Y*ee;R=K*ee-J;var he=-J*te+Q*ee,ue=Z-de;B=Z*te-(T=X*ee);var fe=(_=Z*K)-(w=Y*J),me=(y=Z*Q)-(M=J*X);U=(b=Q-te*K)*(A=1/(y-_*te-M+w*te+T*K-de*Q));var pe=(H=Y*te-X)*A,ve=(F=-X*K+Y*Q)*A,ge=e.data;ge[0]=ae*U+ie*(R*A)-oe*(he*A),ge[1]=ae*pe+ie*(ue*A)-oe*(B*A),ge[2]=-ae*ve-ie*(fe*A)+oe*(me*A),ge[3]=se*U+ne*(R*A)-re*(he*A),ge[4]=se*pe+ne*(ue*A)-re*(B*A),ge[5]=-se*ve-ne*(fe*A)+re*(me*A),ge[6]=le*U+ce*(R*A)-he*A,ge[7]=le*pe+ce*(ue*A)-B*A,ge[8]=-le*ve-ce*(fe*A)+me*A},qsort:function(t,a,i,o){var s,n,r,l,c=0,d=0,h=0,u=0,f=0,m=0,p=0,v=0,g=0,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0,k=e;if(!(i-a+1<=1))for(k[0]=a,k[1]=i;c>=0;)for(d=k[c<<1],h=k[1+(c<<1)],c--;;){if((f=h-d+1)<=7){for(p=d+1;p<=h;p++)for(v=p;v>d&&o(t[v],t[v-1]);v--)s=t[v],t[v]=t[v-1],t[v-1]=s;break}for(S=0,b=d,_=h,M=d+(f>>1),f>40&&(E=d+(g=f>>3),T=d+(g<<1),n=t[w=d],r=t[E],l=t[T],d=o(n,r)?o(r,l)?E:o(n,l)?T:w:o(l,r)?E:o(n,l)?w:T,E=M,T=M+g,n=t[w=M-g],r=t[E],l=t[T],M=o(n,r)?o(r,l)?E:o(n,l)?T:w:o(l,r)?E:o(n,l)?w:T,E=h-g,T=h,n=t[w=h-(g<<1)],r=t[E],l=t[T],h=o(n,r)?o(r,l)?E:o(n,l)?T:w:o(l,r)?E:o(n,l)?w:T),E=M,T=h,n=t[w=d],r=t[E],l=t[T],(M=o(n,r)?o(r,l)?E:o(n,l)?T:w:o(l,r)?E:o(n,l)?w:T)!=b&&(s=t[M],t[M]=t[b],t[b]=s,M=b),d=y=b+1,h=x=_,n=t[M];;){for(;d<=h&&!o(n,t[d]);)o(t[d],n)||(d>y&&(s=t[y],t[y]=t[d],t[d]=s),S=1,y++),d++;for(;d<=h&&!o(t[h],n);)o(n,t[h])||(h<x&&(s=t[x],t[x]=t[h],t[h]=s),S=1,x--),h--;if(d>h)break;s=t[d],t[d]=t[h],t[h]=s,S=1,d++,h--}if(0==S){for(h=_,p=(d=b)+1;p<=h;p++)for(v=p;v>d&&o(t[v],t[v-1]);v--)s=t[v],t[v]=t[v-1],t[v-1]=s;break}for(m=d-(f=Math.min(y-b,d-y))|0,u=0;u<f;++u,++m)s=t[b+u],t[b+u]=t[m],t[m]=s;for(m=_-(f=Math.min(_-x,x-h))+1|0,u=0;u<f;++u,++m)s=t[d+u],t[d+u]=t[m],t[m]=s;if(f=d-y,m=x-h,f>1)m>1?f>m?(k[++c<<1]=b,k[1+(c<<1)]=b+f-1,d=_-m+1,h=_):(k[++c<<1]=_-m+1,k[1+(c<<1)]=_,d=b,h=b+f-1):(d=b,h=b+f-1);else{if(!(m>1))break;d=_-m+1,h=_}}},median:function(e,t,a){for(var i,o=0,s=0,n=0,r=t+a>>1;;){if(a<=t)return e[r];if(a==t+1)return e[t]>e[a]&&(i=e[t],e[t]=e[a],e[a]=i),e[r];for(e[o=t+a>>1]>e[a]&&(i=e[o],e[o]=e[a],e[a]=i),e[t]>e[a]&&(i=e[t],e[t]=e[a],e[a]=i),e[o]>e[t]&&(i=e[o],e[o]=e[t],e[t]=i),s=t+1,i=e[o],e[o]=e[s],e[s]=i,n=a;;){do{++s}while(e[t]>e[s]);do{--n}while(e[n]>e[t]);if(n<s)break;i=e[s],e[s]=e[n],e[n]=i}i=e[t],e[t]=e[n],e[n]=i,n<=r?t=s:n>=r&&(a=n-1)}return 0}}}();e.math=t}(jsfeat),function(){var e={identity:function(e,t){void 0===t&&(t=1);for(var a=e.data,i=e.rows,o=e.cols,s=o+1|0,n=i*o,r=n;--n>=0;)a[n]=0;for(n=r,r=0;r<n;)a[r]=t,r+=s},transpose:function(e,t){for(var a=0,i=0,o=t.rows,s=t.cols,n=0,r=0,l=0,c=t.data,d=e.data;a<o;r+=1,n+=s,a++)for(l=r,i=0;i<s;l+=o,i++)d[l]=c[n+i]},multiply:function(e,t,a){for(var i=0,o=0,s=0,n=0,r=0,l=0,c=0,d=0,h=t.cols,u=t.rows,f=a.cols,m=t.data,p=a.data,v=e.data,g=0;i<u;n+=h,i++)for(c=0,o=0;o<f;d++,c++,o++){for(l=c,r=n,g=0,s=0;s<h;r++,l+=f,s++)g+=m[r]*p[l];v[d]=g}},multiply_ABt:function(e,t,a){for(var i=0,o=0,s=0,n=0,r=0,l=0,c=0,d=t.cols,h=t.rows,u=a.rows,f=t.data,m=a.data,p=e.data,v=0;i<h;n+=d,i++)for(l=0,o=0;o<u;c++,o++){for(r=n,v=0,s=0;s<d;r++,l++,s++)v+=f[r]*m[l];p[c]=v}},multiply_AtB:function(e,t,a){for(var i=0,o=0,s=0,n=0,r=0,l=0,c=0,d=0,h=t.cols,u=t.rows,f=a.cols,m=t.data,p=a.data,v=e.data,g=0;i<h;n++,i++)for(c=0,o=0;o<f;d++,c++,o++){for(l=c,r=n,g=0,s=0;s<u;r+=h,l+=f,s++)g+=m[r]*p[l];v[d]=g}},multiply_AAt:function(e,t){for(var a=0,i=0,o=0,s=0,n=0,r=0,l=0,c=0,d=0,h=t.cols,u=t.rows,f=t.data,m=e.data,p=0;a<u;s+=u+1,n=r,a++)for(c=s,d=s,l=n,i=a;i<u;c++,d+=u,i++){for(r=n,p=0,o=0;o<h;o++)p+=f[r++]*f[l++];m[c]=p,m[d]=p}},multiply_AtA:function(e,t){for(var a=0,i=0,o=0,s=0,n=0,r=0,l=0,c=0,d=0,h=t.cols,u=t.rows,f=t.data,m=e.data,p=0;a<h;l+=h,a++)for(s=a,c=d=l+a,i=a;i<h;c++,d+=h,i++){for(n=s,r=i,p=0,o=0;o<u;n+=h,r+=h,o++)p+=f[n]*f[r];m[c]=p,m[d]=p}},identity_3x3:function(e,t){void 0===t&&(t=1);var a=e.data;a[0]=a[4]=a[8]=t,a[1]=a[2]=a[3]=0,a[5]=a[6]=a[7]=0},invert_3x3:function(e,t){var a=e.data,i=t.data,o=a[4],s=a[8],n=a[5],r=a[7],l=a[0],c=l*o,d=l*n,h=a[3],u=a[1],f=h*u,m=a[2],p=h*m,v=a[6],g=v*u,b=v*m,y=1/(c*s-d*r-f*s+p*r+g*n-b*o);i[0]=(o*s-n*r)*y,i[1]=-(u*s-m*r)*y,i[2]=-(-u*n+m*o)*y,i[3]=-(h*s-n*v)*y,i[4]=(l*s-b)*y,i[5]=-(d-p)*y,i[6]=-(-h*r+o*v)*y,i[7]=-(l*r-g)*y,i[8]=(c-f)*y},multiply_3x3:function(e,t,a){var i=e.data,o=t.data,s=a.data,n=o[0],r=o[1],l=o[2],c=o[3],d=o[4],h=o[5],u=o[6],f=o[7],m=o[8],p=s[0],v=s[1],g=s[2],b=s[3],y=s[4],_=s[5],x=s[6],M=s[7],w=s[8];i[0]=n*p+r*b+l*x,i[1]=n*v+r*y+l*M,i[2]=n*g+r*_+l*w,i[3]=c*p+d*b+h*x,i[4]=c*v+d*y+h*M,i[5]=c*g+d*_+h*w,i[6]=u*p+f*b+m*x,i[7]=u*v+f*y+m*M,i[8]=u*g+f*_+m*w},mat3x3_determinant:function(e){var t=e.data;return t[0]*t[4]*t[8]-t[0]*t[5]*t[7]-t[3]*t[1]*t[8]+t[3]*t[2]*t[7]+t[6]*t[1]*t[5]-t[6]*t[2]*t[4]},determinant_3x3:function(e,t,a,i,o,s,n,r,l){return e*o*l-e*s*r-i*t*l+i*a*r+n*t*s-n*a*o}};jsfeat.matmath=e}(),function(e){var t=function(){var e=function(e,t,a,i){i=e[t],e[t]=e[a],e[a]=i},t=function(e,t){return e=Math.abs(e),t=Math.abs(t),e>t?(t/=e,e*Math.sqrt(1+t*t)):t>0?(e/=t,t*Math.sqrt(1+e*e)):0};return{lu_solve:function(t,a){var i,o,s,n=0,r=0,l=0,c=1,d=t.cols,h=t.data,u=a.data;for(n=0;n<d;n++){for(l=n,r=n+1;r<d;r++)Math.abs(h[r*d+n])>Math.abs(h[l*d+n])&&(l=r);if(Math.abs(h[l*d+n])<jsfeat.EPSILON)return 0;if(l!=n){for(r=n;r<d;r++)e(h,n*d+r,l*d+r,void 0);e(u,n,l,void 0),c=-c}for(o=-1/h[n*d+n],r=n+1;r<d;r++){for(i=h[r*d+n]*o,l=n+1;l<d;l++)h[r*d+l]+=i*h[n*d+l];u[r]+=i*u[n]}h[n*d+n]=-o}for(n=d-1;n>=0;n--){for(s=u[n],l=n+1;l<d;l++)s-=h[n*d+l]*u[l];u[n]=s*h[n*d+n]}return 1},cholesky_solve:function(e,t){var a,i,o=0,s=0,n=0,r=0,l=0,c=0,d=0,h=e.cols,u=e.data,f=t.data;for(o=0;o<h;o++)for(i=1,l=r=o*h,s=o;s<h;s++){for(a=u[l+o],n=0;n<o;n++)a-=u[n*h+o]*u[l+n];if(s==o){if(u[l+o]=a,0==a)return 0;i=1/a}else u[r+s]=a,u[l+o]=a*i;l+=h}for(r=0,c=0;c<h;c++){for(a=f[c],d=0;d<c;d++)a-=u[r+d]*f[d];f[c]=a,r+=h}for(r=0,c=0;c<h;c++)f[c]/=u[r+c],r+=h;for(c=h-1;c>=0;c--){for(a=f[c],r=(d=c+1)*h;d<h;d++)a-=u[r+c]*f[d],r+=h;f[c]=a}return 1},svd_decompose:function(a,i,o,s,n){void 0===n&&(n=0);var r=0,l=0,c=a.rows,d=a.cols,h=c,u=d,f=a.type|jsfeat.C1_t;h<u&&(r=1,l=h,h=u,u=l);var m=jsfeat.cache.get_buffer(h*h<<3),p=jsfeat.cache.get_buffer(u<<3),v=jsfeat.cache.get_buffer(u*u<<3),g=new jsfeat.matrix_t(h,h,f,m.data),b=new jsfeat.matrix_t(1,u,f,p.data),y=new jsfeat.matrix_t(u,u,f,v.data);if(0==r)jsfeat.matmath.transpose(g,a);else{for(l=0;l<d*c;l++)g.data[l]=a.data[l];for(;l<u*h;l++)g.data[l]=0}if(function(a,i,o,s,n,r,l,c){for(var d=2*jsfeat.EPSILON,h=jsfeat.FLT_MIN,u=0,f=0,m=0,p=0,v=Math.max(r,30),g=0,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0,k=0,A=0,L=0,R=0,j=0,D=0,C=0,I=4660,P=0,z=0,H=0,V=jsfeat.cache.get_buffer(l<<3),O=V.f64;u<l;u++){for(m=0,k=0;m<r;m++)k+=(E=a[u*i+m])*E;if(O[u]=k,s){for(m=0;m<l;m++)s[u*n+m]=0;s[u*n+u]=1}}for(;p<v;p++){for(x=0,u=0;u<l-1;u++)for(f=u+1;f<l;f++){for(g=u*i|0,b=f*i|0,j=O[u],D=0,C=O[f],m=2,D+=a[g]*a[b],D+=a[g+1]*a[b+1];m<r;m++)D+=a[g+m]*a[b+m];if(!(Math.abs(D)<=d*Math.sqrt(j*C))){for(L=t(D*=2,A=j-C),A<0?(R=.5*(L-A),M=D/(L*(w=Math.sqrt(R/L))*2)):w=D/(L*(M=Math.sqrt((L+A)/(2*L)))*2),j=0,C=0,m=2,T=M*a[g]+w*a[b],S=-w*a[g]+M*a[b],a[g]=T,a[b]=S,j+=T*T,C+=S*S,T=M*a[g+1]+w*a[b+1],S=-w*a[g+1]+M*a[b+1],a[g+1]=T,a[b+1]=S,j+=T*T,C+=S*S;m<r;m++)T=M*a[g+m]+w*a[b+m],S=-w*a[g+m]+M*a[b+m],a[g+m]=T,a[b+m]=S,j+=T*T,C+=S*S;if(O[u]=j,O[f]=C,x=1,s)for(_=f*n|0,m=2,T=M*s[y=u*n|0]+w*s[_],S=-w*s[y]+M*s[_],s[y]=T,s[_]=S,T=M*s[y+1]+w*s[_+1],S=-w*s[y+1]+M*s[_+1],s[y+1]=T,s[_+1]=S;m<l;m++)T=M*s[y+m]+w*s[_+m],S=-w*s[y+m]+M*s[_+m],s[y+m]=T,s[_+m]=S}}if(0==x)break}for(u=0;u<l;u++){for(m=0,k=0;m<r;m++)k+=(E=a[u*i+m])*E;O[u]=Math.sqrt(k)}for(u=0;u<l-1;u++){for(f=u,m=u+1;m<l;m++)O[f]<O[m]&&(f=m);if(u!=f&&(e(O,u,f,k),s)){for(m=0;m<r;m++)e(a,u*i+m,f*i+m,E);for(m=0;m<l;m++)e(s,u*n+m,f*n+m,E)}}for(u=0;u<l;u++)o[u]=O[u];if(s){for(u=0;u<c;u++){for(k=u<l?O[u]:0;k<=h;){for(z=1/r,m=0;m<r;m++)P=0!=(256&(I=214013*I+2531011)>>16)?z:-z,a[u*i+m]=P;for(p=0;p<2;p++)for(f=0;f<u;f++){for(k=0,m=0;m<r;m++)k+=a[u*i+m]*a[f*i+m];for(H=0,m=0;m<r;m++)E=a[u*i+m]-k*a[f*i+m],a[u*i+m]=E,H+=Math.abs(E);for(H=H?1/H:0,m=0;m<r;m++)a[u*i+m]*=H}for(k=0,m=0;m<r;m++)k+=(E=a[u*i+m])*E;k=Math.sqrt(k)}for(w=1/k,m=0;m<r;m++)a[u*i+m]*=w}jsfeat.cache.put_buffer(V)}else jsfeat.cache.put_buffer(V)}(g.data,h,b.data,y.data,u,h,u,h),i){for(l=0;l<u;l++)i.data[l]=b.data[l];for(;l<d;l++)i.data[l]=0}if(0==r){if(o&&n&jsfeat.SVD_U_T)for(l=h*h;--l>=0;)o.data[l]=g.data[l];else o&&jsfeat.matmath.transpose(o,g);if(s&&n&jsfeat.SVD_V_T)for(l=u*u;--l>=0;)s.data[l]=y.data[l];else s&&jsfeat.matmath.transpose(s,y)}else{if(o&&n&jsfeat.SVD_U_T)for(l=u*u;--l>=0;)o.data[l]=y.data[l];else o&&jsfeat.matmath.transpose(o,y);if(s&&n&jsfeat.SVD_V_T)for(l=h*h;--l>=0;)s.data[l]=g.data[l];else s&&jsfeat.matmath.transpose(s,g)}jsfeat.cache.put_buffer(m),jsfeat.cache.put_buffer(p),jsfeat.cache.put_buffer(v)},svd_solve:function(e,t,a){var i=0,o=0,s=0,n=0,r=0,l=e.rows,c=e.cols,d=0,h=0,u=0,f=e.type|jsfeat.C1_t,m=jsfeat.cache.get_buffer(l*l<<3),p=jsfeat.cache.get_buffer(c<<3),v=jsfeat.cache.get_buffer(c*c<<3),g=new jsfeat.matrix_t(l,l,f,m.data),b=new jsfeat.matrix_t(1,c,f,p.data),y=new jsfeat.matrix_t(c,c,f,v.data),_=a.data,x=g.data,M=b.data,w=y.data;for(this.svd_decompose(e,b,g,y,0),u=jsfeat.EPSILON*M[0]*c;i<c;i++,r+=c){for(h=0,o=0;o<c;o++)if(M[o]>u){for(s=0,d=0,n=0;s<l;s++,n+=c)d+=x[n+o]*_[s];h+=d*w[r+o]/M[o]}t.data[i]=h}jsfeat.cache.put_buffer(m),jsfeat.cache.put_buffer(p),jsfeat.cache.put_buffer(v)},svd_invert:function(e,t){var a=0,i=0,o=0,s=0,n=0,r=0,l=t.rows,c=t.cols,d=0,h=0,u=t.type|jsfeat.C1_t,f=jsfeat.cache.get_buffer(l*l<<3),m=jsfeat.cache.get_buffer(c<<3),p=jsfeat.cache.get_buffer(c*c<<3),v=new jsfeat.matrix_t(l,l,u,f.data),g=new jsfeat.matrix_t(1,c,u,m.data),b=new jsfeat.matrix_t(c,c,u,p.data),y=e.data,_=v.data,x=g.data,M=b.data;for(this.svd_decompose(t,g,v,b,0),h=jsfeat.EPSILON*x[0]*c;a<c;a++,n+=c)for(i=0,s=0;i<l;i++,r++){for(o=0,d=0;o<c;o++,s++)x[o]>h&&(d+=M[n+o]*_[s]/x[o]);y[r]=d}jsfeat.cache.put_buffer(f),jsfeat.cache.put_buffer(m),jsfeat.cache.put_buffer(p)},eigenVV:function(a,i,o){for(var s=a.cols,n=s*s,r=a.type|jsfeat.C1_t,l=jsfeat.cache.get_buffer(s*s<<3),c=jsfeat.cache.get_buffer(s<<3),d=new jsfeat.matrix_t(s,s,r,l.data),h=new jsfeat.matrix_t(1,s,r,c.data);--n>=0;)d.data[n]=a.data[n];if(function(a,i,o,s,n,r){var l=jsfeat.EPSILON,c=0,d=0,h=0,u=0,f=0,m=0,p=0,v=0,g=0,b=r*r*30,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0,k=0,A=jsfeat.cache.get_buffer(r<<2),L=jsfeat.cache.get_buffer(r<<2),R=A.i32,j=L.i32;if(s)for(;c<r;c++){for(h=c*n,d=0;d<r;d++)s[h+d]=0;s[h+c]=1}for(h=0;h<r;h++){if(o[h]=a[(i+1)*h],h<r-1){for(u=h+1,y=Math.abs(a[i*h+u]),c=h+2;c<r;c++)y<(_=Math.abs(a[i*h+c]))&&(y=_,u=c);R[h]=u}if(h>0){for(u=0,y=Math.abs(a[h]),c=1;c<h;c++)y<(_=Math.abs(a[i*c+h]))&&(y=_,u=c);j[h]=u}}if(r>1)for(;g<b;g++){for(h=0,y=Math.abs(a[R[0]]),c=1;c<r-1;c++)y<(_=Math.abs(a[i*c+R[c]]))&&(y=_,h=c);for(f=R[h],c=1;c<r;c++)y<(_=Math.abs(a[i*j[c]+c]))&&(y=_,h=j[c],f=c);if(x=a[i*h+f],Math.abs(x)<=l)break;for(M=.5*(o[f]-o[h]),T=(w=Math.abs(M)+t(x,M))/(E=t(x,w)),E=x/E,w=x/w*x,M<0&&(E=-E,w=-w),a[i*h+f]=0,o[h]-=w,o[f]+=w,c=0;c<h;c++)v=i*c+f,S=a[p=i*c+h],k=a[v],a[p]=S*T-k*E,a[v]=S*E+k*T;for(c=h+1;c<f;c++)v=i*c+f,S=a[p=i*h+c],k=a[v],a[p]=S*T-k*E,a[v]=S*E+k*T;for(p=i*h+(c=f+1),v=i*f+c;c<r;c++,p++,v++)S=a[p],k=a[v],a[p]=S*T-k*E,a[v]=S*E+k*T;if(s)for(p=n*h,v=n*f,c=0;c<r;c++,p++,v++)S=s[p],k=s[v],s[p]=S*T-k*E,s[v]=S*E+k*T;for(d=0;d<2;d++){if((m=0==d?h:f)<r-1){for(u=m+1,y=Math.abs(a[i*m+u]),c=m+2;c<r;c++)y<(_=Math.abs(a[i*m+c]))&&(y=_,u=c);R[m]=u}if(m>0){for(u=0,y=Math.abs(a[m]),c=1;c<m;c++)y<(_=Math.abs(a[i*c+m]))&&(y=_,u=c);j[m]=u}}}for(h=0;h<r-1;h++){for(u=h,c=h+1;c<r;c++)o[u]<o[c]&&(u=c);if(h!=u&&(e(o,u,h,y),s))for(c=0;c<r;c++)e(s,n*u+c,n*h+c,y)}jsfeat.cache.put_buffer(A),jsfeat.cache.put_buffer(L)}(d.data,s,h.data,i?i.data:null,s,s),o)for(;--s>=0;)o.data[s]=h.data[s];jsfeat.cache.put_buffer(l),jsfeat.cache.put_buffer(c)}}}();e.linalg=t}(jsfeat),function(e){var t=function(){var e=function(e){return e*e},t=new jsfeat.matrix_t(3,3,jsfeat.F32_t|jsfeat.C1_t),a=new jsfeat.matrix_t(3,3,jsfeat.F32_t|jsfeat.C1_t),i=new jsfeat.matrix_t(6,6,jsfeat.F32_t|jsfeat.C1_t),o=new jsfeat.matrix_t(6,1,jsfeat.F32_t|jsfeat.C1_t),s=function(){function s(){}return s.prototype.run=function(e,s,n,r){var l,c,d=0,h=0,u=n.type|jsfeat.C1_t,f=n.data,m=t.data,p=a.data,v=0,g=0;!function(e,t,a,i,o){for(var s=0,n=0,r=0,l=0,c=0,d=0,h=0,u=0,f=0,m=0,p=0;s<o;++s)n+=e[s].x,r+=e[s].y,d+=t[s].x,h+=t[s].y;for(n/=o,r/=o,d/=o,h/=o,s=0;s<o;++s)m=e[s].x-n,p=e[s].y-r,l+=Math.sqrt(m*m+p*p),m=t[s].x-d,p=t[s].y-h,u+=Math.sqrt(m*m+p*p);l/=o,u/=o,c=Math.SQRT2/l,f=Math.SQRT2/u,a[0]=a[4]=c,a[2]=-n*c,a[5]=-r*c,a[1]=a[3]=a[6]=a[7]=0,a[8]=1,i[0]=i[4]=f,i[2]=-d*f,i[5]=-h*f,i[1]=i[3]=i[6]=i[7]=0,i[8]=1}(e,s,m,p,r);for(var b=jsfeat.cache.get_buffer(2*r*6<<3),y=jsfeat.cache.get_buffer(2*r<<3),_=new jsfeat.matrix_t(6,2*r,u,b.data),x=new jsfeat.matrix_t(1,2*r,u,y.data),M=_.data,w=x.data;d<r;++d)l=e[d],c=s[d],v=m[0]*l.x+m[1]*l.y+m[2],g=m[3]*l.x+m[4]*l.y+m[5],M[h=2*d*6]=v,M[h+1]=g,M[h+2]=1,M[h+3]=0,M[h+4]=0,M[h+5]=0,M[h+=6]=0,M[h+1]=0,M[h+2]=0,M[h+3]=v,M[h+4]=g,M[h+5]=1,w[d<<1]=p[0]*c.x+p[1]*c.y+p[2],w[1+(d<<1)]=p[3]*c.x+p[4]*c.y+p[5];return jsfeat.matmath.multiply_AtA(i,_),jsfeat.matmath.multiply_AtB(o,_,x),jsfeat.linalg.lu_solve(i,o),f[0]=o.data[0],f[1]=o.data[1],f[2]=o.data[2],f[3]=o.data[3],f[4]=o.data[4],f[5]=o.data[5],f[6]=0,f[7]=0,f[8]=1,jsfeat.matmath.invert_3x3(a,a),jsfeat.matmath.multiply_3x3(n,a,n),jsfeat.matmath.multiply_3x3(n,n,t),jsfeat.cache.put_buffer(b),jsfeat.cache.put_buffer(y),1},s.prototype.error=function(t,a,i,o,s){for(var n,r,l=0,c=i.data;l<s;++l)n=t[l],r=a[l],o[l]=e(r.x-c[0]*n.x-c[1]*n.y-c[2])+e(r.y-c[3]*n.x-c[4]*n.y-c[5])},s.prototype.check_subset=function(){return!0},s}(),n=new jsfeat.matrix_t(9,9,jsfeat.F32_t|jsfeat.C1_t),r=new jsfeat.matrix_t(9,9,jsfeat.F32_t|jsfeat.C1_t);return{affine2d:s,homography2d:function(){function e(){}return e.prototype.run=function(e,i,o,s){for(var l=0,c=0,d=o.data,h=t.data,u=a.data,f=n.data,m=r.data,p=0,v=0,g=0,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0;l<s;++l)x+=i[l].x,M+=i[l].y,T+=e[l].x,S+=e[l].y;for(x/=s,M/=s,T/=s,S/=s,l=0;l<s;++l)y+=Math.abs(i[l].x-x),_+=Math.abs(i[l].y-M),w+=Math.abs(e[l].x-T),E+=Math.abs(e[l].y-S);if(Math.abs(y)<jsfeat.EPSILON||Math.abs(_)<jsfeat.EPSILON||Math.abs(w)<jsfeat.EPSILON||Math.abs(E)<jsfeat.EPSILON)return 0;for(y=s/y,_=s/_,w=s/w,E=s/E,h[0]=w,h[1]=0,h[2]=-T*w,h[3]=0,h[4]=E,h[5]=-S*E,h[6]=0,h[7]=0,h[8]=1,u[0]=1/y,u[1]=0,u[2]=x,u[3]=0,u[4]=1/_,u[5]=M,u[6]=0,u[7]=0,u[8]=1,l=81;--l>=0;)f[l]=0;for(l=0;l<s;++l)p=(i[l].x-x)*y,v=(i[l].y-M)*_,g=(e[l].x-T)*w,b=(e[l].y-S)*E,f[0]+=g*g,f[1]+=g*b,f[2]+=g,f[6]+=g*-p*g,f[7]+=g*-p*b,f[8]+=g*-p,f[10]+=b*b,f[11]+=b,f[15]+=b*-p*g,f[16]+=b*-p*b,f[17]+=b*-p,f[20]+=1,f[24]+=-p*g,f[25]+=-p*b,f[26]+=-p,f[30]+=g*g,f[31]+=g*b,f[32]+=g,f[33]+=g*-v*g,f[34]+=g*-v*b,f[35]+=g*-v,f[40]+=b*b,f[41]+=b,f[42]+=b*-v*g,f[43]+=b*-v*b,f[44]+=b*-v,f[50]+=1,f[51]+=-v*g,f[52]+=-v*b,f[53]+=-v,f[60]+=-p*g*-p*g+-v*g*-v*g,f[61]+=-p*g*-p*b+-v*g*-v*b,f[62]+=-p*g*-p+-v*g*-v,f[70]+=-p*b*-p*b+-v*b*-v*b,f[71]+=-p*b*-p+-v*b*-v,f[80]+=-p*-p+-v*-v;for(l=0;l<9;++l)for(c=0;c<l;++c)f[9*l+c]=f[9*c+l];return jsfeat.linalg.eigenVV(n,r),d[0]=m[72],d[1]=m[73],d[2]=m[74],d[3]=m[75],d[4]=m[76],d[5]=m[77],d[6]=m[78],d[7]=m[79],d[8]=m[80],jsfeat.matmath.multiply_3x3(o,a,o),jsfeat.matmath.multiply_3x3(o,o,t),p=1/d[8],d[0]*=p,d[1]*=p,d[2]*=p,d[3]*=p,d[4]*=p,d[5]*=p,d[6]*=p,d[7]*=p,d[8]=1,1},e.prototype.error=function(e,t,a,i,o){for(var s,n,r=0,l=0,c=0,d=0,h=a.data;r<o;++r)s=e[r],n=t[r],l=1/(h[6]*s.x+h[7]*s.y+1),c=(h[0]*s.x+h[1]*s.y+h[2])*l-n.x,d=(h[3]*s.x+h[4]*s.y+h[5])*l-n.y,i[r]=c*c+d*d},e.prototype.check_subset=function(e,t,a){if(4==a){var i=0,o=e[0],s=e[1],n=e[2],r=e[3],l=t[0],c=t[1],d=t[2],h=t[3],u=o.x,f=o.y,m=s.x,p=s.y,v=n.x,g=n.y,b=l.x,y=l.y,_=c.x,x=c.y,M=d.x,w=d.y,E=jsfeat.matmath.determinant_3x3(u,f,1,m,p,1,v,g,1),T=jsfeat.matmath.determinant_3x3(b,y,1,_,x,1,M,w,1);if(E*T<0&&i++,u=s.x,f=s.y,m=n.x,p=n.y,v=r.x,g=r.y,b=c.x,y=c.y,_=d.x,x=d.y,M=h.x,w=h.y,E=jsfeat.matmath.determinant_3x3(u,f,1,m,p,1,v,g,1),T=jsfeat.matmath.determinant_3x3(b,y,1,_,x,1,M,w,1),E*T<0&&i++,u=o.x,f=o.y,m=n.x,p=n.y,v=r.x,g=r.y,b=l.x,y=l.y,_=d.x,x=d.y,M=h.x,w=h.y,E=jsfeat.matmath.determinant_3x3(u,f,1,m,p,1,v,g,1),T=jsfeat.matmath.determinant_3x3(b,y,1,_,x,1,M,w,1),E*T<0&&i++,u=o.x,f=o.y,m=s.x,p=s.y,v=r.x,g=r.y,b=l.x,y=l.y,_=c.x,x=c.y,M=h.x,w=h.y,E=jsfeat.matmath.determinant_3x3(u,f,1,m,p,1,v,g,1),T=jsfeat.matmath.determinant_3x3(b,y,1,_,x,1,M,w,1),E*T<0&&i++,0!=i&&4!=i)return!1}return!0},e}()}}(),a=function(){function e(e,t,a,i){void 0===e&&(e=0),void 0===t&&(t=.5),void 0===a&&(a=.5),void 0===i&&(i=.99),this.size=e,this.thresh=t,this.eps=a,this.prob=i}return e.prototype.update_iters=function(e,t){var a=Math.log(1-this.prob),i=Math.log(1-Math.pow(1-e,this.size));return 0|(i>=0||-a>=t*-i?t:Math.round(a/i))},e}(),i=function(){var e=function(e,t,a,i,o,s,n){for(var r=[],l=0,c=0,d=0,h=0,u=!1;d<1e3;++d){for(l=0;l<i&&d<1e3;){for(u=!1,h=0;!u;)for(u=!0,h=r[l]=0|Math.floor(Math.random()*o),c=0;c<l;++c)if(h==r[c]){u=!1;break}s[l]=t[h],n[l]=a[h],e.check_subset(s,n,l+1)?++l:d++}break}return l==i&&d<1e3},t=function(e,t,a,i,o,s,n,r){var l=0,c=0,d=0,h=s*s;for(e.error(a,i,t,n,o);c<o;++c)d=n[c]<=h,r[c]=d,l+=d;return l};return{ransac:function(a,i,o,s,n,r,l,c){if(void 0===c&&(c=1e3),n<a.size)return!1;var d=a.size,h=c,u=0,f=!1,m=[],p=[],v=r.cols,g=r.rows,b=r.type|jsfeat.C1_t,y=jsfeat.cache.get_buffer(v*g<<3),_=jsfeat.cache.get_buffer(n),x=jsfeat.cache.get_buffer(n<<2),M=new jsfeat.matrix_t(v,g,b,y.data),w=new jsfeat.matrix_t(n,1,jsfeat.U8C1_t,_.data),E=-1,T=0,S=x.f32;if(n==d){if(i.run(o,s,M,n)<=0)return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),!1;if(M.copy_to(r),l)for(;--n>=0;)l.data[n]=1;return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),!0}for(;u<h;++u){if(!e(i,o,s,d,n,m,p)){if(0==u)return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),!1;break}i.run(m,p,M,d)<=0||(T=t(i,M,o,s,n,a.thresh,S,w.data))>Math.max(E,d-1)&&(M.copy_to(r),E=T,l&&w.copy_to(l),h=a.update_iters((n-T)/n,h),f=!0)}return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),f},lmeds:function(a,i,o,s,n,r,l,c){if(void 0===c&&(c=1e3),n<a.size)return!1;var d=a.size,h=c,u=0,f=!1,m=[],p=[],v=r.cols,g=r.rows,b=r.type|jsfeat.C1_t,y=jsfeat.cache.get_buffer(v*g<<3),_=jsfeat.cache.get_buffer(n),x=jsfeat.cache.get_buffer(n<<2),M=new jsfeat.matrix_t(v,g,b,y.data),w=new jsfeat.matrix_t(n,1,jsfeat.U8_t|jsfeat.C1_t,_.data),E=0,T=x.f32,S=1e9,k=0,A=0;if(a.eps=.45,h=a.update_iters(a.eps,h),n==d){if(i.run(o,s,M,n)<=0)return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),!1;if(M.copy_to(r),l)for(;--n>=0;)l.data[n]=1;return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),!0}for(;u<h;++u){if(!e(i,o,s,d,n,m,p)){if(0==u)return jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),!1;break}i.run(m,p,M,d)<=0||(i.error(o,s,M,T,n),(A=jsfeat.math.median(T,0,n-1))<S&&(S=A,M.copy_to(r),f=!0))}return f&&(k=2.5*1.4826*(1+5/(n-d))*Math.sqrt(S),k=Math.max(k,.001),E=t(i,r,o,s,n,k,T,w.data),l&&w.copy_to(l),f=E>=d),jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),f}}}();e.ransac_params_t=a,e.motion_model=t,e.motion_estimator=i}(jsfeat),function(){var e={grayscale:function(e,t,a,i,o){void 0===o&&(o=jsfeat.COLOR_RGBA2GRAY);var s=0,n=0,r=0,l=0,c=0,d=0,h=4899,u=1868,f=4;o!=jsfeat.COLOR_BGRA2GRAY&&o!=jsfeat.COLOR_BGR2GRAY||(h=1868,u=4899),o!=jsfeat.COLOR_RGB2GRAY&&o!=jsfeat.COLOR_BGR2GRAY||(f=3);var m=f<<1,p=3*f|0;i.resize(t,a,1);var v=i.data;for(n=0;n<a;++n,l+=t,r+=t*f){for(s=0,c=r,d=l;s<=t-4;s+=4,c+=f<<2,d+=4)v[d]=e[c]*h+9617*e[c+1]+e[c+2]*u+8192>>14,v[d+1]=e[c+f]*h+9617*e[c+f+1]+e[c+f+2]*u+8192>>14,v[d+2]=e[c+m]*h+9617*e[c+m+1]+e[c+m+2]*u+8192>>14,v[d+3]=e[c+p]*h+9617*e[c+p+1]+e[c+p+2]*u+8192>>14;for(;s<t;++s,++d,c+=f)v[d]=e[c]*h+9617*e[c+1]+e[c+2]*u+8192>>14}},resample:function(e,t,a,i){var o=e.rows,s=e.cols;o>i&&s>a&&(t.resize(a,i,e.channel),e.type&jsfeat.U8_t&&t.type&jsfeat.U8_t&&o*s/(i*a)<256?function(e,t,a,i){for(var o=0,s=e.channel,n=e.cols,r=e.rows,l=e.data,c=t.data,d=n/a,h=r/i,u=d*h*65536|0,f=0,m=0,p=0,v=0,g=0,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0,k=0,A=0,L=jsfeat.cache.get_buffer(a*s<<2),R=jsfeat.cache.get_buffer(a*s<<2),j=jsfeat.cache.get_buffer(2*n*3<<2),D=L.i32,C=R.i32,I=j.i32;f<a;f++){for(g=1+(x=f*d)-1e-6|0,b=0|(M=x+d),g=Math.min(g,n-1),b=Math.min(b,n-1),g>x&&(I[_++]=f*s|0,I[_++]=(g-1)*s|0,I[_++]=256*(g-x)|0,o++),p=g;p<b;p++)o++,I[_++]=f*s|0,I[_++]=p*s|0,I[_++]=256;M-b>.001&&(o++,I[_++]=f*s|0,I[_++]=b*s|0,I[_++]=256*(M-b)|0)}for(f=0;f<a*s;f++)D[f]=C[f]=0;for(m=0,v=0;v<r;v++){for(w=n*v,_=0;_<o;_++)for(T=I[3*_],g=I[3*_+1],S=I[3*_+2],y=0;y<s;y++)D[T+y]+=l[w+g+y]*S;if((m+1)*h<=v+1||v==r-1){if(k=256*Math.max(v+1-(m+1)*h,0)|0,A=256-k,E=a*m,k<=0)for(f=0;f<a*s;f++)c[E+f]=Math.min(Math.max((C[f]+256*D[f])/u,0),255),C[f]=D[f]=0;else for(f=0;f<a*s;f++)c[E+f]=Math.min(Math.max((C[f]+D[f]*A)/u,0),255),C[f]=D[f]*k,D[f]=0;m++}else for(f=0;f<a*s;f++)C[f]+=256*D[f],D[f]=0}jsfeat.cache.put_buffer(R),jsfeat.cache.put_buffer(L),jsfeat.cache.put_buffer(j)}(e,t,a,i):function(e,t,a,i){for(var o=0,s=e.channel,n=e.cols,r=e.rows,l=e.data,c=t.data,d=n/a,h=r/i,u=1/(d*h),f=0,m=0,p=0,v=0,g=0,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0,k=0,A=0,L=jsfeat.cache.get_buffer(a*s<<2),R=jsfeat.cache.get_buffer(a*s<<2),j=jsfeat.cache.get_buffer(2*n*3<<2),D=L.f32,C=R.f32,I=j.f32;f<a;f++){for(g=1+(x=f*d)-1e-6|0,b=0|(M=x+d),g=Math.min(g,n-1),b=Math.min(b,n-1),g>x&&(o++,I[_++]=(g-1)*s|0,I[_++]=f*s|0,I[_++]=(g-x)*u),p=g;p<b;p++)o++,I[_++]=p*s|0,I[_++]=f*s|0,I[_++]=u;M-b>.001&&(o++,I[_++]=b*s|0,I[_++]=f*s|0,I[_++]=(M-b)*u)}for(f=0;f<a*s;f++)D[f]=C[f]=0;for(m=0,v=0;v<r;v++){for(w=n*v,_=0;_<o;_++)for(g=0|I[3*_],T=0|I[3*_+1],S=I[3*_+2],y=0;y<s;y++)D[T+y]+=l[w+g+y]*S;if((m+1)*h<=v+1||v==r-1){if(k=Math.max(v+1-(m+1)*h,0),A=1-k,E=a*m,Math.abs(k)<.001)for(f=0;f<a*s;f++)c[E+f]=C[f]+D[f],C[f]=D[f]=0;else for(f=0;f<a*s;f++)c[E+f]=C[f]+D[f]*A,C[f]=D[f]*k,D[f]=0;m++}else for(f=0;f<a*s;f++)C[f]+=D[f],D[f]=0}jsfeat.cache.put_buffer(R),jsfeat.cache.put_buffer(L),jsfeat.cache.put_buffer(j)}(e,t,a,i))},box_blur_gray:function(e,t,a,i){void 0===i&&(i=0);var o=e.cols,s=e.rows,n=s<<1,r=o<<1,l=0,c=0,d=0,h=0,u=1+(a<<1)|0,f=a+1|0,m=f+1|0,p=i&jsfeat.BOX_BLUR_NOSCALE?1:1/(u*u),v=jsfeat.cache.get_buffer(o*s<<2),g=0,b=0,y=0,_=0,x=0,M=v.i32,w=e.data,E=0;for(t.resize(o,s,e.channel),d=0;d<s;++d){for(b=d,g=f*w[y],l=y+1|0,h=y+a|0;l<=h;++l)g+=w[l];for(_=y+f|0,E=w[x=y],c=0;c<a;++c,b+=s)M[b]=g,g+=w[_]-E,_++;for(;c<o-m;c+=2,b+=n)M[b]=g,g+=w[_]-w[x],M[b+s]=g,g+=w[_+1]-w[x+1],_+=2,x+=2;for(;c<o-f;++c,b+=s)M[b]=g,g+=w[_]-w[x],_++,x++;for(E=w[_-1];c<o;++c,b+=s)M[b]=g,g+=E-w[x],x++;y+=o}if(y=0,w=t.data,1==p)for(d=0;d<o;++d){for(b=d,g=f*M[y],l=y+1|0,h=y+a|0;l<=h;++l)g+=M[l];for(_=y+f,E=M[x=y],c=0;c<a;++c,b+=o)w[b]=g,g+=M[_]-E,_++;for(;c<s-m;c+=2,b+=r)w[b]=g,g+=M[_]-M[x],w[b+o]=g,g+=M[_+1]-M[x+1],_+=2,x+=2;for(;c<s-f;++c,b+=o)w[b]=g,g+=M[_]-M[x],_++,x++;for(E=M[_-1];c<s;++c,b+=o)w[b]=g,g+=E-M[x],x++;y+=s}else for(d=0;d<o;++d){for(b=d,g=f*M[y],l=y+1|0,h=y+a|0;l<=h;++l)g+=M[l];for(_=y+f,E=M[x=y],c=0;c<a;++c,b+=o)w[b]=g*p,g+=M[_]-E,_++;for(;c<s-m;c+=2,b+=r)w[b]=g*p,g+=M[_]-M[x],w[b+o]=g*p,g+=M[_+1]-M[x+1],_+=2,x+=2;for(;c<s-f;++c,b+=o)w[b]=g*p,g+=M[_]-M[x],_++,x++;for(E=M[_-1];c<s;++c,b+=o)w[b]=g*p,g+=E-M[x],x++;y+=s}jsfeat.cache.put_buffer(v)},gaussian_blur:function(e,t,a,i){void 0===i&&(i=0),void 0===a&&(a=0);var o=(a=0==a?2*Math.max(1,4*i+1-1e-8)+1|0:a)>>1,s=e.cols,n=e.rows,r=e.type,l=r&jsfeat.U8_t;t.resize(s,n,e.channel);var c,d,h=e.data,u=t.data,f=a+Math.max(n,s)|0,m=jsfeat.cache.get_buffer(f<<2),p=jsfeat.cache.get_buffer(a<<2);l?(c=m.i32,d=p.i32):r&jsfeat.S32_t?(c=m.i32,d=p.f32):(c=m.f32,d=p.f32),jsfeat.math.get_gaussian_kernel(a,i,d,r),l?function(e,t,a,i,o,s,n,r){for(var l=0,c=0,d=0,h=0,u=0,f=0,m=0,p=0,v=0,g=s[0],b=0,y=i<<1,_=3*i,x=i<<2;l<o;++l){for(f=t[h],c=0;c<r;++c)e[c]=f;for(c=0;c<=i-2;c+=2)e[c+r]=t[h+c],e[c+r+1]=t[h+c+1];for(;c<i;++c)e[c+r]=t[h+c];for(f=t[h+i-1],c=i;c<r+i;++c)e[c+r]=f;for(c=0;c<=i-4;c+=4){for(f=e[c]*g,m=e[c+1]*g,p=e[c+2]*g,v=e[c+3]*g,d=1;d<n;++d)b=s[d],f+=e[d+c]*b,m+=e[d+c+1]*b,p+=e[d+c+2]*b,v+=e[d+c+3]*b;a[u+c]=Math.min(f>>8,255),a[u+c+1]=Math.min(m>>8,255),a[u+c+2]=Math.min(p>>8,255),a[u+c+3]=Math.min(v>>8,255)}for(;c<i;++c){for(f=e[c]*g,d=1;d<n;++d)f+=e[d+c]*s[d];a[u+c]=Math.min(f>>8,255)}h+=i,u+=i}for(l=0;l<i;++l){for(f=a[l],c=0;c<r;++c)e[c]=f;for(d=l,c=0;c<=o-2;c+=2,d+=y)e[c+r]=a[d],e[c+r+1]=a[d+i];for(;c<o;++c,d+=i)e[c+r]=a[d];for(f=a[(o-1)*i+l],c=o;c<r+o;++c)e[c+r]=f;for(u=l,c=0;c<=o-4;c+=4,u+=x){for(f=e[c]*g,m=e[c+1]*g,p=e[c+2]*g,v=e[c+3]*g,d=1;d<n;++d)b=s[d],f+=e[d+c]*b,m+=e[d+c+1]*b,p+=e[d+c+2]*b,v+=e[d+c+3]*b;a[u]=Math.min(f>>8,255),a[u+i]=Math.min(m>>8,255),a[u+y]=Math.min(p>>8,255),a[u+_]=Math.min(v>>8,255)}for(;c<o;++c,u+=i){for(f=e[c]*g,d=1;d<n;++d)f+=e[d+c]*s[d];a[u]=Math.min(f>>8,255)}}}(c,h,u,s,n,d,a,o):function(e,t,a,i,o,s,n,r){for(var l=0,c=0,d=0,h=0,u=0,f=0,m=0,p=0,v=0,g=s[0],b=0,y=i<<1,_=3*i,x=i<<2;l<o;++l){for(f=t[h],c=0;c<r;++c)e[c]=f;for(c=0;c<=i-2;c+=2)e[c+r]=t[h+c],e[c+r+1]=t[h+c+1];for(;c<i;++c)e[c+r]=t[h+c];for(f=t[h+i-1],c=i;c<r+i;++c)e[c+r]=f;for(c=0;c<=i-4;c+=4){for(f=e[c]*g,m=e[c+1]*g,p=e[c+2]*g,v=e[c+3]*g,d=1;d<n;++d)b=s[d],f+=e[d+c]*b,m+=e[d+c+1]*b,p+=e[d+c+2]*b,v+=e[d+c+3]*b;a[u+c]=f,a[u+c+1]=m,a[u+c+2]=p,a[u+c+3]=v}for(;c<i;++c){for(f=e[c]*g,d=1;d<n;++d)f+=e[d+c]*s[d];a[u+c]=f}h+=i,u+=i}for(l=0;l<i;++l){for(f=a[l],c=0;c<r;++c)e[c]=f;for(d=l,c=0;c<=o-2;c+=2,d+=y)e[c+r]=a[d],e[c+r+1]=a[d+i];for(;c<o;++c,d+=i)e[c+r]=a[d];for(f=a[(o-1)*i+l],c=o;c<r+o;++c)e[c+r]=f;for(u=l,c=0;c<=o-4;c+=4,u+=x){for(f=e[c]*g,m=e[c+1]*g,p=e[c+2]*g,v=e[c+3]*g,d=1;d<n;++d)b=s[d],f+=e[d+c]*b,m+=e[d+c+1]*b,p+=e[d+c+2]*b,v+=e[d+c+3]*b;a[u]=f,a[u+i]=m,a[u+y]=p,a[u+_]=v}for(;c<o;++c,u+=i){for(f=e[c]*g,d=1;d<n;++d)f+=e[d+c]*s[d];a[u]=f}}}(c,h,u,s,n,d,a,o),jsfeat.cache.put_buffer(m),jsfeat.cache.put_buffer(p)},hough_transform:function(e,t,a,i){var o=e.data,s=e.cols,n=e.rows,r=s;min_theta=0,max_theta=Math.PI,numangle=Math.round((max_theta-min_theta)/a),numrho=Math.round((2*(s+n)+1)/t),irho=1/t;for(var l=new Int32Array((numangle+2)*(numrho+2)),c=new Float32Array(numangle),d=new Float32Array(numangle),h=0,u=min_theta;h<numangle;h++)c[h]=Math.sin(u)*irho,d[h]=Math.cos(u)*irho,u+=a;for(var f=0;f<n;f++)for(var m=0;m<s;m++)if(0!=o[f*r+m])for(h=0;h<numangle;h++){var p=Math.round(m*d[h]+f*c[h]);p+=(numrho-1)/2,l[(h+1)*(numrho+2)+p+1]+=1}_sort_buf=new Array;for(p=0;p<numrho;p++)for(h=0;h<numangle;h++){var v=(h+1)*(numrho+2)+p+1;l[v]>i&&l[v]>l[v-1]&&l[v]>=l[v+1]&&l[v]>l[v-numrho-2]&&l[v]>=l[v+numrho+2]&&_sort_buf.push(v)}_sort_buf.sort(function(e,t){return l[e]>l[t]||l[e]==l[t]&&e<t}),linesMax=Math.min(numangle*numrho,_sort_buf.length),scale=1/(numrho+2),lines=new Array;for(f=0;f<linesMax;f++){var g=_sort_buf[f],b=((p=g-((h=Math.floor(g*scale)-1)+1)*(numrho+2)-1)-.5*(numrho-1))*t,y=h*a;lines.push([b,y])}return lines},pyrdown:function(e,t,a,i){void 0===a&&(a=0),void 0===i&&(i=0);var o=e.cols,s=o>>1,n=e.rows>>1,r=s-(a<<1),l=n-(i<<1),c=0,d=0,h=a+i*o,u=0,f=0,m=0;t.resize(s,n,e.channel);var p=e.data,v=t.data;for(d=0;d<l;++d){for(u=h,m=f,c=0;c<=r-2;c+=2,m+=2,u+=4)v[m]=p[u]+p[u+1]+p[u+o]+p[u+o+1]+2>>2,v[m+1]=p[u+2]+p[u+3]+p[u+o+2]+p[u+o+3]+2>>2;for(;c<r;++c,++m,u+=2)v[m]=p[u]+p[u+1]+p[u+o]+p[u+o+1]+2>>2;h+=o<<1,f+=s}},scharr_derivatives:function(e,t){var a,i,o,s,n,r,l,c,d=e.cols,h=e.rows,u=d<<1,f=0,m=0,p=0,v=0,g=0,b=0,y=0;t.resize(d,h,2);var _=e.data,x=t.data,M=jsfeat.cache.get_buffer(d+2<<2),w=jsfeat.cache.get_buffer(d+2<<2);for(e.type&jsfeat.U8_t||e.type&jsfeat.S32_t?(l=M.i32,c=w.i32):(l=M.f32,c=w.f32);m<h;++m,g+=d){for(v=(m>0?m-1:1)*d|0,b=(m<h-1?m+1:h-2)*d|0,y=m*u|0,f=0,p=1;f<=d-2;f+=2,p+=2)a=_[v+f],i=_[b+f],l[p]=3*(a+i)+10*_[g+f],c[p]=i-a,a=_[v+f+1],i=_[b+f+1],l[p+1]=3*(a+i)+10*_[g+f+1],c[p+1]=i-a;for(;f<d;++f,++p)a=_[v+f],i=_[b+f],l[p]=3*(a+i)+10*_[g+f],c[p]=i-a;for(f=d+1|0,l[0]=l[1],l[f]=l[d],c[0]=c[1],c[f]=c[d],f=0;f<=d-4;f+=4)a=c[f+2],i=c[f+1],o=c[f+3],s=c[f+4],n=l[f+2],r=l[f+3],x[y++]=n-l[f],x[y++]=3*(a+c[f])+10*i,x[y++]=r-l[f+1],x[y++]=3*(o+i)+10*a,x[y++]=l[f+4]-n,x[y++]=3*(s+a)+10*o,x[y++]=l[f+5]-r,x[y++]=3*(c[f+5]+o)+10*s;for(;f<d;++f)x[y++]=l[f+2]-l[f],x[y++]=3*(c[f+2]+c[f])+10*c[f+1]}jsfeat.cache.put_buffer(M),jsfeat.cache.put_buffer(w)},sobel_derivatives:function(e,t){var a,i,o,s,n,r,l,c,d=e.cols,h=e.rows,u=d<<1,f=0,m=0,p=0,v=0,g=0,b=0,y=0;t.resize(d,h,2);var _=e.data,x=t.data,M=jsfeat.cache.get_buffer(d+2<<2),w=jsfeat.cache.get_buffer(d+2<<2);for(e.type&jsfeat.U8_t||e.type&jsfeat.S32_t?(l=M.i32,c=w.i32):(l=M.f32,c=w.f32);m<h;++m,g+=d){for(v=(m>0?m-1:1)*d|0,b=(m<h-1?m+1:h-2)*d|0,y=m*u|0,f=0,p=1;f<=d-2;f+=2,p+=2)a=_[v+f],i=_[b+f],l[p]=a+i+2*_[g+f],c[p]=i-a,a=_[v+f+1],i=_[b+f+1],l[p+1]=a+i+2*_[g+f+1],c[p+1]=i-a;for(;f<d;++f,++p)a=_[v+f],i=_[b+f],l[p]=a+i+2*_[g+f],c[p]=i-a;for(f=d+1|0,l[0]=l[1],l[f]=l[d],c[0]=c[1],c[f]=c[d],f=0;f<=d-4;f+=4)a=c[f+2],i=c[f+1],o=c[f+3],s=c[f+4],n=l[f+2],r=l[f+3],x[y++]=n-l[f],x[y++]=a+c[f]+2*i,x[y++]=r-l[f+1],x[y++]=o+i+2*a,x[y++]=l[f+4]-n,x[y++]=s+a+2*o,x[y++]=l[f+5]-r,x[y++]=c[f+5]+o+2*s;for(;f<d;++f)x[y++]=l[f+2]-l[f],x[y++]=c[f+2]+c[f]+2*c[f+1]}jsfeat.cache.put_buffer(M),jsfeat.cache.put_buffer(w)},compute_integral_image:function(e,t,a,i){var o=0|e.cols,s=0|e.rows,n=e.data,r=o+1|0,l=0,c=0,d=0,h=0,u=0,f=0,m=0,p=0;if(t&&a){for(;u<r;++u)t[u]=0,a[u]=0;for(d=r+1|0,h=1,u=0,p=0;u<s;++u,++d,++h){for(l=c=0,f=0;f<=o-2;f+=2,p+=2,d+=2,h+=2)l+=m=n[p],c+=m*m,t[d]=t[h]+l,a[d]=a[h]+c,l+=m=n[p+1],c+=m*m,t[d+1]=t[h+1]+l,a[d+1]=a[h+1]+c;for(;f<o;++f,++p,++d,++h)l+=m=n[p],c+=m*m,t[d]=t[h]+l,a[d]=a[h]+c}}else if(t){for(;u<r;++u)t[u]=0;for(d=r+1|0,h=1,u=0,p=0;u<s;++u,++d,++h){for(l=0,f=0;f<=o-2;f+=2,p+=2,d+=2,h+=2)l+=n[p],t[d]=t[h]+l,l+=n[p+1],t[d+1]=t[h+1]+l;for(;f<o;++f,++p,++d,++h)l+=n[p],t[d]=t[h]+l}}else if(a){for(;u<r;++u)a[u]=0;for(d=r+1|0,h=1,u=0,p=0;u<s;++u,++d,++h){for(c=0,f=0;f<=o-2;f+=2,p+=2,d+=2,h+=2)c+=(m=n[p])*m,a[d]=a[h]+c,c+=(m=n[p+1])*m,a[d+1]=a[h+1]+c;for(;f<o;++f,++p,++d,++h)c+=(m=n[p])*m,a[d]=a[h]+c}}if(i){for(u=0;u<r;++u)i[u]=0;for(d=r+1|0,h=0,u=0,p=0;u<s;++u,++d,++h){for(f=0;f<=o-2;f+=2,p+=2,d+=2,h+=2)i[d]=n[p]+i[h],i[d+1]=n[p+1]+i[h+1];for(;f<o;++f,++p,++d,++h)i[d]=n[p]+i[h]}for(d=r+o|0,h=o,u=0;u<s;++u,d+=r,h+=r)i[d]+=i[h];for(f=o-1;f>0;--f)for(h=(d=f+s*r)-r,u=s;u>0;--u,d-=r,h-=r)i[d]+=i[h]+i[h+1]}},equalize_histogram:function(e,t){var a=e.cols,i=e.rows,o=e.data;t.resize(a,i,e.channel);var s,n,r=t.data,l=a*i,c=0,d=0,h=jsfeat.cache.get_buffer(1024);for(s=h.i32;c<256;++c)s[c]=0;for(c=0;c<l;++c)++s[o[c]];for(d=s[0],c=1;c<256;++c)d=s[c]+=d;for(n=255/l,c=0;c<l;++c)r[c]=s[o[c]]*n+.5|0;jsfeat.cache.put_buffer(h)},canny:function(e,t,a,i){var o=e.cols,s=e.rows;e.data;t.resize(o,s,e.channel);var n=t.data,r=0,l=0,c=0,d=o<<1,h=0,u=0,f=0,m=0,p=0,v=0,g=0,b=0,y=jsfeat.cache.get_buffer(s*d<<2),_=jsfeat.cache.get_buffer(3*(o+2)<<2),x=jsfeat.cache.get_buffer((s+2)*(o+2)<<2),M=jsfeat.cache.get_buffer(s*o<<2),w=_.i32,E=x.i32,T=M.i32,S=y.i32,k=new jsfeat.matrix_t(o,s,jsfeat.S32C2_t,y.data),A=1,L=o+2+1|0,R=2*(o+2)+1|0,j=o+2|0,D=j+1|0,C=0;for(this.sobel_derivatives(e,k),a>i&&(r=a,a=i,i=r),r=3*(o+2)|0;--r>=0;)w[r]=0;for(r=(s+2)*(o+2)|0;--r>=0;)E[r]=0;for(;l<o;++l,c+=2)m=S[c],p=S[c+1],w[L+l]=(m^m>>31)-(m>>31)+((p^p>>31)-(p>>31));for(r=1;r<=s;++r,c+=d){if(r==s)for(l=R+o;--l>=R;)w[l]=0;else for(l=0;l<o;l++)m=S[c+(l<<1)],p=S[c+(l<<1)+1],w[R+l]=(m^m>>31)-(m>>31)+((p^p>>31)-(p>>31));for(h=c-d|0,E[D-1]=0,u=0,l=0;l<o;++l,h+=2){if((f=w[L+l])>a)if(m=S[h],p=S[h+1],v=m^p,m=(m^m>>31)-(m>>31)|0,p=(p^p>>31)-(p>>31)|0,g=13573*m,b=g+(m+m<<15),(p<<=15)<g){if(f>w[L+l-1]&&f>=w[L+l+1]){f>i&&!u&&2!=E[D+l-j]?(E[D+l]=2,u=1,T[C++]=D+l):E[D+l]=1;continue}}else if(p>b){if(f>w[A+l]&&f>=w[R+l]){f>i&&!u&&2!=E[D+l-j]?(E[D+l]=2,u=1,T[C++]=D+l):E[D+l]=1;continue}}else if(v=v<0?-1:1,f>w[A+l-v]&&f>w[R+l+v]){f>i&&!u&&2!=E[D+l-j]?(E[D+l]=2,u=1,T[C++]=D+l):E[D+l]=1;continue}E[D+l]=0,u=0}E[D+o]=0,D+=j,l=A,A=L,L=R,R=l}for(l=D-j-1,r=0;r<j;++r,++l)E[l]=0;for(;C>0;)D=T[--C],1==E[D-=j+1]&&(E[D]=2,T[C++]=D),1==E[D+=1]&&(E[D]=2,T[C++]=D),1==E[D+=1]&&(E[D]=2,T[C++]=D),1==E[D+=j]&&(E[D]=2,T[C++]=D),1==E[D-=2]&&(E[D]=2,T[C++]=D),1==E[D+=j]&&(E[D]=2,T[C++]=D),1==E[D+=1]&&(E[D]=2,T[C++]=D),1==E[D+=1]&&(E[D]=2,T[C++]=D);for(D=j+1,A=0,r=0;r<s;++r,D+=j)for(l=0;l<o;++l)n[A++]=255*(2==E[D+l]);jsfeat.cache.put_buffer(y),jsfeat.cache.put_buffer(_),jsfeat.cache.put_buffer(x),jsfeat.cache.put_buffer(M)}};jsfeat.imgproc=e}(),function(e){var t=function(){var e=new Int32Array([0,3,1,3,2,2,3,1,3,0,3,-1,2,-2,1,-3,0,-3,-1,-3,-2,-2,-3,-1,-3,0,-3,1,-2,2,-1,3]),t=new Uint8Array(512),a=new Int32Array(25),i=new Int32Array(25),o=function(e,t,a,i,o){for(var s=0,n=e[t],r=o,l=0,c=0,d=0;s<25;++s)i[s]=n-e[t+a[s]];for(s=0;s<16;s+=2)l=Math.min(i[s+1],i[s+2]),(l=Math.min(l,i[s+3]))<=r||(l=Math.min(l,i[s+4]),l=Math.min(l,i[s+5]),l=Math.min(l,i[s+6]),l=Math.min(l,i[s+7]),l=Math.min(l,i[s+8]),r=Math.max(r,Math.min(l,i[s])),r=Math.max(r,Math.min(l,i[s+9])));for(c=-r,s=0;s<16;s+=2)d=Math.max(i[s+1],i[s+2]),d=Math.max(d,i[s+3]),d=Math.max(d,i[s+4]),(d=Math.max(d,i[s+5]))>=c||(d=Math.max(d,i[s+6]),d=Math.max(d,i[s+7]),d=Math.max(d,i[s+8]),c=Math.min(c,Math.max(d,i[s])),c=Math.min(c,Math.max(d,i[s+9])));return-c-1},s=20;return{set_threshold:function(e){s=Math.min(Math.max(e,0),255);for(var a=-255;a<=255;++a)t[a+255]=a<-s?1:a>s?2:0;return s},detect:function(n,r,l){void 0===l&&(l=3);var c,d=n.data,h=n.cols,u=n.rows,f=0,m=0,p=0,v=0,g=0,b=jsfeat.cache.get_buffer(3*h),y=jsfeat.cache.get_buffer(3*(h+1)<<2),_=b.u8,x=y.i32,M=a,w=i,E=Math.max(3,l),T=Math.min(u-2,u-l),S=Math.max(3,l),k=Math.min(h-3,h-l),A=0,L=0,R=o,j=t,D=s,C=0,I=0,P=0,z=0,H=0,V=0,O=0,B=0,F=0,N=0,$=0,q=0;!function(t,a,i){for(var o=0,s=e;o<i;++o)t[o]=s[o<<1]+s[1+(o<<1)]*a;for(;o<25;++o)t[o]=t[o-i]}(M,h,16);var U=M[0],W=M[1],G=M[2],Z=M[3],X=M[4],Y=M[5],J=M[6],Q=M[7],K=M[8],ee=M[9],te=M[10],ae=M[11],ie=M[12],oe=M[13],se=M[14],ne=M[15];for(f=0;f<3*h;++f)_[f]=0;for(f=E;f<T;++f){for(O=f*h+S|0,V=(g=(f-3)%3)*h|0,H=g*(h+1)|0,m=0;m<h;++m)_[V+m]=0;if(z=0,f<T-1)for(m=S;m<k;++m,++O)if(C=d[O],I=255-C,0!=(P=j[I+d[O+U]]|j[I+d[O+K]])&&(P&=j[I+d[O+G]]|j[I+d[O+te]],P&=j[I+d[O+X]]|j[I+d[O+ie]],0!=(P&=j[I+d[O+J]]|j[I+d[O+se]]))){if(P&=j[I+d[O+W]]|j[I+d[O+ee]],P&=j[I+d[O+Z]]|j[I+d[O+ae]],P&=j[I+d[O+Y]]|j[I+d[O+oe]],1&(P&=j[I+d[O+Q]]|j[I+d[O+ne]]))for(v=C-D,A=0,p=0;p<25;++p)if(d[O+M[p]]<v){if(++A>8){x[H+ ++z]=m,_[V+m]=R(d,O,M,w,D);break}}else A=0;if(2&P)for(v=C+D,A=0,p=0;p<25;++p)if(d[O+M[p]]>v){if(++A>8){x[H+ ++z]=m,_[V+m]=R(d,O,M,w,D);break}}else A=0}if(x[H+h]=z,f!=E)for(B=(g=(f-4+3)%3)*h|0,H=g*(h+1)|0,F=(g=(f-5+3)%3)*h|0,z=x[H+h],p=0;p<z;++p)N=(m=x[H+p])+1|0,$=m-1|0,(q=_[B+m])>_[B+N]&&q>_[B+$]&&q>_[F+$]&&q>_[F+m]&&q>_[F+N]&&q>_[V+$]&&q>_[V+m]&&q>_[V+N]&&((c=r[L]).x=m,c.y=f-1,c.score=q,L++)}return jsfeat.cache.put_buffer(b),jsfeat.cache.put_buffer(y),L}}}();e.fast_corners=t,t.set_threshold(20)}(jsfeat),function(e){var t=function(){var e=function(e,t,a,i,o,s,n){var r=-2*e[t]+e[t+i]+e[t-i],l=-2*e[t]+e[t+o]+e[t-o],c=e[t+s]+e[t-s]-e[t+n]-e[t-n],d=0|Math.sqrt((r-l)*(r-l)+4*c*c);return Math.min(Math.abs(a-d),Math.abs(-(a+d)))};return{laplacian_threshold:30,min_eigen_value_threshold:25,detect:function(t,a,i){void 0===i&&(i=5);var o,s=0,n=0,r=t.cols,l=t.rows,c=t.data,d=5*r|0,h=3+3*r|0,u=3-3*r|0,f=jsfeat.cache.get_buffer(r*l<<2),m=f.i32,p=0,v=0,g=0,b=0,y=0,_=this.laplacian_threshold,x=this.min_eigen_value_threshold,M=0|Math.max(5,i),w=0|Math.max(3,i),E=0|Math.min(r-5,r-i),T=0|Math.min(l-3,l-i);for(s=r*l;--s>=0;)m[s]=0;for(function(e,t,a,i,o,s,n,r,l,c){var d=0,h=0,u=r*a+n|0,f=u;for(d=r;d<c;++d,u+=a,f=u)for(h=n;h<l;++h,++f)t[f]=-4*e[f]+e[f+o]+e[f-o]+e[f+s]+e[f-s]}(c,m,r,0,5,d,M,w,E,T),v=w*r+M|0,n=w;n<T;++n,v+=r)for(s=M,g=v;s<E;++s,++g)((p=m[g])<-_&&p<m[g-1]&&p<m[g+1]&&p<m[g-r]&&p<m[g+r]&&p<m[g-r-1]&&p<m[g+r-1]&&p<m[g-r+1]&&p<m[g+r+1]||p>_&&p>m[g-1]&&p>m[g+1]&&p>m[g-r]&&p>m[g+r]&&p>m[g-r-1]&&p>m[g+r-1]&&p>m[g-r+1]&&p>m[g+r+1])&&(b=e(c,g,p,5,d,h,u))>x&&((o=a[y]).x=s,o.y=n,o.score=b,++y,++s,++g);return jsfeat.cache.put_buffer(f),y}}}();e.yape06=t}(jsfeat),function(e){var t=function(){var e=function(e,t,a){var i,o,s=0;for(i=a,o=0;o<i;o++,s++)i=Math.sqrt(a*a-o*o)+.5|0,t[s]=i+e*o;for(i--;i<o&&i>=0;i--,s++)o=Math.sqrt(a*a-i*i)+.5|0,t[s]=i+e*o;for(;-i<o;i--,s++)o=Math.sqrt(a*a-i*i)+.5|0,t[s]=i+e*o;for(o--;o>=0;o--,s++)i=-Math.sqrt(a*a-o*o)-.5|0,t[s]=i+e*o;for(;o>i;o--,s++)i=-Math.sqrt(a*a-o*o)-.5|0,t[s]=i+e*o;for(i++;i<=0;i++,s++)o=-Math.sqrt(a*a-i*i)-.5|0,t[s]=i+e*o;for(;i<-o;i++,s++)o=-Math.sqrt(a*a-i*i)-.5|0,t[s]=i+e*o;for(o++;o<0;o++,s++)i=Math.sqrt(a*a-o*o)+.5|0,t[s]=i+e*o;return t[s]=t[0],t[s+1]=t[1],s},t=function(e,t,a){var i=0;return 0!=e[t+1]&&i++,0!=e[t-1]&&i++,0!=e[t+a]&&i++,0!=e[t+a+1]&&i++,0!=e[t+a-1]&&i++,0!=e[t-a]&&i++,0!=e[t-a+1]&&i++,0!=e[t-a-1]&&i++,i},a=function(e,t,a,i,o){var s,n;if(a>0)for(t-=i*o,n=-o;n<=o;++n){for(s=-o;s<=o;++s)if(e[t+s]>a)return!1;t+=i}else for(t-=i*o,n=-o;n<=o;++n){for(s=-o;s<=o;++s)if(e[t+s]<a)return!1;t+=i}return!0},i=function(e,t,a,i,o,s,n,r){var l=0,c=0,d=n-1|0,h=0,u=0,f=0,m=0,p=0;if((h=e[t+s[c]])<=o)if(h>=i)if((u=e[t+s[d]])<=o){if(u>=i)return void(a[t]=0);if(d++,(f=e[t+s[d]])>o)if(d++,(m=e[t+s[d]])>o)p=3;else{if(!(m<i))return void(a[t]=0);p=6}else if(d++,(m=e[t+s[d]])>o)p=7;else{if(!(m<i))return void(a[t]=0);p=2}}else if(d++,(f=e[t+s[d]])>o)if(d++,(m=e[t+s[d]])>o)p=3;else{if(!(m<i))return void(a[t]=0);p=6}else{if(!(f<i))return void(a[t]=0);if(d++,(m=e[t+s[d]])>o)p=7;else{if(!(m<i))return void(a[t]=0);p=2}}else{if((u=e[t+s[d]])>o)return void(a[t]=0);if(d++,(f=e[t+s[d]])>o)return void(a[t]=0);if(d++,(m=e[t+s[d]])>o)return void(a[t]=0);p=1}else{if((u=e[t+s[d]])<i)return void(a[t]=0);if(d++,(f=e[t+s[d]])<i)return void(a[t]=0);if(d++,(m=e[t+s[d]])<i)return void(a[t]=0);p=0}for(c=1;c<=n;c++)switch(h=e[t+s[c]],p){case 0:if(h>o){if(f=m,d++,(m=e[t+s[d]])<i)return void(a[t]=0);l-=h+f,p=0;break}if(h<i){if(f>o)return void(a[t]=0);if(m>o)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])>o)return void(a[t]=0);l-=h+f,p=8;break}if(f<=o)return void(a[t]=0);if(m<=o)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])>o){l-=h+f,p=3;break}if(m<i){l-=h+f,p=6;break}return void(a[t]=0);case 1:if(h<i){if(f=m,d++,(m=e[t+s[d]])>o)return void(a[t]=0);l-=h+f,p=1;break}if(h>o){if(f<i)return void(a[t]=0);if(m<i)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])<i)return void(a[t]=0);l-=h+f,p=9;break}if(f>=i)return void(a[t]=0);if(m>=i)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])<i){l-=h+f,p=2;break}if(m>o){l-=h+f,p=7;break}return void(a[t]=0);case 2:if(h>o)return void(a[t]=0);if(f=m,d++,m=e[t+s[d]],h<i){if(m>o)return void(a[t]=0);l-=h+f,p=4;break}if(m>o){l-=h+f,p=7;break}if(m<i){l-=h+f,p=2;break}return void(a[t]=0);case 3:if(h<i)return void(a[t]=0);if(f=m,d++,m=e[t+s[d]],h>o){if(m<i)return void(a[t]=0);l-=h+f,p=5;break}if(m>o){l-=h+f,p=3;break}if(m<i){l-=h+f,p=6;break}return void(a[t]=0);case 4:if(h>o)return void(a[t]=0);if(h<i){if(f=m,d++,(m=e[t+s[d]])>o)return void(a[t]=0);l-=h+f,p=1;break}if(m>=i)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])<i){l-=h+f,p=2;break}if(m>o){l-=h+f,p=7;break}return void(a[t]=0);case 5:if(h<i)return void(a[t]=0);if(h>o){if(f=m,d++,(m=e[t+s[d]])<i)return void(a[t]=0);l-=h+f,p=0;break}if(m<=o)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])>o){l-=h+f,p=3;break}if(m<i){l-=h+f,p=6;break}return void(a[t]=0);case 7:if(h>o)return void(a[t]=0);if(h<i)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])>o){l-=h+f,p=3;break}if(m<i){l-=h+f,p=6;break}return void(a[t]=0);case 6:if(h>o)return void(a[t]=0);if(h<i)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])<i){l-=h+f,p=2;break}if(m>o){l-=h+f,p=7;break}return void(a[t]=0);case 8:if(h>o){if(m<i)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])<i)return void(a[t]=0);l-=h+f,p=9;break}if(h<i){if(f=m,d++,(m=e[t+s[d]])>o)return void(a[t]=0);l-=h+f,p=1;break}return void(a[t]=0);case 9:if(h<i){if(m>o)return void(a[t]=0);if(f=m,d++,(m=e[t+s[d]])>o)return void(a[t]=0);l-=h+f,p=8;break}if(h>o){if(f=m,d++,(m=e[t+s[d]])<i)return void(a[t]=0);l-=h+f,p=0;break}return void(a[t]=0)}a[t]=l+r*e[t]},o=function(){return function(t,a,i){this.dirs=new Int32Array(1024),this.dirs_count=0|e(t,this.dirs,i),this.scores=new Int32Array(t*a),this.radius=0|i}}();return{level_tables:[],tau:7,init:function(e,t,a,i){void 0===i&&(i=1);var s;for(a=Math.min(a,7),a=Math.max(a,3),s=0;s<i;++s)this.level_tables[s]=new o(e>>s,t>>s,a)},detect:function(e,o,s){void 0===s&&(s=4);var n,r=this.level_tables[0],l=0|r.radius,c=l-1|0,d=r.dirs,h=0|r.dirs_count,u=h>>1,f=e.data,m=0|e.cols,p=0|e.rows,v=m>>1,g=r.scores,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0|this.tau,k=0,A=0|Math.max(l+1,s),L=0|Math.max(l+1,s),R=0|Math.min(m-l-2,m-s),j=0|Math.min(p-l-2,p-s);for(_=L*m+A|0,y=L;y<j;++y,_+=m)for(b=A,x=_;b<R;++b,++x)M=f[x]+S,(w=f[x]-S)<f[x+l]&&f[x+l]<M&&w<f[x-l]&&f[x-l]<M?g[x]=0:i(f,x,g,w,M,d,u,h);for(_=L*m+A|0,y=L;y<j;++y,_+=m)for(b=A,x=_;b<R;++b,++x)T=g[x],(E=Math.abs(T))<5?(++b,++x):t(g,x,m)>=3&&a(g,x,T,v,l)&&((n=o[k]).x=b,n.y=y,n.score=E,++k,b+=c,x+=c);return k}}}();e.yape=t}(jsfeat),function(e){var t=function(){var e=function(e,t){var a=.25*e.width+.5|0;return t.x<=e.x+a&&t.x>=e.x-a&&t.y<=e.y+a&&t.y>=e.y-a&&t.width<=1.5*e.width+.5|0&&1.5*t.width+.5|0>=e.width};return{edges_density:.07,detect_single_scale:function(e,t,a,i,o,s,n,r){var l,c,d,h,u,f,m,p,v,g,b,y,_,x,M,w,E,T,S,k,A,L,R,j,D,C=r.size[0]*n|0,I=r.size[1]*n|0,P=.5*n+1.5|0,z=P,H=o-C|0,V=s-I|0,O=o+1|0,B=1/(C*I),F=!0,N=0,$=C,q=I*O,U=q+C,W=C*I*255*this.edges_density|0,G=[];for(u=0;u<V;u+=z)for(N=u*O,h=0;h<H;h+=P,N+=P)if(f=e[N]-e[N+$]-e[N+q]+e[N+U],i&&(i[N]-i[N+$]-i[N+q]+i[N+U]<W||f<20))h+=P,N+=P;else{for(f*=B,p=(m=(t[N]-t[N+$]-t[N+q]+t[N+U])*B-f*f)>0?Math.sqrt(m):1,_=(v=r.complexClassifiers).length,F=!0,l=0;l<_;++l){for(w=(g=v[l]).threshold,x=(b=g.simpleClassifiers).length,E=0,c=0;c<x;++c){if(y=b[c],T=0,k=y.features,M=k.length,1===y.tilted)for(d=0;d<M;++d)A=~~(h+(S=k[d])[0]*n)+~~(u+S[1]*n)*O,L=(j=~~(S[2]*n))*O,R=(D=~~(S[3]*n))*O,T+=(a[A]-a[A+j+L]-a[A-D+R]+a[A+j-D+L+R])*S[4];else for(d=0;d<M;++d)A=~~(h+(S=k[d])[0]*n)+~~(u+S[1]*n)*O,j=~~(S[2]*n),R=(D=~~(S[3]*n))*O,T+=(e[A]-e[A+j]-e[A+R]+e[A+R+j])*S[4];E+=T*B<y.threshold*p?y.left_val:y.right_val}if(E<w){F=!1;break}}F&&(G.push({x:h,y:u,width:C,height:I,neighbor:1,confidence:E}),h+=P,N+=P)}return G},detect_multi_scale:function(e,t,a,i,o,s,n,r,l){void 0===r&&(r=1.2),void 0===l&&(l=1);for(var c=n.size[0],d=n.size[1],h=[];l*c<o&&l*d<s;)h=h.concat(this.detect_single_scale(e,t,a,i,o,s,l,n)),l*=r;return h},group_rectangles:function(t,a){void 0===a&&(a=1);var i,o,s=t.length,n=[];for(i=0;i<s;++i)n[i]={parent:-1,element:t[i],rank:0};for(i=0;i<s;++i)if(n[i].element){for(var r=i;-1!=n[r].parent;)r=n[r].parent;for(o=0;o<s;++o)if(i!=o&&n[o].element&&e(n[i].element,n[o].element)){for(var l=o;-1!=n[l].parent;)l=n[l].parent;if(l!=r){n[r].rank>n[l].rank?n[l].parent=r:(n[r].parent=l,n[r].rank==n[l].rank&&n[l].rank++,r=l);for(var c,d=o;-1!=n[d].parent;)c=d,d=n[d].parent,n[c].parent=r;for(d=i;-1!=n[d].parent;)c=d,d=n[d].parent,n[c].parent=r}}}var h=[],u=0;for(i=0;i<s;i++){o=-1;var f=i;if(n[f].element){for(;-1!=n[f].parent;)f=n[f].parent;n[f].rank>=0&&(n[f].rank=~u++),o=~n[f].rank}h[i]=o}var m=[];for(i=0;i<u+1;++i)m[i]={neighbors:0,x:0,y:0,width:0,height:0,confidence:0};for(i=0;i<s;++i){var p=t[i],v=h[i];0==m[v].neighbors&&(m[v].confidence=p.confidence),++m[v].neighbors,m[v].x+=p.x,m[v].y+=p.y,m[v].width+=p.width,m[v].height+=p.height,m[v].confidence=Math.max(m[v].confidence,p.confidence)}var g=[];for(i=0;i<u;++i)(s=m[i].neighbors)>=a&&g.push({x:(2*m[i].x+s)/(2*s),y:(2*m[i].y+s)/(2*s),width:(2*m[i].width+s)/(2*s),height:(2*m[i].height+s)/(2*s),neighbors:m[i].neighbors,confidence:m[i].confidence});var b=[];for(s=g.length,i=0;i<s;++i){p=g[i];var y=!0;for(o=0;o<s;++o){var _=g[o],x=.25*_.width+.5|0;if(i!=o&&p.x>=_.x-x&&p.y>=_.y-x&&p.x+p.width<=_.x+_.width+x&&p.y+p.height<=_.y+_.height+x&&(_.neighbors>Math.max(3,p.neighbors)||p.neighbors<3)){y=!1;break}}y&&b.push(p)}return b}}}();e.haar=t}(jsfeat),function(e){var t=function(){var e=function(e,t){var a=.25*e.width+.5|0;return t.x<=e.x+a&&t.x>=e.x-a&&t.y<=e.y+a&&t.y>=e.y-a&&t.width<=1.5*e.width+.5|0&&1.5*t.width+.5|0>=e.width},t=new jsfeat.pyramid_t(1);return{interval:4,scale:1.1486,next:5,scale_to:1,prepare_cascade:function(e){for(var t=e.stage_classifier.length,a=0;a<t;a++)for(var i=e.stage_classifier[a].feature,o=e.stage_classifier[a].count,s=e.stage_classifier[a]._feature=new Array(o),n=0;n<o;n++)s[n]={size:i[n].size,px:new Array(i[n].size),pz:new Array(i[n].size),nx:new Array(i[n].size),nz:new Array(i[n].size)}},build_pyramid:function(e,a,i,o){void 0===o&&(o=4);var s=e.cols,n=e.rows,r=0,l=0,c=0,d=!1,h=e,u=e,f=jsfeat.U8_t|jsfeat.C1_t;this.interval=o,this.scale=Math.pow(2,1/(this.interval+1)),this.next=this.interval+1|0,this.scale_to=Math.log(Math.min(s/a,n/i))/Math.log(this.scale)|0;var m=4*(this.scale_to+2*this.next)|0;for(t.levels!=m&&(t.levels=m,t.data=new Array(m),d=!0,t.data[0]=e),r=1;r<=this.interval;++r)l=s/Math.pow(this.scale,r)|0,c=n/Math.pow(this.scale,r)|0,h=t.data[r<<2],(d||l!=h.cols||c!=h.rows)&&(t.data[r<<2]=new jsfeat.matrix_t(l,c,f),h=t.data[r<<2]),jsfeat.imgproc.resample(e,h,l,c);for(r=this.next;r<this.scale_to+2*this.next;++r)u=t.data[(r<<2)-(this.next<<2)],h=t.data[r<<2],l=u.cols>>1,c=u.rows>>1,(d||l!=h.cols||c!=h.rows)&&(t.data[r<<2]=new jsfeat.matrix_t(l,c,f),h=t.data[r<<2]),jsfeat.imgproc.pyrdown(u,h);for(r=2*this.next;r<this.scale_to+2*this.next;++r)l=(u=t.data[(r<<2)-(this.next<<2)]).cols>>1,c=u.rows>>1,h=t.data[1+(r<<2)],(d||l!=h.cols||c!=h.rows)&&(t.data[1+(r<<2)]=new jsfeat.matrix_t(l,c,f),h=t.data[1+(r<<2)]),jsfeat.imgproc.pyrdown(u,h,1,0),h=t.data[2+(r<<2)],(d||l!=h.cols||c!=h.rows)&&(t.data[2+(r<<2)]=new jsfeat.matrix_t(l,c,f),h=t.data[2+(r<<2)]),jsfeat.imgproc.pyrdown(u,h,0,1),h=t.data[3+(r<<2)],(d||l!=h.cols||c!=h.rows)&&(t.data[3+(r<<2)]=new jsfeat.matrix_t(l,c,f),h=t.data[3+(r<<2)]),jsfeat.imgproc.pyrdown(u,h,1,1);return t},detect:function(e,t){this.interval;var a,i,o,s,n,r=this.scale,l=this.next,c=this.scale_to,d=0,h=0,u=0,f=0,m=0,p=0,v=0,g=0,b=0,y=0,_=0,x=0,M=0,w=0,E=0,T=0,S=0,k=0,A=!0,L=!0,R=1,j=1,D=[0,1,0,1],C=[0,0,1,1],I=[],P=e.data,z=[],H=[0,0,0],V=[0,0,0],O=[0,0,0];for(d=0;d<c;d++){for(T=P[(E=d<<2)+(l<<3)].cols-(t.width>>2),S=P[E+(l<<3)].rows-(t.height>>2),V[0]=1*P[E].cols,V[1]=1*P[E+(l<<2)].cols,V[2]=1*P[E+(l<<3)].cols,O[0]=4*P[E].cols-4*T,O[1]=2*P[E+(l<<2)].cols-2*T,O[2]=1*P[E+(l<<3)].cols-1*T,g=t.stage_classifier.length,h=0;h<g;h++)for(o=t.stage_classifier[h].feature,i=t.stage_classifier[h]._feature,b=t.stage_classifier[h].count,u=0;u<b;u++)for(s=i[u],y=0|(n=o[u]).size,v=0;v<y;v++)s.px[v]=1*n.px[v]+n.py[v]*V[n.pz[v]],s.pz[v]=n.pz[v],s.nx[v]=1*n.nx[v]+n.ny[v]*V[n.nz[v]],s.nz[v]=n.nz[v];for(z[0]=P[E].data,z[1]=P[E+(l<<2)].data,v=0;v<4;v++)for(z[2]=P[E+(l<<3)+v].data,H[0]=2*D[v]+C[v]*(2*P[E].cols),H[1]=1*D[v]+C[v]*(1*P[E+(l<<2)].cols),H[2]=0,p=0;p<S;p++){for(m=0;m<T;m++){for(k=0,A=!0,g=t.stage_classifier.length,h=0;h<g;h++){for(k=0,a=t.stage_classifier[h].alpha,i=t.stage_classifier[h]._feature,b=t.stage_classifier[h].count,u=0;u<b;u++)if(s=i[u],x=z[s.pz[0]][H[s.pz[0]]+s.px[0]],M=z[s.nz[0]][H[s.nz[0]]+s.nx[0]],x<=M)k+=a[u<<1];else{for(L=!0,y=s.size,w=1;w<y;w++){if(s.pz[w]>=0&&(_=z[s.pz[w]][H[s.pz[w]]+s.px[w]])<x){if(_<=M){L=!1;break}x=_}if(s.nz[w]>=0&&(f=z[s.nz[w]][H[s.nz[w]]+s.nx[w]])>M){if(x<=f){L=!1;break}M=f}}k+=L?a[1+(u<<1)]:a[u<<1]}if(k<t.stage_classifier[h].threshold){A=!1;break}}A&&(I.push({x:(4*m+2*D[v])*R,y:(4*p+2*C[v])*j,width:t.width*R,height:t.height*j,neighbor:1,confidence:k}),++m,H[0]+=4,H[1]+=2,H[2]+=1),H[0]+=4,H[1]+=2,H[2]+=1}H[0]+=O[0],H[1]+=O[1],H[2]+=O[2]}R*=r,j*=r}return I},group_rectangles:function(t,a){void 0===a&&(a=1);var i,o,s=t.length,n=[];for(i=0;i<s;++i)n[i]={parent:-1,element:t[i],rank:0};for(i=0;i<s;++i)if(n[i].element){for(var r=i;-1!=n[r].parent;)r=n[r].parent;for(o=0;o<s;++o)if(i!=o&&n[o].element&&e(n[i].element,n[o].element)){for(var l=o;-1!=n[l].parent;)l=n[l].parent;if(l!=r){n[r].rank>n[l].rank?n[l].parent=r:(n[r].parent=l,n[r].rank==n[l].rank&&n[l].rank++,r=l);for(var c,d=o;-1!=n[d].parent;)c=d,d=n[d].parent,n[c].parent=r;for(d=i;-1!=n[d].parent;)c=d,d=n[d].parent,n[c].parent=r}}}var h=[],u=0;for(i=0;i<s;i++){o=-1;var f=i;if(n[f].element){for(;-1!=n[f].parent;)f=n[f].parent;n[f].rank>=0&&(n[f].rank=~u++),o=~n[f].rank}h[i]=o}var m=[];for(i=0;i<u+1;++i)m[i]={neighbors:0,x:0,y:0,width:0,height:0,confidence:0};for(i=0;i<s;++i){var p=t[i],v=h[i];0==m[v].neighbors&&(m[v].confidence=p.confidence),++m[v].neighbors,m[v].x+=p.x,m[v].y+=p.y,m[v].width+=p.width,m[v].height+=p.height,m[v].confidence=Math.max(m[v].confidence,p.confidence)}var g=[];for(i=0;i<u;++i)(s=m[i].neighbors)>=a&&g.push({x:(2*m[i].x+s)/(2*s),y:(2*m[i].y+s)/(2*s),width:(2*m[i].width+s)/(2*s),height:(2*m[i].height+s)/(2*s),neighbors:m[i].neighbors,confidence:m[i].confidence});var b=[];for(s=g.length,i=0;i<s;++i){p=g[i];var y=!0;for(o=0;o<s;++o){var _=g[o],x=.25*_.width+.5|0;if(i!=o&&p.x>=_.x-x&&p.y>=_.y-x&&p.x+p.width<=_.x+_.width+x&&p.y+p.height<=_.y+_.height+x&&(_.neighbors>Math.max(3,p.neighbors)||p.neighbors<3)){y=!1;break}}y&&b.push(p)}return b}}}();e.bbf=t}(jsfeat),function(e){"undefined"==typeof module||void 0===module.exports?window.jsfeat=e:module.exports=e}(jsfeat);var SVD=SVD||{};SVD.svdcmp=function(e,t,a,i,o){var s,n,r,l,c,d,h,u,f,m,p,v,g,b,y,_=0,x=0,M=0,w=[];for(n=0;n<a;++n){if(h=n+1,w[n]=M*x,x=v=M=0,n<t){for(d=n;d<t;++d)M+=Math.abs(e[d][n]);if(0!==M){for(d=n;d<t;++d)e[d][n]/=M,v+=e[d][n]*e[d][n];for(p=(m=e[n][n])*(x=-SVD.sign(Math.sqrt(v),m))-v,e[n][n]=m-x,l=h;l<a;++l){for(v=0,d=n;d<t;++d)v+=e[d][n]*e[d][l];for(m=v/p,d=n;d<t;++d)e[d][l]+=m*e[d][n]}for(d=n;d<t;++d)e[d][n]*=M}}if(i[n]=M*x,x=v=M=0,n<t&&n!==a-1){for(d=h;d<a;++d)M+=Math.abs(e[n][d]);if(0!==M){for(d=h;d<a;++d)e[n][d]/=M,v+=e[n][d]*e[n][d];for(p=(m=e[n][h])*(x=-SVD.sign(Math.sqrt(v),m))-v,e[n][h]=m-x,d=h;d<a;++d)w[d]=e[n][d]/p;for(l=h;l<t;++l){for(v=0,d=h;d<a;++d)v+=e[l][d]*e[n][d];for(d=h;d<a;++d)e[l][d]+=v*w[d]}for(d=h;d<a;++d)e[n][d]*=M}}_=Math.max(_,Math.abs(i[n])+Math.abs(w[n]))}for(n=a-1;n>=0;--n){if(n<a-1){if(0!==x){for(l=h;l<a;++l)o[l][n]=e[n][l]/e[n][h]/x;for(l=h;l<a;++l){for(v=0,d=h;d<a;++d)v+=e[n][d]*o[d][l];for(d=h;d<a;++d)o[d][l]+=v*o[d][n]}}for(l=h;l<a;++l)o[n][l]=o[l][n]=0}o[n][n]=1,x=w[n],h=n}for(n=Math.min(a,t)-1;n>=0;--n){for(h=n+1,x=i[n],l=h;l<a;++l)e[n][l]=0;if(0!==x){for(x=1/x,l=h;l<a;++l){for(v=0,d=h;d<t;++d)v+=e[d][n]*e[d][l];for(m=v/e[n][n]*x,d=n;d<t;++d)e[d][l]+=m*e[d][n]}for(l=n;l<t;++l)e[l][n]*=x}else for(l=n;l<t;++l)e[l][n]=0;++e[n][n]}for(d=a-1;d>=0;--d)for(r=1;r<=30;++r){for(s=!0,h=d;h>=0;--h){if(u=h-1,Math.abs(w[h])+_===_){s=!1;break}if(Math.abs(i[u])+_===_)break}if(s)for(f=0,v=1,n=h;n<=d&&(m=v*w[n],Math.abs(m)+_!==_);++n)for(x=i[n],p=SVD.pythag(m,x),i[n]=p,f=x*(p=1/p),v=-m*p,l=1;l<=t;++l)b=e[l][u],y=e[l][n],e[l][u]=b*f+y*v,e[l][n]=y*f-b*v;if(y=i[d],h===d){if(y<0)for(i[d]=-y,l=0;l<a;++l)o[l][d]=-o[l][d];break}if(30===r)return!1;for(g=i[h],m=(((b=i[u=d-1])-y)*(b+y)+((x=w[u])-(p=w[d]))*(x+p))/(2*p*b),x=SVD.pythag(m,1),m=((g-y)*(g+y)+p*(b/(m+SVD.sign(x,m))-p))/g,f=v=1,l=h;l<=u;++l){for(x=w[n=l+1],b=i[n],p=v*x,x*=f,y=SVD.pythag(m,p),w[l]=y,m=g*(f=m/y)+x*(v=p/y),x=x*f-g*v,p=b*v,b*=f,c=0;c<a;++c)g=o[c][l],y=o[c][n],o[c][l]=g*f+y*v,o[c][n]=y*f-g*v;for(y=SVD.pythag(m,p),i[l]=y,0!==y&&(f=m*(y=1/y),v=p*y),m=f*x+v*b,g=f*b-v*x,c=0;c<t;++c)b=e[c][l],y=e[c][n],e[c][l]=b*f+y*v,e[c][n]=y*f-b*v}w[h]=0,w[d]=m,i[d]=g}return!0},SVD.pythag=function(e,t){var a,i=Math.abs(e),o=Math.abs(t);return i>o?(a=o/i,i*Math.sqrt(1+a*a)):0===o?0:(a=i/o,o*Math.sqrt(1+a*a))},SVD.sign=function(e,t){return t>=0?Math.abs(e):-Math.abs(e)};var POS=POS||{};POS.Posit=function(e,t){this.model=this.buildModel(e),this.focalLength=t,this.init()},POS.Posit.prototype.buildModel=function(e){var t=e/2;return[new Vec3(-t,t,0),new Vec3(t,t,0),new Vec3(t,-t,0),new Vec3(-t,-t,0)]},POS.Posit.prototype.init=function(){var e,t=new Vec3,a=new Mat3;this.modelVectors=Mat3.fromRows(Vec3.sub(this.model[1],this.model[0]),Vec3.sub(this.model[2],this.model[0]),Vec3.sub(this.model[3],this.model[0])),e=Mat3.clone(this.modelVectors),SVD.svdcmp(e.m,3,3,t.v,a.m),this.modelPseudoInverse=Mat3.mult(Mat3.mult(a,Mat3.fromDiagonal(Vec3.inverse(t))),Mat3.transpose(e)),this.modelNormal=a.column(t.minIndex())},POS.Posit.prototype.pose=function(e){var t,a,i=new Vec3(1,1,1),o=new Mat3,s=new Mat3,n=new Vec3,r=new Vec3;return this.pos(e,i,o,s,n,r),t=this.iterate(e,o,n),a=this.iterate(e,s,r),t<a?new POS.Pose(t,o.m,n.v,a,s.m,r.v):new POS.Pose(a,s.m,r.v,t,o.m,n.v)},POS.Posit.prototype.pos=function(e,t,a,i,o,s){var n,r,l,c,d,h,u,f,m,p=new Vec3(e[1].x,e[2].x,e[3].x),v=new Vec3(e[1].y,e[2].y,e[3].y),g=Vec3.addScalar(Vec3.mult(p,t),-e[0].x),b=Vec3.addScalar(Vec3.mult(v,t),-e[0].y),y=Mat3.multVector(this.modelPseudoInverse,g),_=Mat3.multVector(this.modelPseudoInverse,b),x=_.square()-y.square(),M=Vec3.dot(y,_),w=0,E=0;0===x?(w=Math.sqrt(Math.abs(2*M)),E=-Math.PI/2*(M<0?-1:M>0?1:0)):(w=Math.sqrt(Math.sqrt(x*x+4*M*M)),E=Math.atan(-2*M/x),x<0&&(E+=Math.PI),E/=2),f=w*Math.cos(E),m=w*Math.sin(E),n=Vec3.add(y,Vec3.multScalar(this.modelNormal,f)),r=Vec3.add(_,Vec3.multScalar(this.modelNormal,m)),c=n.normalize(),d=r.normalize(),l=Vec3.cross(n,r),a.copy(Mat3.fromRows(n,r,l)),h=(c+d)/2,u=Mat3.multVector(a,this.model[0]),o.v=[e[0].x/h-u.v[0],e[0].y/h-u.v[1],this.focalLength/h],n=Vec3.sub(y,Vec3.multScalar(this.modelNormal,f)),r=Vec3.sub(_,Vec3.multScalar(this.modelNormal,m)),c=n.normalize(),d=r.normalize(),l=Vec3.cross(n,r),i.copy(Mat3.fromRows(n,r,l)),h=(c+d)/2,u=Mat3.multVector(i,this.model[0]),s.v=[e[0].x/h-u.v[0],e[0].y/h-u.v[1],this.focalLength/h]},POS.Posit.prototype.iterate=function(e,t,a){for(var i,o,s,n,r=1/0,l=new Mat3,c=new Mat3,d=new Vec3,h=new Vec3,u=0;u<100&&(i=Vec3.addScalar(Vec3.multScalar(Mat3.multVector(this.modelVectors,t.row(2)),1/a.v[2]),1),this.pos(e,i,l,c,d,h),s=this.getError(e,l,d),n=this.getError(e,c,h),s<n?(t.copy(l),a.copy(d),o=s):(t.copy(c),a.copy(h),o=n),!(o<=2||o>r));++u)r=o;return o},POS.Posit.prototype.getError=function(e,t,a){var i,o,s,n,r,l,c,d,h,u=Vec3.add(Mat3.multVector(t,this.model[0]),a),f=Vec3.add(Mat3.multVector(t,this.model[1]),a),m=Vec3.add(Mat3.multVector(t,this.model[2]),a),p=Vec3.add(Mat3.multVector(t,this.model[3]),a);return u=u.v,f=f.v,m=m.v,p=p.v,u[0]*=this.focalLength/u[2],u[1]*=this.focalLength/u[2],f[0]*=this.focalLength/f[2],f[1]*=this.focalLength/f[2],m[0]*=this.focalLength/m[2],m[1]*=this.focalLength/m[2],p[0]*=this.focalLength/p[2],p[1]*=this.focalLength/p[2],i=[{x:u[0],y:u[1]},{x:f[0],y:f[1]},{x:m[0],y:m[1]},{x:p[0],y:p[1]}],o=this.angle(e[0],e[1],e[3]),s=this.angle(e[1],e[2],e[0]),n=this.angle(e[2],e[3],e[1]),r=this.angle(e[3],e[0],e[2]),l=this.angle(i[0],i[1],i[3]),c=this.angle(i[1],i[2],i[0]),d=this.angle(i[2],i[3],i[1]),h=this.angle(i[3],i[0],i[2]),(Math.abs(o-l)+Math.abs(s-c)+Math.abs(n-d)+Math.abs(r-h))/4},POS.Posit.prototype.angle=function(e,t,a){var i=t.x-e.x,o=t.y-e.y,s=a.x-e.x,n=a.y-e.y;return 180*Math.acos((i*s+o*n)/(Math.sqrt(i*i+o*o)*Math.sqrt(s*s+n*n)))/Math.PI},POS.Pose=function(e,t,a,i,o,s){this.bestError=e,this.bestRotation=t,this.bestTranslation=a,this.alternativeError=i,this.alternativeRotation=o,this.alternativeTranslation=s};var Vec3=function(e,t,a){this.v=[e||0,t||0,a||0]};Vec3.prototype.copy=function(e){var t=this.v;return e=e.v,t[0]=e[0],t[1]=e[1],t[2]=e[2],this},Vec3.add=function(e,t){var a=new Vec3,i=a.v;return e=e.v,t=t.v,i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],a},Vec3.sub=function(e,t){var a=new Vec3,i=a.v;return e=e.v,t=t.v,i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a},Vec3.mult=function(e,t){var a=new Vec3,i=a.v;return e=e.v,t=t.v,i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],a},Vec3.addScalar=function(e,t){var a=new Vec3,i=a.v;return e=e.v,i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,a},Vec3.multScalar=function(e,t){var a=new Vec3,i=a.v;return e=e.v,i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,a},Vec3.dot=function(e,t){return e=e.v,t=t.v,e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},Vec3.cross=function(e,t){return e=e.v,t=t.v,new Vec3(e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0])},Vec3.prototype.normalize=function(){var e=this.v,t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t>0&&(e[0]/=t,e[1]/=t,e[2]/=t),t},Vec3.inverse=function(e){var t=new Vec3,a=t.v;return 0!==(e=e.v)[0]&&(a[0]=1/e[0]),0!==e[1]&&(a[1]=1/e[1]),0!==e[2]&&(a[2]=1/e[2]),t},Vec3.prototype.square=function(){var e=this.v;return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},Vec3.prototype.minIndex=function(){var e=this.v;return e[0]<e[1]?e[0]<e[2]?0:2:e[1]<e[2]?1:2};var Mat3=function(){this.m=[[0,0,0],[0,0,0],[0,0,0]]};Mat3.clone=function(e){var t=new Mat3,a=t.m;return e=e.m,a[0][0]=e[0][0],a[0][1]=e[0][1],a[0][2]=e[0][2],a[1][0]=e[1][0],a[1][1]=e[1][1],a[1][2]=e[1][2],a[2][0]=e[2][0],a[2][1]=e[2][1],a[2][2]=e[2][2],t},Mat3.prototype.copy=function(e){var t=this.m;return e=e.m,t[0][0]=e[0][0],t[0][1]=e[0][1],t[0][2]=e[0][2],t[1][0]=e[1][0],t[1][1]=e[1][1],t[1][2]=e[1][2],t[2][0]=e[2][0],t[2][1]=e[2][1],t[2][2]=e[2][2],this},Mat3.fromRows=function(e,t,a){var i=new Mat3,o=i.m;return e=e.v,t=t.v,a=a.v,o[0][0]=e[0],o[0][1]=e[1],o[0][2]=e[2],o[1][0]=t[0],o[1][1]=t[1],o[1][2]=t[2],o[2][0]=a[0],o[2][1]=a[1],o[2][2]=a[2],i},Mat3.fromDiagonal=function(e){var t=new Mat3,a=t.m;return e=e.v,a[0][0]=e[0],a[1][1]=e[1],a[2][2]=e[2],t},Mat3.transpose=function(e){var t=new Mat3,a=t.m;return e=e.m,a[0][0]=e[0][0],a[0][1]=e[1][0],a[0][2]=e[2][0],a[1][0]=e[0][1],a[1][1]=e[1][1],a[1][2]=e[2][1],a[2][0]=e[0][2],a[2][1]=e[1][2],a[2][2]=e[2][2],t},Mat3.mult=function(e,t){var a=new Mat3,i=a.m;return e=e.m,t=t.m,i[0][0]=e[0][0]*t[0][0]+e[0][1]*t[1][0]+e[0][2]*t[2][0],i[0][1]=e[0][0]*t[0][1]+e[0][1]*t[1][1]+e[0][2]*t[2][1],i[0][2]=e[0][0]*t[0][2]+e[0][1]*t[1][2]+e[0][2]*t[2][2],i[1][0]=e[1][0]*t[0][0]+e[1][1]*t[1][0]+e[1][2]*t[2][0],i[1][1]=e[1][0]*t[0][1]+e[1][1]*t[1][1]+e[1][2]*t[2][1],i[1][2]=e[1][0]*t[0][2]+e[1][1]*t[1][2]+e[1][2]*t[2][2],i[2][0]=e[2][0]*t[0][0]+e[2][1]*t[1][0]+e[2][2]*t[2][0],i[2][1]=e[2][0]*t[0][1]+e[2][1]*t[1][1]+e[2][2]*t[2][1],i[2][2]=e[2][0]*t[0][2]+e[2][1]*t[1][2]+e[2][2]*t[2][2],a},Mat3.multVector=function(e,t){return e=e.m,t=t.v,new Vec3(e[0][0]*t[0]+e[0][1]*t[1]+e[0][2]*t[2],e[1][0]*t[0]+e[1][1]*t[1]+e[1][2]*t[2],e[2][0]*t[0]+e[2][1]*t[1]+e[2][2]*t[2])},Mat3.prototype.column=function(e){var t=this.m;return new Vec3(t[0][e],t[1][e],t[2][e])},Mat3.prototype.row=function(e){var t=this.m;return new Vec3(t[e][0],t[e][1],t[e][2])};var _video=null,_streamSize=null,_dataColorHeap=null,_dataGrayHeap=null,AREA_SIZE=530,AREA_SIZE_X=AREA_SIZE,AREA_SIZE_Y=AREA_SIZE,AREA_SIZE_LENGHT=AREA_SIZE_X*AREA_SIZE_Y,_useImage=!1,_imageIsVideo=!1,_training=null,_nft=null,_blurSize=1,_blurType=2,_showPoints=!1,_showSearchArea=!1,_domLog=$("#mainLog"),_streamW=0,_streamH=0,_canvas=document.getElementById("threejs"),_arScene=(_video=null,null),getArguments=function(){return arguments},_arguments=getArguments(),_isDesktop=is.desktop(_arguments),_isIOS=/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;_isIOS&&(_isDesktop=!1),_isDesktop&&(_clickOrTouch="click"),addToLog("_isDesktop "+_isDesktop),console.log(_browser);var _mainData=null,_isBundle=!1,_xr=null,_checks=null,_body=document.body,_needDeviceOrientationPermission=!1,_flow=null;_body.addEventListener("gesturechange",gestureChange,!1),_body.addEventListener("touchmove",gestureChange,!1),"undefined"!=typeof _isDebug||(_isDebug=!1);var _visitUrl=document.location.href;try{_visitUrl=window.location!=window.parent.location?document.referrer:document.location.href}catch(e){console.error("catch visiturl")}var fbp=_visitUrl.indexOf("?fbclid=");-1!=fbp&&(_visitUrl=_visitUrl.substring(0,fbp)),this.openCurtains=function(){var e=document.createElement("div");e.id="curtains",_body.appendChild(e);var t=document.createElement("div");e.appendChild(t);var a=document.createElement("div");a.classList.add("brandingBg"),a.id="curtainL";var i=document.createElement("div");i.classList.add("brandingBg"),i.id="curtainR",t.appendChild(a),t.appendChild(i),setTimeout(function(){e&&e.parentElement.removeChild(e)},1e3)},$("#b_marker").on(_clickOrTouch,function(){var e=_xr.activeScene.data,t=_rootDirectory+_folder+"assets/help.jpg",a=!1;console.log("open help for scene "+_xr.activeScene.index),e.settings&&e.settings.help&&e.settings.helpcustomImage&&(console.log("OBS: custom help"),a=!0,t=_rootDirectory+"s/"+e.folder+"/"+e.url+"/"+e.settings.helpcustomImage),e.branding&&e.branding.help&&e.branding.help.image&&(a=!0,t=_rootDirectory+"s/"+e.folder+"/"+e.url+"/"+e.branding.help.image),_isBundle&&_mainData.branding&&_mainData.branding.help&&_mainData.branding.help.image&&(a=!0,t=_rootDirectory+"s/"+_mainData.folder+"/"+_mainData.url+"/"+_mainData.branding.help.image),$("#help img.help").css("display:none;"),document.querySelector("#help img.help").onload=function(){$("#help img.help").css("display:block;"),addToLog("help loaded")},a?$("#help").addClass("customHelp"):$("#help").removeClass("customHelp"),$("#help img.help").attr("src",t),$("#help").css("display:block;")}),$("#b_share").on("click",function(){shareScene()}),$("#b_close_help").on("click",function(){$("#more, #help").css("display:none;")}),$("#b_close_patternLarge").on("click",function(){$("#patternLarge").css("display:none;")}),$("#b_close_more").on("click",function(){$("#more, #help").css("display:none;")}),$("#b_close_redirection").on("click",function(){$("#more, #help, #redirection").css("display:none;")}),$("#h").on(_clickOrTouch,function(){_xr.setOrientation(!1)}),$("#v").on(_clickOrTouch,function(){_xr.setOrientation(!0)}),document.getElementById("mainLog")&&$("#mainLog").on(_clickOrTouch,function(){$("#mainLog").css("display:none;"),$("#bgVideo").css("opacity:0;")}),startAny();